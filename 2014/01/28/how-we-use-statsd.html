<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.4.0
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode-->
    
    <script>
        const isAutoTheme = true;
        document.documentElement.setAttribute('data-theme', sessionStorage.getItem('theme'))
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon">

    

    <!-- KaTeX 0.15.2 -->
    
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    <!-- Mermaid 8.13.10 -->
    
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({startOnLoad:true});"></script>
    

    <!-- Simple Jekyll Search 1.9.1 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-https://tech.bedrockstreaming.com';
      const isCookieConsent = 'false';
      const analyticsName = '';
    </script>

    
    

    <!-- seo tags -->
    <meta property="og:image" content="https://tech.bedrockstreaming.com/images/posts/statsd/header_pourri.jpg">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>How we use StatsD | Bedrock Tech Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="How we use StatsD" />
<meta name="author" content="Olivier Mansour" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How we use statsd to monitor our applications" />
<meta property="og:description" content="How we use statsd to monitor our applications" />
<link rel="canonical" href="https://tech.bedrockstreaming.com/2014/01/28/how-we-use-statsd.html" />
<meta property="og:url" content="https://tech.bedrockstreaming.com/2014/01/28/how-we-use-statsd.html" />
<meta property="og:site_name" content="Bedrock Tech Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-01-28T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="How we use StatsD" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://tech.bedrockstreaming.com/2014/01/28/how-we-use-statsd.html"},"url":"https://tech.bedrockstreaming.com/2014/01/28/how-we-use-statsd.html","author":{"@type":"Person","name":"Olivier Mansour"},"@type":"BlogPosting","headline":"How we use StatsD","dateModified":"2014-01-28T00:00:00+00:00","datePublished":"2014-01-28T00:00:00+00:00","description":"How we use statsd to monitor our applications","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Bedrock Tech Blog" href="https://tech.bedrockstreaming.com/feed.xml"/>
    <link type="application/atom+xml" rel="alternate" href="https://tech.bedrockstreaming.com/feed.xml" title="Bedrock Tech Blog" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="How we use StatsD">
    <meta name="twitter:description" content="What we wantAs developers, we (M6Web) want to keep our eyes open on what is going on in production.Our local CMO (chief monitoring officier ;) ) did a nice p...">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://tech.bedrockstreaming.com/images/posts/statsd/header_pourri.jpg">
    <meta name="twitter:image:alt" content="How we use StatsD">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/images/br-site-logo.jpg" />
		</a>
        
        <a class="site-title" aria-label="Bedrock Tech Blog" href="/">
        Bedrock Tech Blog
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="About" title="About" href="/about/">
                     About 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Jobs" title="Jobs" href="/jobs/">
                     Jobs 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Last Friday Talks" title="Last Friday Talks" href="/lft/">
                     Last Friday Talks 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Meetups & Conferences" title="Meetups & Conferences" href="/meetups/">
                     Meetups & Conferences 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="OSS" title="OSS" href="/oss/">
                     OSS 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
        <li class="separator"> | </li>
        <li><a id="theme-toggle" title="How we use StatsD " aria-label="How we use StatsD" onclick="themeToggle()"></a></li>
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="How+we+use+StatsD" class="title">How we use StatsD</h1>
      


<div class="post-info"><a href="https://twitter.com/omansour" target="_blank" rel="noopener">
      <img alt="Author's avatar" src="/images/avatar/oliviermansour.jpg">
    
    <p class="meta">
      Olivier Mansour - 
      
      January 28, 2014
    </p></a></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <h1 id="what-we-want">What we want</h1>

<p>As developers, we (M6Web) want to keep our eyes open on what is going on in production.</p>

<p>Our <a href="https://twitter.com/kenny_dee">local CMO</a> (chief monitoring officier ;) ) did a <a href="/monitoring-applicatif-pourquoi-et-comment">nice presentation about this</a> (in french).</p>

<p>As someone very wise (Theo Schlossnagle) said: “<em>It’s not in production unless it’s monitored</em>”. Another cool mantra is: “<em>I am wondering what to monitor ? everything dude !</em>”. Finally “<em>if you can not measure it, you can not improve it.</em>” (<a href="https://en.wikipedia.org/wiki/William_Thomson,_1st_Baron_Kelvin">Lord Kelvin</a>).</p>

<p>We ship new apps very often, so we have to industrialise this practice.</p>

<h1 id="what-is-it">What is it?</h1>

<p>StatsD is a Node.Js daemon allowing you to send metrics (increment values and timers) over UDP. The fire and forget feature of UDP is great for reducing risks of introducing latency or crashes in your application.</p>

<p>StatsD is <a href="https://github.com/etsy/statsd/">open sourced by etsy</a>. In our configuration, we use several StatsD deamons and aggregate metrics on Graphite - one point per minute. Many servers allows us to scale, because we don’t sample the data at all.</p>

<p>On client side, we use a simple consistent hashing algorithm to dispatch metrics overs StatsD nodes on the same server.</p>

<h1 id="collecting-metrics">Collecting metrics</h1>

<h2 id="from-raw-php">From raw PHP</h2>

<p>We’ve created a simple PHP lib to dispatch metrics over UDP. Check it out on <a href="https://github.com/BedrockStreaming/Statsd">Github</a> or <a href="https://packagist.org/packages/m6web/statsd">Packagist</a>.</p>

<p>The usage is pretty straightforward :</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// client creation</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Statsd\Client</span><span class="p">(</span>
                    <span class="k">array</span><span class="p">(</span>
                        <span class="s1">'serv1'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'address'</span> <span class="o">=&gt;</span> <span class="s1">'udp://200.22.143.12'</span><span class="p">),</span>
                        <span class="s1">'serv2'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'port'</span> <span class="o">=&gt;</span> <span class="mi">8125</span><span class="p">,</span> <span class="s1">'address'</span> <span class="o">=&gt;</span> <span class="s1">'udp://200.22.143.12'</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">);</span>
<span class="c1">// usage</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">increment</span><span class="p">(</span><span class="s1">'a.graphite.node'</span><span class="p">);</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">timing</span><span class="p">(</span><span class="s1">'another.graphite.node'</span><span class="p">,</span> <span class="p">(</span><span class="n">float</span><span class="p">)</span> <span class="nv">$timing</span><span class="p">);</span></code></pre></figure>

<h2 id="from-symfony2">From Symfony2</h2>

<p>As basic Symfony2 fanboys, we’ve built a <a href="https://github.com/BedrockStreaming/StatsdBundle">bundle</a> on top of the StatsD component.
It provides these features:</p>

<ul>
  <li>manage multiple Symfony services with different configurations</li>
  <li>bind any event to increment nodes and collect timers</li>
</ul>

<p>During Symfony 2 execution, metrics are collected and sent only at the kernel shutdown. A nice feature is that you can <a href="https://github.com/BedrockStreaming/StatsdBundle/blob/master/doc/usage.md#bind-on-events">easily collect basic metrics based on events</a> without touching your code.</p>

<p>For example, in conjunction with the <a href="https://github.com/BedrockStreaming/HttpKernelBundle">M6Web\HttpKernelBundle</a>, just dropping this in <code class="language-plaintext highlighter-rouge">config.yml</code> is enough:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">m6_statsd</span><span class="pi">:</span>
    <span class="na">clients</span><span class="pi">:</span>
        <span class="na">default</span><span class="pi">:</span>
            <span class="na">servers</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">all'</span><span class="pi">]</span>
            <span class="na">events</span><span class="pi">:</span>
              <span class="na">m6.terminate</span><span class="pi">:</span>
                <span class="na">increment</span><span class="pi">:</span>     <span class="s">request.yourapp.&lt;status_code&gt;.&lt;route_name&gt;</span>
                <span class="na">timing</span><span class="pi">:</span>        <span class="s">request.yourapp.&lt;status_code&gt;.&lt;route_name&gt;</span>
                <span class="na">custom_timing</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">node</span><span class="pi">:</span> <span class="nv">memory.yourapp.&lt;status_code&gt;.&lt;route_name&gt;</span><span class="pi">,</span> <span class="nv">method</span><span class="pi">:</span> <span class="nv">getMemory</span> <span class="pi">}</span>
              <span class="na">m6kernel.exception</span><span class="pi">:</span>
                <span class="na">increment</span><span class="pi">:</span> <span class="s">errors.&lt;status_code&gt;.yourapp</span></code></pre></figure>

<p><img src="/images/posts/statsd/php_metrics.jpg" alt="example of simple PHP dashboard" /></p>

<p>Offering this to the tech team means that I am now pretty sure that almost all new PHP apps pop with those metrics out of the box.</p>

<p>Please checkout <a href="https://github.com/BedrockStreaming/StatsdBundle/blob/master/doc/toc.md">the bundle documentation on github</a>.</p>

<h2 id="from-anywhere-else">From anywhere else</h2>

<p>From Flex, mobile app or JS applications we’ve developed a simple <a href="https://github.com/BedrockStreaming/HttpToStatsd">Node.js app, translating an HTTP call to a StatsD UDP one</a>. Like the PHP implementation, this application shards the metrics over multiple servers.</p>

<p>Please consider sending metrics asynchronously and add a timeout to this HTTP call.</p>

<h1 id="living-with-metrics">Living with metrics</h1>

<p>About 120K metrics are collected on our platform. That’s a lot.</p>

<p>Graphite dashboards are quite rustic. But surprisingly lots of non-techs people use this tool: SEO experts, advertising managers, contributors, …</p>

<p><img src="/images/posts/statsd/crawl.png" alt="SEO" /></p>

<p><img src="/images/posts/statsd/dash_video.png" alt="video" /></p>

<p>For now we keep using Graphite. We try to keep our dashboards organised and well named.</p>

<p>For alerting purpose, <a href="/images/posts/statsd/mayday.jpg">a tool based on Graphite JSON output has been developed</a>. It sends emails when it reaches some user defined conditions. Honestly, it does the job, but frankly we are still looking for something else, more flexible with more notification systems than emails.</p>

<p>If you use such a tool, and you’re happy with it, please let us know in the comments.</p>

<p>Found a typo or bad english langage, just propose a <a href="https://github.com/BedrockStreaming/tech.bedrockstreaming.com/blob/master/_posts/2014-01-28-how-we-use-statsd.md">pull request</a>.</p>

    
  </section>

  <!-- Social media shares -->
  

<div class="share-buttons">
    <ul class="share-buttons">
        <li class="meta">Share</li>
         
        <li>
            <a href="https://twitter.com/intent/tweet?text=How+we+use+StatsD%20https%3A%2F%2Ftech.bedrockstreaming.com%2F2014%2F01%2F28%2Fhow-we-use-statsd.html"
               target="_blank" title="">
                <i class="fab fa-twitter-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Tweet</span>
            </a>
        </li>
             
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://tech.bedrockstreaming.com/2014/01/28/how-we-use-statsd.html&title=How+we+use+StatsD%20%7C%20Bedrock+Tech+Blog&summary=&source=https://tech.bedrockstreaming.com/2014/01/28/how-we-use-statsd.html"
               target="_blank" title=" LinkedIn">
                <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on LinkedIn</span>
            </a>
        </li>
          
        <li>
            <a href="mailto:?subject=How we use StatsD%20%7C%20Bedrock Tech Blog&body=https://tech.bedrockstreaming.com/2014/01/28/how-we-use-statsd.html"
               target="_blank" title="">
                <i class="fas fa-envelope-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Email</span></a>
        </li>
        
    </ul>
</div>




   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags/#graphite">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> graphite</p>
        </a></li>
      
        <li><a class="button" href="/tags/#monitoring">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> monitoring</p>
        </a></li>
      
        <li><a class="button" href="/tags/#nodejs">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> nodejs</p>
        </a></li>
      
        <li><a class="button" href="/tags/#php">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> php</p>
        </a></li>
      
        <li><a class="button" href="/tags/#statsd">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> statsd</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <div id="previous-post">
        <a alt="Refonte de notre système de vote" href="/2014/02/18/refonte-de-notre-systeme-de-vote.html">
            <p>Previous post</p>
            Refonte de notre système de vote
        </a>
    </div>
    

    
    <div id="next-post">
        <a alt="M6Web Dev Facts #6" href="/2014/01/20/m6web-dev-facts-6.html">
            <p>Next post</p>
            M6Web Dev Facts #6
        </a>
    </div>
    
</div>



<!--Utterances-->


<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }

  

  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                
<li>
    <a feed.xml href="/feed.xml"
       title="Follow RSS feed"
       target="_blank">
        <span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>



    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/BedrockStreaming"
               title="Follow on Github"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://www.linkedin.com/company/bedrock-streaming"
               title="Follow on Linkedin"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://twitter.com/Bedrock_Tech"
               title="Follow on Twitter"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    


                </ul>
            </div>
</footer>



  </body>
</html>
