<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.4.0
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode-->
    
    <script>
        const isAutoTheme = true;
        document.documentElement.setAttribute('data-theme', sessionStorage.getItem('theme'))
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon">

    

    <!-- KaTeX 0.15.2 -->
    
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    <!-- Mermaid 8.13.10 -->
    
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({startOnLoad:true});"></script>
    

    <!-- Simple Jekyll Search 1.9.1 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-https://tech.bedrockstreaming.com';
      const isCookieConsent = 'false';
      const analyticsName = '';
    </script>

    
    

    <!-- seo tags -->
    <meta property="og:image" content="https://tech.bedrockstreaming.com/images/posts/6play/logo.jpg">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>L’envers du décor du nouveau 6play | Bedrock Tech Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="L’envers du décor du nouveau 6play" />
<meta name="author" content="Bedrock" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Présentation du backend derrière les nouvelles applications 6play" />
<meta property="og:description" content="Présentation du backend derrière les nouvelles applications 6play" />
<link rel="canonical" href="https://tech.bedrockstreaming.com/2015/11/30/beta-nouveau-6play-backend.html" />
<meta property="og:url" content="https://tech.bedrockstreaming.com/2015/11/30/beta-nouveau-6play-backend.html" />
<meta property="og:site_name" content="Bedrock Tech Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-11-30T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="L’envers du décor du nouveau 6play" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://tech.bedrockstreaming.com/2015/11/30/beta-nouveau-6play-backend.html"},"url":"https://tech.bedrockstreaming.com/2015/11/30/beta-nouveau-6play-backend.html","author":{"@type":"Person","name":"Bedrock"},"@type":"BlogPosting","headline":"L’envers du décor du nouveau 6play","dateModified":"2015-11-30T00:00:00+00:00","datePublished":"2015-11-30T00:00:00+00:00","description":"Présentation du backend derrière les nouvelles applications 6play","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Bedrock Tech Blog" href="https://tech.bedrockstreaming.com/feed.xml"/>
    <link type="application/atom+xml" rel="alternate" href="https://tech.bedrockstreaming.com/feed.xml" title="Bedrock Tech Blog" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="L'envers du décor du nouveau 6play">
    <meta name="twitter:description" content="Il y a quelques semaines, nous vous parlions ici même de la stack technique mise en place pour le nouveau front web de 6play.Aujourd’hui, nous vous proposons...">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://tech.bedrockstreaming.com/images/posts/6play/logo.jpg">
    <meta name="twitter:image:alt" content="L'envers du décor du nouveau 6play">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/images/br-site-logo.jpg" />
		</a>
        
        <a class="site-title" aria-label="Bedrock Tech Blog" href="/">
        Bedrock Tech Blog
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="About" title="About" href="/about/">
                     About 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Jobs" title="Jobs" href="/jobs/">
                     Jobs 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Last Friday Talks" title="Last Friday Talks" href="/lft/">
                     Last Friday Talks 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Meetups & Conferences" title="Meetups & Conferences" href="/meetups/">
                     Meetups & Conferences 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="OSS" title="OSS" href="/oss/">
                     OSS 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
        <li class="separator"> | </li>
        <li><a id="theme-toggle" title="L'envers du décor du nouveau 6play " aria-label="L'envers du décor du nouveau 6play" onclick="themeToggle()"></a></li>
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="L%27envers+du+d%C3%A9cor+du+nouveau+6play" class="title">L'envers du décor du nouveau 6play</h1>
      


<div class="post-info">
    <p class="meta">
      Bedrock - 
      
      November 30, 2015
    </p></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <p>Il y a quelques semaines, nous vous parlions ici même de la <a href="/beta-nouveau-6play-react-isomorphic/">stack technique mise en place pour le nouveau front web de 6play</a>.</p>

<p>Aujourd’hui, nous vous proposons un retour sur ce qui a été mis en place côté backend pour assurer la mise à disposition des données aux différents frontaux 6play.</p>

<p>Tout d’abord, il faut commencer par expliquer que l’univers 6play ne se résume pas que à son application web. Il existe aussi une version iOS et Android, mais également une version par Box IPTV (disons une version par FAI).</p>

<h1 id="pas-mal-de-rest-">Pas mal de REST …</h1>

<p>C’est donc tout naturellement que nous sommes partis sur la mise à disposition d’une API <a href="https://fr.wikipedia.org/wiki/Representational_State_Transfer">REST</a> permettant à ces différents fronts de consommer simplement les données.</p>

<p>Notre stack technique habituelle côté backend étant Symfony2, nous sommes donc partis sur ce framework, ainsi que les habituels bundles :</p>

<ul>
  <li><a href="https://github.com/FriendsOfSymfony/FOSRestBundle">FOSRestBundle</a> pour la gestion simple des controlleurs REST (validation des paramètres, routing adapté, view au format JSON, gestion des retours d’erreur)</li>
  <li><a href="https://github.com/willdurand/BazingaHateoasBundle">BazingaHateoasBundle</a> pour intégrer les liens entres les différents endpoints directement dans les différentes réponses.</li>
  <li><a href="https://github.com/nelmio/NelmioApiDocBundle">NelmioApiDocBundle</a> pour proposer une documentation complète et auto-générée depuis le code</li>
</ul>

<p>Pour sécuriser tout ça, nous utilisons toujours notre bundle <a href="https://github.com/BedrockStreaming/DomainUserBundle">DomainUserBundle</a> permettant de sécuriser et contextualiser les données par sous-domaine (voir notre <a href="/api-a-consommer-avec-moderation/">article dédié</a> à ce bundle).</p>

<h1 id="-mais-pas-que">… mais pas que</h1>

<p>Une fois mise en place la théorie brute, nous nous sommes heurtés à la réalité des choses : face à un modèle de données complexe, si on reste très strict face à la philosophie RESTful, cela peux demander aux clients de réaliser un nombre conséquent de requêtes afin d’afficher une simple page.</p>

<p>Ainsi, nous avons un second applicatif, que nous nommons “middleware” qui est un hybride entre une API REST et un catalogue de données préformaté. Dans cet applicatif, nous réalisons les agrégations qui permettent de récupérer de manière unifiée les données liées, permettant aux frontaux de réduire leurs appels.</p>

<p>Dans ce middleware, nous essayons tout de même de respecter au maximum les verbes HTTP et le format de retour pour que les utilisateurs de ces API obtiennent des réponses cohérentes d’un service sur l’autre.</p>

<h1 id="des-données-élastiques">Des données élastiques</h1>

<p>Pour que ce middleware puisse retourner des données qui sont stockées dans plusieurs tables, de manière rapide, tout en gérant les contraintes de données non publiées (notre SI contient les anciennes émissions diffusées, mais également celles à diffuser), nous avons fait le choix d’utiliser <a href="https://www.elastic.co/fr/">Elasticsearch</a> en le remplissant avec les données “publiables”.</p>

<p>Non seulement nous disposons d’un système de recherche de données très performant, permettant des requêtes très puissantes et très rapides, dans lequel les données sont stockées de manière optimisée pour l’utilisation (pas de forme normale à respecter), mais nous nous permettons de n’y stocker que les données disponibles publiquement, simplifiant donc grandement les requêtes sur ces données.</p>

<h1 id="workerize-all-the-things">Workerize all the things</h1>

<p>Pour maintenir les données à jour dans cet index Elasticsearch, nous avons mutualisé sur l’expérience et le travail que nous avions réalisé pour RisingStar, qui nous a apporté l’expérience que des daemons sont beaucoup plus efficaces que des crons. Cette technique nous apporte plusieurs avantages :</p>

<ul>
  <li><strong>Scalabilité</strong> : il est facilement possible de multiplier les process qui traitent les données, et donc d’augmenter la capacité de traitement</li>
  <li><strong>Rapidité</strong> : le fait d’avoir des daemons qui tournent en continue permet de traiter les demandes dès leur arrivée, et pas lors de la minute suivante. Cela permet aussi de lisser au maximum les traitements sans créer de piles d’attente inutiles.</li>
</ul>

<p>Nous nous sommes donc appuyés sur notre <a href="https://github.com/BedrockStreaming/DaemonBundle">DaemonBundle</a> pour mettre en place un double système d’indexation :</p>

<ul>
  <li>une fois par jour, l’index est complétement reconstruit</li>
  <li>un daemon tourne en continue pour détecter les modifications en base de données, et envoyer des messages dans une file <a href="https://www.rabbitmq.com/">RabbitMQ</a></li>
  <li>un dernier daemon est dédié au traitement des messages de cette file pour mettre à jour de manière ciblée les données dans Elasticsearch</li>
</ul>

<p>Ainsi, nous assurons une fraicheur des données quasi-immédiate et optimale.</p>

<p>Au cours de ce travail, nous avons construit 2 nouveaux bundle : <a href="https://github.com/BedrockStreaming/ElasticsearchBundle">ElasticsearchBundle</a> et <a href="https://github.com/BedrockStreaming/AmqpBundle">AmqpBundle</a>. L’un comme l’autre sont des bundles permettant de faciliter la configuration et l’utilisation des clients natifs dans Symfony2, en tant que service.</p>

<h1 id="et-la-grosse-donnée-">Et la grosse donnée ?</h1>

<p>Si vous avez essayé la nouvelle version web de 6play, vous avez certainement remarqué que la personnalisation de votre compte est fortement mise en avant. Pour stocker ce fort volume de données, nous avons fait le choix d’utiliser <a href="https://cassandra.apache.org/">Cassandra</a>, pour son approche distribuée permettant une forte scalabilité, et un ratio rapidité/redondance optimal.</p>

<p>Comme pour le reste, nous avons là aussi créé un bundle Symfony2 permettant de configurer et manipuler simplement des clients Cassandra en tant que service : <a href="https://github.com/BedrockStreaming/CassandraBundle">CassandraBundle</a></p>

<h1 id="tout-le-reste">Tout le reste</h1>

<p>Côté monitoring, pour respecter nos bonnes habitudes, <a href="/2014/01/28/how-we-use-statsd">nous utilisons toujours Statsd à outrance</a>, surtout via notre bundle <a href="https://github.com/BedrockStreaming/StatsdBundle">StatsdBundle</a>.</p>

<p>Côté tests, tous les tests unitaires ont été écrits avec <a href="https://github.com/atoum/atoum">atoum</a>.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Au cours de ce projet, nous avons eu l’occasion de transformer l’essai de beaucoup de choses que nous avions faites pour RisingStar, de découvrir de nouvelles technos et de mettre en place une architecture moderne et adaptée aux nouveaux challenges des fronts.</p>

    
  </section>

  <!-- Social media shares -->
  

<div class="share-buttons">
    <ul class="share-buttons">
        <li class="meta">Share</li>
         
        <li>
            <a href="https://twitter.com/intent/tweet?text=L%27envers+du+d%C3%A9cor+du+nouveau+6play%20https%3A%2F%2Ftech.bedrockstreaming.com%2F2015%2F11%2F30%2Fbeta-nouveau-6play-backend.html"
               target="_blank" title="">
                <i class="fab fa-twitter-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Tweet</span>
            </a>
        </li>
             
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://tech.bedrockstreaming.com/2015/11/30/beta-nouveau-6play-backend.html&title=L%27envers+du+d%C3%A9cor+du+nouveau+6play%20%7C%20Bedrock+Tech+Blog&summary=&source=https://tech.bedrockstreaming.com/2015/11/30/beta-nouveau-6play-backend.html"
               target="_blank" title=" LinkedIn">
                <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on LinkedIn</span>
            </a>
        </li>
          
        <li>
            <a href="mailto:?subject=L'envers du décor du nouveau 6play%20%7C%20Bedrock Tech Blog&body=https://tech.bedrockstreaming.com/2015/11/30/beta-nouveau-6play-backend.html"
               target="_blank" title="">
                <i class="fas fa-envelope-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Email</span></a>
        </li>
        
    </ul>
</div>




   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags/#6play">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> 6play</p>
        </a></li>
      
        <li><a class="button" href="/tags/#Cassandra">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Cassandra</p>
        </a></li>
      
        <li><a class="button" href="/tags/#Elasticsearch">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Elasticsearch</p>
        </a></li>
      
        <li><a class="button" href="/tags/#REST">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> REST</p>
        </a></li>
      
        <li><a class="button" href="/tags/#Symfony">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Symfony</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <div id="previous-post">
        <a alt="On a testé fonctionnellement notre app JS" href="/2016/01/25/tests-fonctionnels-app-js.html">
            <p>Previous post</p>
            On a testé fonctionnellement notre app JS
        </a>
    </div>
    

    
    <div id="next-post">
        <a alt="M6Web Dev Facts #9" href="/2015/11/06/m6web-dev-facts-9.html">
            <p>Next post</p>
            M6Web Dev Facts #9
        </a>
    </div>
    
</div>



<!--Utterances-->


<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }

  

  
  header#main { background-image: url('/images/posts/6play/logo.jpg'); }
  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                
<li>
    <a feed.xml href="/feed.xml"
       title="Follow RSS feed"
       target="_blank">
        <span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>



    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/BedrockStreaming"
               title="Follow on Github"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://www.linkedin.com/company/bedrock-streaming"
               title="Follow on Linkedin"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://twitter.com/Bedrock_Tech"
               title="Follow on Twitter"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    


                </ul>
            </div>
</footer>



  </body>
</html>
