<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.4.0
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    
    <!-- Theme Mode -->
    <script>
        const isAutoTheme = true;
        document.documentElement.setAttribute('data-theme', sessionStorage.getItem('theme'))
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon">

    

    
    <!-- KaTeX 0.15.2 -->
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    
    <!-- Mermaid 8.13.10 -->
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({startOnLoad:true});"></script>
    

    <!-- Simple Jekyll Search 1.9.1 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    
    <!-- Matomo -->
    <script>
        var _paq = window._paq = window._paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
            var u="https://bedrockstreaming.matomo.cloud/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
            _paq.push(['setSiteId', '2']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src='//cdn.matomo.cloud/bedrockstreaming.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>
    

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-https://tech.bedrockstreaming.com';
      const isCookieConsent = 'false';
      const analyticsName = '';
    </script>

    
    

    <!-- SEO tags -->
    <meta property="og:image" content="https://tech.bedrockstreaming.com/images/posts/migration-es/migration.jpg">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Elasticsearch: la grande migration | Bedrock Tech Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Elasticsearch: la grande migration" />
<meta name="author" content="Benoit Viguier" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Migration de Elasticsearch 1.7 à 5.2 sans interruption de service" />
<meta property="og:description" content="Migration de Elasticsearch 1.7 à 5.2 sans interruption de service" />
<link rel="canonical" href="https://tech.bedrockstreaming.com/2017/06/01/migration-elasticsearch.html" />
<meta property="og:url" content="https://tech.bedrockstreaming.com/2017/06/01/migration-elasticsearch.html" />
<meta property="og:site_name" content="Bedrock Tech Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-06-01T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Elasticsearch: la grande migration" />
<script type="application/ld+json">
{"description":"Migration de Elasticsearch 1.7 à 5.2 sans interruption de service","headline":"Elasticsearch: la grande migration","dateModified":"2017-06-01T00:00:00+00:00","datePublished":"2017-06-01T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tech.bedrockstreaming.com/2017/06/01/migration-elasticsearch.html"},"url":"https://tech.bedrockstreaming.com/2017/06/01/migration-elasticsearch.html","author":{"@type":"Person","name":"Benoit Viguier"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Bedrock Tech Blog" href="https://tech.bedrockstreaming.com/feed.xml"/>
    <link type="application/atom+xml" rel="alternate" href="https://tech.bedrockstreaming.com/feed.xml" title="Bedrock Tech Blog" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="Elasticsearch: la grande migration">
    <meta name="twitter:description" content="Pour assurer la scalabilité des performances de l’API 6play, les données suivent tout un workflow pour être dénormalisées et stockées dans Elasticsearch.Mi-2...">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://tech.bedrockstreaming.com/images/posts/migration-es/migration.jpg">
    <meta name="twitter:image:alt" content="Elasticsearch: la grande migration">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/images/br-site-logo.jpg" />
		</a>
        
        <a class="site-title" aria-label="Bedrock Tech Blog" href="/">
        Bedrock Tech Blog
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Jobs" title="Jobs" href="/jobs/">
                     Jobs 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Last Friday Talks" title="Last Friday Talks" href="/lft/">
                     Last Friday Talks 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Meetups & Conferences" title="Meetups & Conferences" href="/meetups/">
                     Meetups & Conferences 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="OSS" title="OSS" href="/oss/">
                     OSS 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
        <li class="separator"> | </li>
        <li><a id="theme-toggle" title="Elasticsearch: la grande migration " aria-label="Elasticsearch: la grande migration" onclick="themeToggle()"></a></li>
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="Elasticsearch%3A+la+grande+migration" class="title">Elasticsearch: la grande migration</h1>
      <div class="post-info">

  <p class="meta">
    
    December 
  </p>
</div>



      
    </div>
  </header>

  <section class="post-content">
  
      <p>Pour assurer la scalabilité des performances de l’API 6play, les données suivent tout <a href="/2016/11/24/une-donnee-presque-parfaite">un <em>workflow</em></a> pour être dénormalisées et stockées dans <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a>.
Mi-2016, nous avons identifié des dysfonctionnements majeurs sur nos serveurs, entrainant parfois des interruptions de service.
Suite à quelques mesures d’urgences pour stabiliser l’existant, nous avons entrepris de mettre à jour notre version d’Elasticsearch pour bénéficier des dernières améliorations.
Nous étions alors sur la <a href="https://www.elastic.co/downloads/past-releases/elasticsearch-1-7-0">version 1.7</a>, et souhaitions passer en <a href="https://www.elastic.co/downloads/past-releases/elasticsearch-2-0-0">version 2.0</a>.
Après plusieurs mois d’efforts pour effectuer cette migration sans interruption de service ni gel technique, nous voici en version… <a href="https://www.elastic.co/downloads/past-releases/elasticsearch-5-2-2">5.2</a>!
Voici le récit de cette grande migration, et ce que l’on a appris tout au long de ce périple.</p>

<p><img src="/images/posts/migration-es/ES5-covfefe.jpg" alt="ES5 Covfefe" /></p>

<h2 id="la-théorie">La théorie</h2>

<p>Il n’y a pas de méthode magique pour changer de cluster sans coupure, la stratégie adoptée est assez classique:</p>

<ul>
  <li>dupliquer les écritures sur le nouveau cluster</li>
  <li>basculer les lectures sur le nouveau cluster</li>
  <li>arrêter les écritures sur l’ancien cluster</li>
</ul>

<p>Il n’est pas nécessaire d’enchaîner toutes les étapes dans la même journée, cela présente donc l’avantage de pouvoir étaler les déploiements dans le temps en fonction des disponibilités,
ainsi que de surveiller attentivement le <em>monitoring</em> pendant quelques jours pour vérifier que l’infrastructure supporte bien les changements apportés.</p>

<h2 id="écritures-en-y">Écritures en <em>Y</em></h2>

<p>Nous utilisons <a href="/2016/06/23/video-phptour-worker-php">des <em>workers</em> Php</a> pour détecter les changements dans notre BDD,
suite à quoi un message est publié dans une file d’attente pour être traité par un autre <em>worker</em> qui se chargera de synchroniser les entités entre MySQL et Elasticsearch.
Il était primordial que le cluster de production ne soit pas impacté par les éventuelles erreurs rencontrées sur le nouveau cluster.
Une de nos premières intentions était de publier le message de mise à jour dans une deuxième file d’attente, consommée par des workers dédiés eux aussi au nouveau cluster.
<img src="/images/posts/migration-es/Multi-queues.png" alt="Plusieurs files d'attentes" /></p>

<p>Le gros inconvénient est que cela impliquait de doubler toutes les lectures sur la BDD, toutes les requêtes devaient être executées une fois par cluster,
cela risquait donc d’impacter d’autres services.
Nous sommes donc partis sur une solution purement logicielle, puisque pour chaque entité mise à jour ce sont les workers qui les envoient sur chaque cluster.
<img src="/images/posts/migration-es/Mono-queue.png" alt="File d'attente unique" /></p>

<p>Il est par contre nécessaire de gérer correctement les erreurs, que faire si une erreur intervient sur un cluster mais pas l’autre?
Si le nouveau cluster devient instable et que l’on renvoie les messages systématiquement dans la file d’attente, on risque d’accentuer inutilement la charge en écriture sur le cluster stable en production.
Notre compromis est de définir comme <em>master</em> le cluster de production (celui où les données sont lues), et seules ses erreurs provoquent la génération d’un nouveau message.
Les erreurs sur le cluster <em>slave</em> sont monitorées, mais ne génèrent pas de nouveaux messages dans la file d’attente.
Effectivement, puisque chaque soir nous resynchronisons <strong>toutes</strong> les données entre MySql et Elasticsearch, on peut se permettre d’avoir des données <em>moins fraiches</em> sur le cluster <em>slave</em> le temps d’une journée.</p>

<p>Initialement, nous pensions que ce système <em>master/slave</em> serait temporaire, mais très rapidement nous avons pérennisé ces développements, cela nous permettait de tester facilement différents clusters,
ou encore de vérifier que les données étaient bien indexées de la même manière, faire des <em>rollbacks</em> en urgence…</p>

<p>Une dernière difficulté était de faire cohabiter deux version différentes du <em>Sdk</em> <a href="https://github.com/elastic/elasticsearch-php">Elasticsearch Php</a> dans le même projet.
Il y a effectivement une incompatibilité entre les versions <code class="language-plaintext highlighter-rouge">2.*</code> et <code class="language-plaintext highlighter-rouge">5.*</code>, et nous n’avons pas eu d’autre choix que de cloner la librairie concernée et de changer tous les <em>namespaces</em> pour éviter les conflits de noms.
Malgré tout, ce ne sont pas les écritures dans Elasticsearch qui nous ont posé le plus de problèmes.</p>

<h2 id="migration-des-requêtes">Migration des requêtes</h2>

<p>Il y a eu de nombreux changements apportés entre la version <code class="language-plaintext highlighter-rouge">1.7</code> et <code class="language-plaintext highlighter-rouge">5.0</code> et souvent pour le mieux.
Les différentes évolutions de syntaxes ont généralement vite été faites, car nous avions pris soin d’encapsuler la construction des requêtes via quelques fonctions <em>helper</em> (une sorte de <em>query builder</em>).
Il nous a donc suffit de changer ces quelques fonctions pour traduire les anciennes requêtes vers la nouvelle syntaxe.</p>

<p>Une erreur classique que nous faisions en <code class="language-plaintext highlighter-rouge">1.7</code> était de se contenter d’un <em>mapping</em> par <em>défaut</em>, qui avait le mérite de fonctionner sans efforts avec nos requêtes et nos données.
Lors du passage à la version <code class="language-plaintext highlighter-rouge">5.0</code>, Elasticsearch a commencé à refuser certaines de nos requêtes car elles ne pouvaient pas être performantes.
Il fallait choisir, soit activer explicitement des options de mapping en faisant un compromis sur les performances générales,
soit affiner le <em>mapping</em> pour qu’il soit plus adapté à la nature de nos requêtes.
Il s’agit d’un bon exemple de <a href="https://www.joelonsoftware.com/2002/11/11/the-law-of-leaky-abstractions/"><em>Leaky Abstraction</em></a>,
on a beau utiliser des outils pour s’abstraire de la façon dont sont stockées les données, nous sommes toujours obligés de comprendre ce qu’il se passe à l’intérieur pour en tirer les meilleures performances.
Heureusement pour nous notre mapping était assez trivial à changer, car nous n’utilisons pas Elasticsearch pour faire de la recherche <a href="https://en.wikipedia.org/wiki/Full-text_search"><em>full-text</em></a>
mais seulement pour des recherches exactes sur des identifiants, des codes… Il nous a généralement suffit d’utiliser le nouveau type <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html"><code class="language-plaintext highlighter-rouge">keyword</code></a>
pour que nos requêtes puissent être acceptées.</p>

<p>Pour s’assurer du bon fonctionnement des APIs suite à ces nombreux changements, nous avons investi du temps pour écrire des tests fonctionnels de bout en bout,
pour vérifier que les résultats restaient inchangés malgré le changement de version de cluster.
Bien sûr, même si en local nos tests étaient au vert, des erreurs pouvaient apparaître en production.
Le scénario était alors simple, faire un <em>rollback</em>, ajouter les tests correspondants aux nouvelles erreurs detectées, les faire passer en local, puis recommencer !</p>

<p>Ce qui nous a peut-être le plus éprouvé dans cette migration, c’est une <a href="https://github.com/elastic/elasticsearch/issues/23796">regression introduite dans la version <code class="language-plaintext highlighter-rouge">5.2</code></a>
qui avait pour conséquence de changer certains de nos tableaux vides en valeur <code class="language-plaintext highlighter-rouge">null</code>.
Il nous a fallut quasiment repasser sur chaque requête pour retransformer ces valeurs en quelque chose de cohérent. 
Quand on avait de la chance, ce <em>bug</em> faisait échouer nos tests, mais il est malheureusement arrivé que ce soient les <em>parseurs</em> json des applications 6play de production qui en fassent les frais, avec différents plantages à la clé…</p>

<h2 id="conclusions">Conclusions</h2>

<p>Cette migration fut longue et parfois douloureuse, heureusement les résultats sont maintenant au rendez-vous!
<img src="/images/posts/migration-es/response-time.png" alt="Temps de réponse des APIs" /></p>

<p>De plus, cela nous a donné l’occasion d’investir un peu de temps pour améliorer nos tests fonctionnels, et pour développer un système robuste pour la réplication des données sur plusieurs clusters Elasticsearch.
On peut néanmoins se poser des questions sur la stratégie très <em>offensive</em> de changement de version de la part de Elasticsearch,
autant de <em>releases</em> avec autant de changements en si peu de temps, il faut être capable de suivre!
Pendant que nous finalisions notre production sur la version <code class="language-plaintext highlighter-rouge">5.2</code>, la <code class="language-plaintext highlighter-rouge">5.3</code> a eu le temps de sortir, et la <code class="language-plaintext highlighter-rouge">6.0</code> est apparue en beta.
Nous allons essayer de profiter un peu de ce nouveau cluster avant de poursuivre vers une nouvelle grande migration :)</p>

    
  </section>

  <!-- Social media shares -->
  

<div class="share-buttons">
    <ul class="share-buttons">
        <li class="meta">Share</li>
         
        <li>
            <a href="https://twitter.com/intent/tweet?text=Elasticsearch%3A+la+grande+migration%20https%3A%2F%2Ftech.bedrockstreaming.com%2F2017%2F06%2F01%2Fmigration-elasticsearch.html"
               target="_blank" title="">
                <i class="fab fa-twitter-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Tweet</span>
            </a>
        </li>
             
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://tech.bedrockstreaming.com/2017/06/01/migration-elasticsearch.html&title=Elasticsearch%3A+la+grande+migration%20%7C%20Bedrock+Tech+Blog&summary=&source=https://tech.bedrockstreaming.com/2017/06/01/migration-elasticsearch.html"
               target="_blank" title=" LinkedIn">
                <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on LinkedIn</span>
            </a>
        </li>
          
        <li>
            <a href="mailto:?subject=Elasticsearch: la grande migration%20%7C%20Bedrock Tech Blog&body=https://tech.bedrockstreaming.com/2017/06/01/migration-elasticsearch.html"
               target="_blank" title="">
                <i class="fas fa-envelope-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Email</span></a>
        </li>
        
    </ul>
</div>




   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags/#Elasticsearch">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Elasticsearch</p>
        </a></li>
      
        <li><a class="button" href="/tags/#Php">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> Php</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <div id="previous-post">
        <a alt="Genesis of M6's Datalake" href="/data/2017/10/23/genesis-of-m6-datalake.html">
            <p>Previous post</p>
            Genesis of M6's Datalake
        </a>
    </div>
    

    
    <div id="next-post">
        <a alt="Last night isomorphic JS saved our life!" href="/2017/05/17/spa-mode-isomorphism-js.html">
            <p>Next post</p>
            Last night isomorphic JS saved our life!
        </a>
    </div>
    
</div>



<!--Utterances-->


<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }

  

  
  header#main { background-image: url('/images/posts/migration-es/migration.jpg'); }
  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                
<li>
    <a feed.xml href="/feed.xml"
       title="Follow RSS feed"
       target="_blank">
        <span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>



    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/BedrockStreaming"
               title="Follow on Github"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://www.linkedin.com/company/bedrock-streaming"
               title="Follow on Linkedin"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://twitter.com/Bedrock_Tech"
               title="Follow on Twitter"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://www.youtube.com/channel/UCSwvTdCWHS6ulRaIqdk7lNw"
               title="Follow on Youtube"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    


                </ul>
            </div>
</footer>



  </body>
</html>
