<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.4.0
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode -->
    
    <script>
        const isAutoTheme = true;
        document.documentElement.setAttribute('data-theme', sessionStorage.getItem('theme'))
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon">

    

    <!-- KaTeX 0.15.2 -->
    
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    <!-- Mermaid 8.13.10 -->
    
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({startOnLoad:true});"></script>
    

    <!-- Simple Jekyll Search 1.9.1 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    
    <!-- Matomo -->
    <script>
        var _paq = window._paq = window._paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
            var u="https://bedrockstreaming.matomo.cloud/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
            _paq.push(['setSiteId', '2']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src='//cdn.matomo.cloud/bedrockstreaming.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>
    

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-https://tech.bedrockstreaming.com';
      const isCookieConsent = 'false';
      const analyticsName = '';
    </script>

    
    

    <!-- SEO tags -->
    <meta property="og:image" content="https://tech.bedrockstreaming.com/images/banner_xl.jpg">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>BFF’s error definition, and handling connections to multiple API | Bedrock Tech Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="BFF’s error definition, and handling connections to multiple API" />
<meta name="author" content="Valentin CLARAS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="What is an error, a failing API? How is the BFF handling connections to multiple API?" />
<meta property="og:description" content="What is an error, a failing API? How is the BFF handling connections to multiple API?" />
<link rel="canonical" href="https://tech.bedrockstreaming.com/2022/08/25/backend-errors-connections.html" />
<meta property="og:url" content="https://tech.bedrockstreaming.com/2022/08/25/backend-errors-connections.html" />
<meta property="og:site_name" content="Bedrock Tech Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-08-25T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="BFF’s error definition, and handling connections to multiple API" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://tech.bedrockstreaming.com/2022/08/25/backend-errors-connections.html"},"url":"https://tech.bedrockstreaming.com/2022/08/25/backend-errors-connections.html","author":{"@type":"Person","name":"Valentin CLARAS"},"@type":"BlogPosting","headline":"BFF’s error definition, and handling connections to multiple API","dateModified":"2022-08-25T00:00:00+00:00","datePublished":"2022-08-25T00:00:00+00:00","description":"What is an error, a failing API? How is the BFF handling connections to multiple API?","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Bedrock Tech Blog" href="https://tech.bedrockstreaming.com/feed.xml"/>
    <link type="application/atom+xml" rel="alternate" href="https://tech.bedrockstreaming.com/feed.xml" title="Bedrock Tech Blog" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="BFF's error definition, and handling connections to multiple API">
    <meta name="twitter:description" content="A quick sidetrack in our series about Bedrock’s API gateway.This piece defines what are we talking about when we say “an error”, and explains how we handle t...">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://tech.bedrockstreaming.com/images/banner_xl.jpg">
    <meta name="twitter:image:alt" content="BFF's error definition, and handling connections to multiple API">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/images/br-site-logo.jpg" />
		</a>
        
        <a class="site-title" aria-label="Bedrock Tech Blog" href="/">
        Bedrock Tech Blog
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="About" title="About" href="/about/">
                     About 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Jobs" title="Jobs" href="/jobs/">
                     Jobs 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Last Friday Talks" title="Last Friday Talks" href="/lft/">
                     Last Friday Talks 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Meetups & Conferences" title="Meetups & Conferences" href="/meetups/">
                     Meetups & Conferences 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="OSS" title="OSS" href="/oss/">
                     OSS 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
        <li class="separator"> | </li>
        <li><a id="theme-toggle" title="BFF's error definition, and handling connections to multiple API " aria-label="BFF's error definition, and handling connections to multiple API" onclick="themeToggle()"></a></li>
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="BFF%27s+error+definition%2C+and+handling+connections+to+multiple+API" class="title">BFF's error definition, and handling connections to multiple API</h1>
      


<div class="post-info"><a href="https://twitter.com/LarsVanCiental" target="_blank" rel="noopener">
      <img alt="Author's avatar" src="/images/avatar/v_claras.jpg">
    
    <p class="meta">
      Valentin CLARAS - 
      
      August 25, 2022
    </p></a></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <p>A <em>quick</em> sidetrack in <a href="#from-the-same-series">our series</a> about Bedrock’s API gateway.
This piece defines what are we talking about when we say “an error”, and explains how we handle the numerous connections to services we are calling.</p>

<h2 id="definition">Definition</h2>

<p>In <a href="/2022/08/12/backend-fallbacks.html">the previous article</a>, we’ve seen how we handle errors.
This was mainly from a business point of view, and how it’s done in our domain.</p>

<p><em>But what is “an error”?</em></p>

<p>This term is a bit generic, and the definition will be too: <em>an error is anything unexpected by the application</em>.</p>

<p>In our context of an API Gateway, we are restricting this to the services we are calling.</p>

<p>This can be, but not exhaustively, a service not responding because:</p>
<ul>
  <li>it’s offline;</li>
  <li>it’s taking too much time to answer;</li>
  <li>it’s responding with a 5** error (when talking about an API);</li>
  <li>it’s giving us an invalid or unexpected content.</li>
</ul>

<h2 id="what-are-the-consequences-of-those-errors">What are the consequences of those errors?</h2>

<p>The first issue is: we won’t be able to display some part of the application as intended.
We’ve <a href="https://tech.bedrockstreaming.com/2022/08/12/backend-fallbacks.html#handling-failures">talked about this previously</a> already.</p>

<p>The second error, more insidious, is that it can slow down our BFF terribly.</p>

<p>The BFF response time is, on average, equals to the slowest service the BFF is calling.
If a service that usually responds in 200ms starts slowing down to an average response time of 1s and also times out half the time, it will increase the BFF response time to 1,5s (1s average, and 50% retry).</p>

<p>That’s why we must be careful when configuring those timeouts.
The BFF exposes a response-time Service Level Objective (SLO), and frontend applications will cut any connection that takes too long.
Losing some parts of the responses is better than slowing the BFF down to a point where frontend won’t get any response at all.</p>

<h2 id="how-are-we-mitigating-the-errors">How are we mitigating the errors?</h2>

<p>For any remote service, we configure short timeouts, and retry when we must.
A short timeout is a timeout that usually match the SLO of the called services, and that will match 99% of our calls.
When the SLO of the called service is higher than ours, we use a shorter timeout and accept that a larger parts of the calls will be cut.
The values are tailored according to our usages.
We use our monitoring to adapt those values in order to reduce the number of errors, while minimizing the impact on the BFF response time.
We are also constantly challenging our colleagues to improve the average response time of their services that we are calling.</p>

<p>The choice of using retries is based on the information criticality.
For example, retrieving the user’s previous viewing sessions, is important for his/her experience, so we’re using a retry here.
On the opposite, analytics are less important, so we don’t use any retry there.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">app.http_client_configs.best_effort</span><span class="pi">:</span>
        <span class="na">retry</span><span class="pi">:</span> <span class="m">1</span>
        <span class="na">timeout</span><span class="pi">:</span> <span class="m">0.6</span>
        <span class="na">connect_timeout</span><span class="pi">:</span> <span class="m">0.1</span>
    <span class="na">app.http_client_configs.fast_fail</span><span class="pi">:</span>
        <span class="na">retry</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">timeout</span><span class="pi">:</span> <span class="m">0.6</span>
        <span class="na">connect_timeout</span><span class="pi">:</span> <span class="m">0.1</span>
    <span class="na">app.http_client_configs.long_fail</span><span class="pi">:</span>
        <span class="na">retry</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">timeout</span><span class="pi">:</span> <span class="m">1</span>
        <span class="na">connect_timeout</span><span class="pi">:</span> <span class="m">0.1</span>
    <span class="na">app.http_client_configs.reliant</span><span class="pi">:</span>
        <span class="na">retry</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">timeout</span><span class="pi">:</span> <span class="m">60</span>
        <span class="na">connect_timeout</span><span class="pi">:</span> <span class="m">0.1</span>
</code></pre></div></div>
<p>Above, you can see the yaml configuration our Symfony application uses to build its Guzzle clients.</p>

<p>Each configuration can cascade onto the clients, making variants available for our Symfony services.</p>

<p>Below lies a Symfony configuration example:</p>
<ul>
  <li>We have an interface <code class="language-plaintext highlighter-rouge">BFF\Domain\Content\Repository</code> from the domain for a content repository.</li>
  <li>The interface is linked to an implementation <code class="language-plaintext highlighter-rouge">BFF\Infra\HttpContentClient</code> inside the infrastructure.</li>
  <li>The implementation is built with variants (<code class="language-plaintext highlighter-rouge">best_effort</code> and <code class="language-plaintext highlighter-rouge">fast_fail</code>) from a factory using the matching Guzzle configurations.</li>
  <li>Other services use a chosen repository <em>according to their needs and criticality</em>.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Service definition with its aliases.</span>
    <span class="na">BFF\Domain\Content\Repository</span><span class="pi">:</span> <span class="s1">'</span><span class="s">@BFF\Domain\Content\Repository.fast_fail'</span>
    <span class="na">BFF\Domain\Content\Repository.best_effort</span><span class="pi">:</span> <span class="s1">'</span><span class="s">@BFF\Infra\HttpContentClient.best_effort'</span>
    <span class="na">BFF\Domain\Content\Repository.fast_fail</span><span class="pi">:</span> <span class="s1">'</span><span class="s">@BFF\Infra\HttpContentClient.fast_fail'</span>

    <span class="c1"># Concrete implementations</span>
    <span class="na">BFF\Infra\HttpContentClient.best_effort</span><span class="pi">:</span>
        <span class="na">class</span><span class="pi">:</span> <span class="s1">'</span><span class="s">BFF\Infra\HttpContentClient'</span>
        <span class="na">factory</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@BFF\Infra\ContentClientFactory'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">create'</span><span class="pi">]</span>
        <span class="na">bind</span><span class="pi">:</span>
            <span class="na">$clientConfig</span><span class="pi">:</span> <span class="s1">'</span><span class="s">%app.http_client_configs.best_effort%'</span>
    <span class="na">BFF\Infra\HttpContentClient.fast_fail</span><span class="pi">:</span>
        <span class="na">class</span><span class="pi">:</span> <span class="s1">'</span><span class="s">BFF\Infra\HttpContentClient'</span>
        <span class="na">factory</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@BFF\Infra\ContentClientFactory'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">create'</span><span class="pi">]</span>
        <span class="na">bind</span><span class="pi">:</span>
            <span class="na">$clientConfig</span><span class="pi">:</span> <span class="s1">'</span><span class="s">%app.http_client_configs.fast_fail%'</span>

    <span class="c1"># Other services using the Repository</span>
    <span class="na">BFF\Domain\Navigation\NavBarResolver</span><span class="pi">:</span>
        <span class="na">$content</span><span class="pi">:</span> <span class="s1">'</span><span class="s">@BFF\Domain\Content\Repository.best_effort'</span>

    <span class="na">BFF\Domain\Layout\BlockResolver</span><span class="pi">:</span>
        <span class="na">$content</span><span class="pi">:</span> <span class="s1">'</span><span class="s">@BFF\Domain\Content\Repository.fast_fail'</span>
</code></pre></div></div>

<p><em>This is an over simplified example as we have more layers and wrappers used for things like caching, monitoring, logging, etc.</em></p>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we’ve clarified what an error is, and explained that we cannot generalize the configuration and usage of our APIs. Timeouts and retries, especially, must be tailored depending on the criticality of each call.</p>

<p>This was a deviation on the road to our next article, where we will talk about monitoring the errors and stopping calls to failing APIs by implementing the circuit-breaker pattern.</p>

<h2 id="from-the-same-series">From the same series</h2>

<ol>
  <li><a href="/2022/06/10/backend-bff-intro.html">What’s a BFF</a></li>
  <li><a href="/2022/08/12/backend-fallbacks.html">Handling API failures in a gateway</a></li>
  <li><a href="/2022/08/25/backend-errors-connections.html">What’s an error, and handling connection to multiple APIs</a></li>
</ol>

    
  </section>

  <!-- Social media shares -->
  

<div class="share-buttons">
    <ul class="share-buttons">
        <li class="meta">Share</li>
         
        <li>
            <a href="https://twitter.com/intent/tweet?text=BFF%27s+error+definition%2C+and+handling+connections+to+multiple+API%20https%3A%2F%2Ftech.bedrockstreaming.com%2F2022%2F08%2F25%2Fbackend-errors-connections.html"
               target="_blank" title="">
                <i class="fab fa-twitter-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Tweet</span>
            </a>
        </li>
             
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://tech.bedrockstreaming.com/2022/08/25/backend-errors-connections.html&title=BFF%27s+error+definition%2C+and+handling+connections+to+multiple+API%20%7C%20Bedrock+Tech+Blog&summary=&source=https://tech.bedrockstreaming.com/2022/08/25/backend-errors-connections.html"
               target="_blank" title=" LinkedIn">
                <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on LinkedIn</span>
            </a>
        </li>
          
        <li>
            <a href="mailto:?subject=BFF's error definition, and handling connections to multiple API%20%7C%20Bedrock Tech Blog&body=https://tech.bedrockstreaming.com/2022/08/25/backend-errors-connections.html"
               target="_blank" title="">
                <i class="fas fa-envelope-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Email</span></a>
        </li>
        
    </ul>
</div>




   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags/#api">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> api</p>
        </a></li>
      
        <li><a class="button" href="/tags/#api-gateway">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> api-gateway</p>
        </a></li>
      
        <li><a class="button" href="/tags/#back-for-front">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> back-for-front</p>
        </a></li>
      
        <li><a class="button" href="/tags/#backend">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> backend</p>
        </a></li>
      
        <li><a class="button" href="/tags/#error">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> error</p>
        </a></li>
      
        <li><a class="button" href="/tags/#guzzle">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> guzzle</p>
        </a></li>
      
        <li><a class="button" href="/tags/#php">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> php</p>
        </a></li>
      
        <li><a class="button" href="/tags/#retry">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> retry</p>
        </a></li>
      
        <li><a class="button" href="/tags/#slo">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> slo</p>
        </a></li>
      
        <li><a class="button" href="/tags/#timout">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> timout</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    

    
    <div id="next-post">
        <a alt="Handling dependencies failures in an API gateway" href="/2022/08/12/backend-fallbacks.html">
            <p>Next post</p>
            Handling dependencies failures in an API gateway
        </a>
    </div>
    
</div>



<!--Utterances-->


<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }

  
  .post-content a { color: rgb(255,128,0) !important; }
  .share-buttons a { color: rgb(255,128,0) !important; }
  .tag-list a:not(:hover) { color: rgb(255,128,0) !important; }
  div#post-nav a { color: rgb(255,128,0) !important; }
  footer a { color: rgb(255,128,0) !important; }
  .site-header nav a:hover {  color: rgb(255,128,0) !important; }
  a.button:hover {
    background: rgb(255,128,0) !important;
    border: 1px solid rgb(255,128,0) !important;
    color: white;
    text-decoration: none;
    filter: none;
  }
  header#main {
      background-color: rgb(255,128,0) !important;
      background-image: url('/assets/img/lineart.png');
  }
  

  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                
<li>
    <a feed.xml href="/feed.xml"
       title="Follow RSS feed"
       target="_blank">
        <span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>



    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/BedrockStreaming"
               title="Follow on Github"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://www.linkedin.com/company/bedrock-streaming"
               title="Follow on Linkedin"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://twitter.com/Bedrock_Tech"
               title="Follow on Twitter"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    


                </ul>
            </div>
</footer>



  </body>
</html>
