<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.4.0
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    
    <!-- Theme Mode -->
    <script>
        const isAutoTheme = true;
        document.documentElement.setAttribute('data-theme', sessionStorage.getItem('theme'))
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon">

    

    
    <!-- KaTeX 0.15.2 -->
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    
    <!-- Mermaid 8.13.10 -->
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({startOnLoad:true});"></script>
    

    <!-- Simple Jekyll Search 1.9.1 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    
    <!-- Matomo -->
    <script>
        var _paq = window._paq = window._paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
            var u="https://bedrockstreaming.matomo.cloud/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
            _paq.push(['setSiteId', '2']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.async=true; g.src='//cdn.matomo.cloud/bedrockstreaming.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>
    

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-https://tech.bedrockstreaming.com';
      const isCookieConsent = 'false';
      const analyticsName = '';
    </script>

    
    

    <!-- SEO tags -->
    <meta property="og:image" content="https://tech.bedrockstreaming.com/images/banner_xl.jpg">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Using a circuit breaker to spare the API we are calling | Bedrock Tech Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Using a circuit breaker to spare the API we are calling" />
<meta name="author" content="Valentin CLARAS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="What is a circuit-breaker, and how are we using it?" />
<meta property="og:description" content="What is a circuit-breaker, and how are we using it?" />
<link rel="canonical" href="https://tech.bedrockstreaming.com/2022/09/02/backend-circuit-breaker.html" />
<meta property="og:url" content="https://tech.bedrockstreaming.com/2022/09/02/backend-circuit-breaker.html" />
<meta property="og:site_name" content="Bedrock Tech Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-02T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Using a circuit breaker to spare the API we are calling" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://tech.bedrockstreaming.com/2022/09/02/backend-circuit-breaker.html"},"url":"https://tech.bedrockstreaming.com/2022/09/02/backend-circuit-breaker.html","author":{"@type":"Person","name":"Valentin CLARAS"},"@type":"BlogPosting","headline":"Using a circuit breaker to spare the API we are calling","dateModified":"2022-09-02T00:00:00+00:00","datePublished":"2022-09-02T00:00:00+00:00","description":"What is a circuit-breaker, and how are we using it?","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Bedrock Tech Blog" href="https://tech.bedrockstreaming.com/feed.xml"/>
    <link type="application/atom+xml" rel="alternate" href="https://tech.bedrockstreaming.com/feed.xml" title="Bedrock Tech Blog" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="Using a circuit breaker to spare the API we are calling">
    <meta name="twitter:description" content="Hi! We’re going to start our fourth article about Bedrock’s API gateway.Today we will talk about the circuit breaker pattern, what it is, and how we’re using...">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://tech.bedrockstreaming.com/images/banner_xl.jpg">
    <meta name="twitter:image:alt" content="Using a circuit breaker to spare the API we are calling">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/images/br-site-logo.jpg" />
		</a>
        
        <a class="site-title" aria-label="Bedrock Tech Blog" href="/">
        Bedrock Tech Blog
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Jobs" title="Jobs" href="/jobs/">
                     Jobs 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Last Friday Talks" title="Last Friday Talks" href="/lft/">
                     Last Friday Talks 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Meetups & Conferences" title="Meetups & Conferences" href="/meetups/">
                     Meetups & Conferences 
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="OSS" title="OSS" href="/oss/">
                     OSS 
                </a>
            </li>
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
        <li class="separator"> | </li>
        <li><a id="theme-toggle" title="Using a circuit breaker to spare the API we are calling " aria-label="Using a circuit breaker to spare the API we are calling" onclick="themeToggle()"></a></li>
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="Using+a+circuit+breaker+to+spare+the+API+we+are+calling" class="title">Using a circuit breaker to spare the API we are calling</h1>
      


<div class="post-info"><a href="https://twitter.com/LarsVanCiental" target="_blank" rel="noopener">
      <img alt="Author's avatar" src="/images/avatar/v_claras.jpg">
    
    <p class="meta">
      Valentin CLARAS - 
      
      September 02, 2022
    </p></a></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <p>Hi! We’re going to start our <a href="#from-the-same-series">fourth article</a> about Bedrock’s API gateway.
Today we will talk about the circuit breaker pattern, what it is, and how we’re using it.</p>

<h2 id="the-circuit-breaker-pattern">The Circuit Breaker Pattern</h2>

<p>With this pattern, our API Gateway detects errors when calling its dependencies.
It will stop calling them if a given threshold (ratio of errors) is crossed.</p>

<p>The circuit breaker allows us to spare the dependencies in difficulty, but also avoid taking time to do something that will most likely fail.</p>

<p>You’ll find a more detailed explanation about the circuit breaker on Martin FOWLER’s <a href="https://martinfowler.com/bliki/CircuitBreaker.html">blog</a>.</p>

<h2 id="where-to-use-it">Where to use it?</h2>

<p>As soon as a service call is not mandatory for our BFF to answer something that a frontend application can read, then we can use the circuit breaker pattern.</p>

<p>If an API cannot handle a sudden increase in traffic (for example: it’s not scaling fast enough or its database starts to throttle), it’s better to stop calling it temporarily.
When the right timeouts are configured, an API throttling will result in an error, as seen <a href="/2022/08/25/backend-errors-connections.html">in the previous article</a></p>

<p>Here are some examples:</p>

<p><em>Video progress information</em></p>

<p>Displaying a video progress bar is useful for end users, but it’s better to not display this information instead of risking the entire page to not be displayed!
If the service that stores video viewing sessions is (slowing) down, we can stop asking for this information and stop displaying the video progress bar.</p>

<p><img src="/images/posts/2022-09-02-backend-circuit-breaker/progress-bar.png" alt="a video with a progress bar" /></p>

<p><em>User geolocation</em></p>

<p>The geolocation service allows us to know where the end user is in the world. Based on this information we lock some area restricted contents.
If this service goes down for some reason, we will stop calling it, and instead use a default area matching the area of our customer as it’s the majority case.</p>

<h2 id="implementation-and-configuration">Implementation and configuration</h2>

<p>So far we’re only using the circuit breaker pattern with HTTP calls.
This is made possible thanks to the <a href="https://github.com/ackintosh/ganesha">Ganesha library</a>, and its Guzzle middleware.</p>

<p>The Guzzle middleware is created as a service within the Symfony service definitions.
It’s then injected into our <code class="language-plaintext highlighter-rouge">HttpClientFactory</code> that will handle the creation of all the different clients.
The responsibility of using the circuit breaker falls on each service that will create a http client.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Ackintosh\Ganesha\GuzzleMiddleware</span><span class="pi">:</span>
    <span class="na">factory</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@...Infrastructure\HttpClient\CircuitBreaker\CircuitBreakerMiddlewareFactory'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">buildWithRateStrategy'</span><span class="pi">]</span>
    <span class="na">arguments</span><span class="pi">:</span>
        <span class="na">$timeWindow</span><span class="pi">:</span> <span class="m">60</span>
        <span class="na">$failureRateThreshold</span><span class="pi">:</span> <span class="m">40</span>
        <span class="na">$minimumRequests</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">$intervalToHalfOpen</span><span class="pi">:</span> <span class="m">60</span>
</code></pre></div></div>

<h2 id="monitoring-the-circuit-breaker">Monitoring the circuit breaker</h2>

<p>At Bedrock, we’re used to monitor everything. The circuit breaker makes no exception to this rule.
Usually we store time spent and response code for every outgoing http call.
To see when the circuit breaker is open, we catch the ganesha’s <code class="language-plaintext highlighter-rouge">RejectedException</code> to save a dedicated <code class="language-plaintext highlighter-rouge">666</code> http status.</p>

<p>This allows us to look for the exact number of calls avoided.
Below lies an example of a monitoring chart showing some errors happening during a usual night.</p>

<p><img src="/images/posts/2022-09-02-backend-circuit-breaker/monitoring-1.png" alt="monitoring excluding less reliable services" /></p>

<p>We also have to query slower services that often trigger our circuit breaker because they cannot answer in the short timeout we impose.
Thereafter, the same monitoring chart including such services.</p>

<p><img src="/images/posts/2022-09-02-backend-circuit-breaker/monitoring-2.png" alt="monitoring including less reliable service" /></p>

<h2 id="going-further">Going further</h2>

<p>So far, we have identified two areas for improvements described below.</p>

<h3 id="different-configurations">Different configurations</h3>

<p>We’re only using a single configuration for the circuit breaker.
We should allow each service to choose from a named list of configurations when creating a client, <a href="/2022/08/25/backend-errors-connections.html">similarly to the different guzzle configuration we are using</a>.
The main obstacle is a lack of hindsight which prevent us to have fine-tuned values.
This is something that will definitively be improved over time as we monitor over long period.</p>

<h3 id="staled-cache-when-the-circuit-breaker-is-open">Staled cache when the circuit breaker is open</h3>

<p>For many editorial contents, we’re using a staled cache version of the data as a fallback.
To do so, we’re using <a href="https://github.com/Kevinrob/guzzle-cache-middleware">another guzzle middleware</a>.</p>

<p>Sadly, the two middlewares don’t work together. We have to chose which one to use based on the criticality of the content and the API behind. 
This is something that we aim at solving with a bit of R&amp;D.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In today’s post we’ve seen our usage of the circuit breaker pattern.
It allows us to spare the services we are calling, and avoid slowing us down in case of throttling.</p>

<p>Next time, we will talk about our ultimate layer of protection to ensure the BFF always responds something readable to frontend applications.</p>

<h2 id="from-the-same-series">From the same series</h2>

<ol>
  <li><a href="/2022/06/10/backend-bff.html">What’s a BFF</a></li>
  <li><a href="/2022/06/12/backend-fallbacks.html">Handling API failures in a gateway</a></li>
  <li><a href="/2022/08/25/backend-errors-connections.html">What’s an error, and handling connexion to multiple APIs</a></li>
  <li><a href="/2022/09/02/backend-circuit-breaker.html">Using a circuit breaker</a></li>
</ol>

    
  </section>

  <!-- Social media shares -->
  

<div class="share-buttons">
    <ul class="share-buttons">
        <li class="meta">Share</li>
         
        <li>
            <a href="https://twitter.com/intent/tweet?text=Using+a+circuit+breaker+to+spare+the+API+we+are+calling%20https%3A%2F%2Ftech.bedrockstreaming.com%2F2022%2F09%2F02%2Fbackend-circuit-breaker.html"
               target="_blank" title="">
                <i class="fab fa-twitter-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Tweet</span>
            </a>
        </li>
             
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://tech.bedrockstreaming.com/2022/09/02/backend-circuit-breaker.html&title=Using+a+circuit+breaker+to+spare+the+API+we+are+calling%20%7C%20Bedrock+Tech+Blog&summary=&source=https://tech.bedrockstreaming.com/2022/09/02/backend-circuit-breaker.html"
               target="_blank" title=" LinkedIn">
                <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on LinkedIn</span>
            </a>
        </li>
          
        <li>
            <a href="mailto:?subject=Using a circuit breaker to spare the API we are calling%20%7C%20Bedrock Tech Blog&body=https://tech.bedrockstreaming.com/2022/09/02/backend-circuit-breaker.html"
               target="_blank" title="">
                <i class="fas fa-envelope-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Email</span></a>
        </li>
        
    </ul>
</div>




   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags/#api">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> api</p>
        </a></li>
      
        <li><a class="button" href="/tags/#api-gateway">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> api-gateway</p>
        </a></li>
      
        <li><a class="button" href="/tags/#back-for-front">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> back-for-front</p>
        </a></li>
      
        <li><a class="button" href="/tags/#backend">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> backend</p>
        </a></li>
      
        <li><a class="button" href="/tags/#circuit-breaker">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> circuit-breaker</p>
        </a></li>
      
        <li><a class="button" href="/tags/#php">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> php</p>
        </a></li>
      
        <li><a class="button" href="/tags/#resiliency">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> resiliency</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    

    
    <div id="next-post">
        <a alt="Prescaling pods in Kubernetes, we open source our solution" href="/2022/09/01/kubernetes-prescaling-we-open-source-our-solution.html">
            <p>Next post</p>
            Prescaling pods in Kubernetes, we open source our solution
        </a>
    </div>
    
</div>



<!--Utterances-->


<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }

  
  .post-content a { color: rgb(255,128,0) !important; }
  .share-buttons a { color: rgb(255,128,0) !important; }
  .tag-list a:not(:hover) { color: rgb(255,128,0) !important; }
  div#post-nav a { color: rgb(255,128,0) !important; }
  footer a { color: rgb(255,128,0) !important; }
  .site-header nav a:hover {  color: rgb(255,128,0) !important; }
  a.button:hover {
    background: rgb(255,128,0) !important;
    border: 1px solid rgb(255,128,0) !important;
    color: white;
    text-decoration: none;
    filter: none;
  }
  header#main {
      background-color: rgb(255,128,0) !important;
      background-image: url('/assets/img/lineart.png');
  }
  

  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/sylhare/Type-on-Strap">Type on Strap</a>
</p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                
<li>
    <a feed.xml href="/feed.xml"
       title="Follow RSS feed"
       target="_blank">
        <span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>



    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/BedrockStreaming"
               title="Follow on Github"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://www.linkedin.com/company/bedrock-streaming"
               title="Follow on Linkedin"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://twitter.com/Bedrock_Tech"
               title="Follow on Twitter"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://www.youtube.com/channel/UCSwvTdCWHS6ulRaIqdk7lNw"
               title="Follow on Youtube"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    


                </ul>
            </div>
</footer>



  </body>
</html>
