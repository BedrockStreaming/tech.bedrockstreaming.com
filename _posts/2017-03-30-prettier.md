---
layout: post
title: "Format all the things"
description: "How we set up prettier for 6play"
author:
  name: Florent Lepretre
  avatar:
  email:
  twitter: SuperFlaw
  facebook:       
  github:    
category:
tags: [prettier, javascript, react, lint, eslint, 6play]
image:
  feature: posts/prettier/military.jpg
  credit: Kevin Frayer
  creditlink: http://www.gettyimages.fr/
comments: true
language: en
---

## Prettier

[Prettier](https://github.com/prettier/prettier) is a brand new lib for javascript environment. Its goal is simple: format the code for you. For example, if I write this:
<script src="https://gist.github.com/flepretre/dcc564b045b204c7a2e184c8151ddfa0.js"></script>

And I run prettier on it, I'll get that:
<script src="https://gist.github.com/flepretre/5a18257706027651d7c38c1b2504f8a7.js"></script>

You can try it by yourself on [prettier’s website](https://prettier.github.io/prettier/#%7B%22content%22%3A%22import%20React%2C%20%7B%20Component%20%20%7D%20from%20'react'%3B%5Cn%5Cnexport%20default%5Cnclass%20Prettier%20extends%20Component%5Cn%7B%5Cn%20%20render%20()%7B%5Cn%20%20%20%20return%20(%5Cn%20%20%20%20%20%20%3Cdiv%20className%3D%5C%22prettier%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%3Cdiv%3E%5Cn%20%20%20%20%20%20%20%20%20%20%3Ch1%3EAbout%20Prettier%3C%2Fh1%3E%3C%2Fdiv%3E%5Cn%20%20%20%20%20%20%20%20%3Cdiv%3EPrettier%20is%20gonna%20format%20all%20the%20things%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20I%20don't%20need%20to%20be%20a%20stylish%20developer%20anymore%20%3Awink%3A%5Cn%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%5Cn%20%20%20%20%20%20%3C%2Fdiv%3E%5Cn%20%20%20%20)%5Cn%20%20%7D%5Cn%7D%5Cn%22%2C%22options%22%3A%7B%22printWidth%22%3A120%2C%22tabWidth%22%3A2%2C%22singleQuote%22%3Afalse%2C%22trailingComma%22%3A%22all%22%2C%22bracketSpacing%22%3Afalse%2C%22jsxBracketSameLine%22%3Afalse%2C%22parser%22%3A%22babylon%22%2C%22doc%22%3Afalse%7D%7D)

Looks awesome isn't it? You don't need to be a stylish developer anymore. Well, let’s be honest, all developers do not share the same enthusiasm about this new tool. There are two kinds of developers, those who like when a program helps them to format their code, and those who don't.

There are some benefits, with prettier you don't waste your time to reformat your code because your destructuring expression reaches the character cap of your config. You no longer have conflicts because your colleagues change indentation on the code you're currently working on.

But it also comes with some sacrifices. The first one is your coding style. We are generally used to add some line breaks in for each call of a chained api (example [here](https://prettier.github.io/prettier/#%7B%22content%22%3A%22const%20renderPlayground%20%3D%20extraConfiguration%20%3D%3E%20%7B%5Cn%20%20store.dispatch(%5Cn%20%20%20%20settingsChange(%5Cn%20%20%20%20%20%20getPlaygroundBaseConfiguration(%5Cn%20%20%20%20%20%20%20%20merge(extraConfiguration%2C%20urlConfiguration)%5Cn%20%20%20%20%20%20)%5Cn%20%20%20%20)%5Cn%20%20)%3B%5Cn%7D%3B%5Cn%22%2C%22options%22%3A%7B%22printWidth%22%3A120%2C%22tabWidth%22%3A2%2C%22singleQuote%22%3Atrue%2C%22trailingComma%22%3A%22none%22%2C%22bracketSpacing%22%3Atrue%2C%22jsxBracketSameLine%22%3Afalse%2C%22parser%22%3A%22babylon%22%2C%22doc%22%3Afalse%7D%7D). If it can, prettier will make this fit in one line, and you will lose some clarity to your code. Same thing with the parentheses you write in complex boolean operations (example [here](https://prettier.github.io/prettier/#%7B%22content%22%3A%22export%20const%20mustRefresh%20%3D%20(%7Bapplaunch%3A%20%7BlastCheck%2C%20applaunchConfig%20%3D%20%7B%7D%7D%7D)%20%3D%3E%5Cn%20%20!lastCheck%20%7C%7C%20(moment().valueOf()%20-%20lastCheck%20%3E%20(applaunchConfig.maxAge%20%7C%7C%2015%20*%2060%20*%201000))%3B%22%2C%22options%22%3A%7B%22printWidth%22%3A120%2C%22tabWidth%22%3A2%2C%22singleQuote%22%3Atrue%2C%22trailingComma%22%3A%22none%22%2C%22bracketSpacing%22%3Atrue%2C%22jsxBracketSameLine%22%3Afalse%2C%22parser%22%3A%22babylon%22%2C%22doc%22%3Afalse%7D%7D). You have to remember operator priority because you're going to need it!

For a relatively big project like our, we prefer to add some consistency to our code, avoid wasting our time on writing and solving conflicts, and loose a little bit of lisibility and style in our code.

## How to configure it?

We already have [eslint setup](https://github.m6web.fr/m6web/eslint-config-m6web) in our project with some rules tweakings. So for us, prettier had to interface with eslint. Fortunately for us, it comes with a bunch of plugins.

- [eslint-config-prettier](https://github.com/prettier/eslint-config-prettier): this lib disables all eslint rules that are in conflict with prettier format. Without it we would need to turn off those rules manually.
- [eslint-plugin-prettier](https://github.com/not-an-aardvark/eslint-plugin-prettier): this lib includes prettier format as eslint rules. So if our code is not well formatted, eslint will throw errors. This is the most important plugin for us, it makes the lint fail if the code is not well formatted. Formatting is now mandatory!
- [prettier-eslint](https://github.com/prettier/prettier-eslint) ([prettier-eslint-cli](https://github.com/prettier/prettier-eslint-cli)): it just run `prettier` followed by `eslint --fix` command. The cli version allow us to use it in command line.

With those libs, we can format all our code base and apply prettier and eslint rules.

## Migration

First we had to format the whole repository. This results in a pretty huge PR, 670 modified files, +11700 -11113 changes... It means that if you choose to use prettier on your project, it will be easier if you set it up from the beginning.

Anyway, once this huge PR has been merged, we had to rebase the other PR. You see it coming, if your rewrite most of your code and rebase other changes on it, the chance to have a conflict is over 9000!
But in reality it's (almost) easier than it seems. All modifications are generated by prettier, so we can discard them and regenerate them after the rebase.

So, the first thing to do was to rebase on the parent of the format commit in order to resolve all conflicts that are not related to the formatting. In another way, we are sure that in next rebase, conflicts will only be related to prettier changes.

{% highlight bash %}
git rebase 0404b07~
# where 0404b07 is the git hash of the format commit parent
{% endhighlight %}

After that, we rebased our branch on the “prettier” commit, and we ask git to automatically keep the branch changes on conflict and discard those from prettier.

{% highlight bash %}
git rebase 0404b07 -s recursive -X theirs
{% endhighlight %}

Then we just need to rerun prettier to get the format back on the rebased code. After that, branches are well formatted and can get back to their normal life-cycle.

## How does it work in day-life?

First we add the following scripts in the `package.json` file to be able to use prettier as a yarn (or npm) command.

{% highlight javascript %}
    "format": "prettier-eslint --write",
    "format-sources": "prettier-eslint --write 'src/!(vendor)/**/*.{js,jsx}' 'tests/**/*.js' '{config/gulp,config/ci,scripts,ci}/**/*.js' '*.js' 'playground/**/*.{js,jsx}'",
{% endhighlight %}

The first line is used to format files given as parameter, it’s used in git’s pre-commit hook. The second one is there to format all our sources, we should not use it anymore. This command takes around 1 minute to execute, it’s a little too long to be used in the development process. It’s more interesting to plug prettier to our IDE and only format modified files.    

Well, if we try to harmonize our code style, everybody is free to use his favorite IDE.
Those using `atom` or `sublime-text` can use plugins for their save action (atom plugin [here](https://github.com/prettier/prettier-atom) with "ESLint Integration" checkbox and sublime-text plugin [here](https://github.com/TheSavior/ESLint-Formatter)). Each saved file is automatically formatted by prettier. This is clearly the most comfortable solution.

Those used to apply format action in Webstorm have to configure an external tool to do it. [Here](https://blog.jetbrains.com/webstorm/2016/08/using-external-tools/) is a good article to setup your external tool if you are interested in this solution.

Finally we wrote a pre-commit hook and add it to our documentation. It automatically runs `prettier` on all added files from our javascript sources. [lint-stage](https://github.com/okonet/lint-staged) does the same, but we don’t want to force the whole team to use it. It’s clearly not necessary to have this for those who have a save action which already run prettier.

Here's an example of our pre-commit hook:

{% highlight bash %}
git diff --name-only HEAD | grep -E "src/.*\.js.?$" | xargs yarn format
{% endhighlight %}

## In conclusion
Prettier is a new tool to add to your ecosystem. Its role is to format the code for you in a very strict way. Thanks to a bunch of plugins coming along, it also respects and applies `eslint` rules. Like we said, there are few sacrifices to make in clarity, but it allows you to stop taking care of things that are not the real value of the code you write. It also helps you to reduce meaningless conflicts and to struggles on "how we should write this". We plan to use it on all our javascript repositories to harmonize them.
