---
layout: post
title: ""
description: ""
author: bedrock 
category: resilience, frontend, back-for-front
tags: []
color: rgb(251,87,66)
---

Earlier this year took place the [Euro soccer competition](https://www.uefa.com/euro2024/), spanning over a month and with thousands of people tuning all over the world to watch the matches. One of our customers, [M6+](https://www.6play.fr/), was streaming several of these matches - And during the competition, hundreds of thousands of browsers, phones and TVs were able to seamlessly stream the matches with no major issue at all. It was, however, no easy feat to reach that state : How did we do that ? What were the challenges we faced, the solutions we envisioned ? In this article, we'll discuss one of the features we developed specifically for the Euro : Something that we called the "Special Event Page".

## The need for a Special Event Page

This feature was actually first developed back in 2021, for a similar reason : Yet another Euro soccer tournament ! Back then, it was a very simple feature : Display a page to the user,  once per session and prior to any kind of backend call, that would prompt them to go to the football. Here's what it looked like :

![Photo of the old Special Event page, in 2021](/images/posts/2024-08-14-euro-resiliency-special-event-page/Old_SEP.png)

It was a very simple page (No background, only the two teams and two buttons were displayed), but it served its purpose.
For every soccer evening, we would handle far more traffic than what we usually handled : And if each one of these users would load a personalized homepage, search for a program, navigate around the app and do all kind of other actions, then it wouldn't take long for our backend servers to explode under the pressure. Each user that saw that Special Event page and clicked on the Live button was one that was immediately redirected to their content, without any kind of backend call. It was a very simple solution, but it worked and allowed us to alleviate a lot of the pressure we'd have otherwise faced.

However, this was far from a perfect solution, as it presented a few issues that we needed to fix in order to be ready for the Euro 2024 :
- This page was entirely managed by the Web team. Our customer did not have any input on it, if they wanted to make a change they'd have to request it, and we'd then have to deploy it on our side, preventing any last-minute modifications. We needed a process that could be documented, followed, and would allow lightning-fast modifications to the Special Event page.
- As it was only managed by the Web team, the traffic generated by phones and TVs did not benefit from this feature. This was a major issue, as these devices (Especially TVs) were the ones that generated the most traffic during these events. We needed a new solution that could impact all platforms, not just the Web.
- It was overall not pretty ðŸ˜… : We ourselves weren't really huge fans of the old page, we wanted a new one that'd be more âœ¨ *shiny* âœ¨

With all of these in mind, we began in the end of 2023 to create what would be the new Special Event Page.

## Attack plan

One of our first goal was to make sure that every platform, every device, would get access to that feature. If we wanted to be able to resist to as much traffic as possible, we'd have to reach as many users as possible. For this reason, we decided to opt for a backend-first strategy : Ideally the work on different fronts would be minimal, and our backend would be responsible to handle and answer the Special Event page whenever it is needed.

After consideration, we decided to opt for a Cookie-based solution. When one of our front would request the homepage, for example, the request would first be caught by our CDN. It'd check for the existence of a given Cookie (That we could call `special-event`) : If the cookie was present, then the user already saw the special event and we'd let the request go through. If the cookie was not present, then we'd return the Special Event page to the user, along with a new `Set-Cookie` header that would save that cookie to the user's device, preventing them from seeing the Special Event page again for a given duration.
The Special event page content would be a simple static JSON file, hosted in the cloud, that we would then be able to edit on the fly without bothering the frontend teams.

![Request/Response graph showing the CDN send a Special Event page to a request without cookie, and the usual page if the cookie is present](/images/posts/2024-08-14-euro-resiliency-special-event-page/Request_Response_graph.png)

With this solution, we also reaped another benefit : Phone apps. When a new version of the application is released, not everyone always updates theirs. We could require an update, but often it translates into a slight portion of our audience choosing to uninstall the app instead, so that's a mean we wish to avoid as much as possible. With the solution described above, managing everything using nothing but cookies and http headers meant that not a single line of code needed to be written by our frontend teams, so no new app version was needed !

However, it wasn't perfect either.

## Web issues : Cookies and SSR

The first issue we encountered, we probably should've guessed earlier that it would happen : Cross-domain cookies. While cookies work wonders when they are set by the same domain that's using them, here, our cookies were set on [6play.fr](https://www.6play.fr/) by the domain [6cloud.fr](https://layout.6cloud.fr). At first, when we tested locally, this wasn't an issue. 

However, nowadays, as a mean to ensure users privacy, most browsers block these kind of cookies to prevent cross-domain tracking : While our cookies weren't trying to gather anything from our users, they were blocked nonetheless ! With no existing way of indicating that this was a functional cookie (As it'd otherwise probably be abused by these exact tracking tools that browsers aim to block ðŸ˜…), we had to find another solution specifically for the Web. We ended up having to code a second logic on the Web code itself, detecting whenever a Special Event page was displayed and setting a cookie from the website itself, to prevent this third-party cookie blocking. Even though this required a bit more code, this ended up working like a charm for the web.

The second issue we encountered was with Server-Side Rendering, that the Web (Again !) use plenty. When a page is requested, the SSR first renders the page on the server, and serves it to the client : It allows a user to see an immediate result, while their own device is processing the page. That result is also served to web crawlers (Such as Google SEO robots !). However, SSR doesn't support cookies (As it's not a real browser) : With no way of saving the cookie, that meant that as long as the Special Event would be enabled, each and every user would see the Special Event page for a split second, and it'd completely break our SEO ! In order to prevent that issue, we had to whitelist the IP address of our servers, in order to specify to our CDN not to send it the Special Event page under any circumstances.

## Final result

With all of these issues now finally behind us, the Special Event was ready to be released. We prepared the config files in our cloud server, configured the last details for the cookie duration, and voilÃ  !

![Photo of the new Special Event page, in 2024](/images/posts/2024-08-14-euro-resiliency-special-event-page/New_SEP.png)

As soon as the feature came live, we could instantly see the impact it had on our traffic, with the pressure on our servers diminishing drastically. 

![Graph displaying the proportion of Special Event page distributed](/images/posts/2024-08-14-euro-resiliency-special-event-page/SEP_stat_display.png)
# // AccÃ¨s a ces graphs nÃ©cessaires : https://onenr.io/0dQez7brZwe / https://onenr.io/0MR2zYVZaRY

While the Special Event page was a success, allowing us to reduce a lot the incoming traffic on our backend servers, it was not the only feature that we developed to prepare for such a massive event. We also worked on quite a few topics, such as the [layout at edge](LINK TO DO), or a huge workshop on a way to [load-test efficiently our services](LINK TO DO). Check these articles out to find out more about what it takes to prepare for such a massive event !

# Remplacer les liens par des trucs corrects

