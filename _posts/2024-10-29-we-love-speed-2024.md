---
layout: post
title: We love speed 2024 â¤ï¸
description: How did we improve the monitoring practices on the mobile service? Let's find out.
author: [ j_nginn, j_poissonnet ]
tags: [ monitoring, production, newrelic, shared practice, alerting ]
color: rgb(251,87,66)
language: fr
thumbnail: "TODO"
---

# We love speed â¤ï¸

Cette annÃ©e, nous avons eu la chance de participer Ã  la confÃ©rence We love speed, une confÃ©rence annuelle axÃ©e sur la
performance du web.
Etant donnÃ© que câ€™est un domaine qui nous passionne <insÃ©rer le lien dâ€™un article qui en parle ?>, nous sommes trÃ¨s
content dâ€™avoir pu y assister.
Le thÃ¨me de cette annÃ©e, câ€™est lâ€™INP. En effet, cette mÃ©trique de performance a Ã©tÃ© ajoutÃ©e aux core web vitals par
Google rÃ©cemment https://developers.google.com/search/blog/2023/05/introducing-inp?hl=fr
Lâ€™idÃ©e de cette mÃ©trique est de se rapprocher de lâ€™expÃ©rience de lâ€™utilisateur envers la rÃ©activitÃ© dâ€™une application
web. Cette mÃ©trique observe le temps entre une interaction utilisateur et une rÃ©ponse visuelle de notre interface.

## HTMX

Lors de ce talk, il nous a Ã©tÃ© prÃ©sentÃ© un outil trÃ¨s intÃ©ressant pour amÃ©liorer lâ€™expÃ©rience utilisateur dâ€™une
application web sans effectuer de grosses modifications.
Il s'agit de HTMX, c'est une bibliothÃ¨que Javascript qui permet dâ€™amÃ©liorer lâ€™expÃ©rience utilisateur en ajoutant des
fonctionnalitÃ©s de type SPA (Single Page Application) Ã  une application web classique et de faÃ§on non intrusive.
Par exemple, on peut charger un CDN de maniÃ¨re asynchrone, ou encore charger des images en avance.
Câ€™est-a-dire que si HTMX venait Ã  ne pas dÃ©marrer, votre application web se comporterait de la mÃªme maniÃ¨re, mais sans
les amÃ©liorations de temps dâ€™interaction.
HTMX surcharge la maniÃ¨re dont vos liens et images vont Ãªtre chargÃ©s par le navigateur.
Ainsi, lors de la prochaine interaction avec le navigateur, ce dernier sera dÃ©jÃ  prÃªt Ã  servir les ressources.
Le principe de HTMX consiste Ã  ajouter des balises HTML spÃ©cifiques dans le DOM qu'il va lire et en dÃ©duire les
comportements Ã  son chargement.
Cette manipulation est appelÃ© le "DOM morphing". GrÃ¢ce Ã  ce processus le temps de chargement est rÃ©duite et on Ã©vite
l'effet "blink" (page blanche lors du chargement de la page).
Il est Ã  noter que ces comportements ne sont quâ€™un embellissement proposÃ© par HTMX, il est tout Ã  fait possible
dâ€™ajouter par exemple lâ€™attribut `preload` sur une balise `a` pour demander le chargement en avance du lien par le
navigateur.

> <div style="display: flex">
> <img src="https://ca.slack-edge.com/T108ZKPMF-U01FQRQ8FT7-dfb12b21fb0d-192" style="border-radius: 50%; height: 30px; margin: 10px">
> Comme nous utilisons React pour notre application, l'utilisation de HTMX n'est pas vraiment utile.
> Il est dÃ©jÃ  possible avec React de prÃ©charger les ressources en avance. Mais Ã§a reste un outil intÃ©ressant.
> </div>

## INP vs JS

Le deuxiÃ¨me talk a une place particuliÃ¨re dans notre cÅ“ur â¤ï¸ puisquâ€™il a Ã©tÃ© donnÃ© par notre cher Jean-Pierre Vincent,
qui a auditÃ© les performances du web de Bedrock il y a deux ans. Câ€™Ã©tait trÃ¨s intÃ©ressant de voir les principes que JP
sâ€™adonne Ã  inculquer impactÃ© cette nouvelle mesure quâ€™est lâ€™INP. Un de ces principes est dâ€™Ã©viter le plus possible la
dÃ©ferlante de Javascript que vos utilisateurs reÃ§oivent au chargement de votre site.
![JS Tsunami storming your users](/images/posts/2024-10-29-we-love-speed-2024/js_tsunami.jpeg)
Lâ€™idÃ©e avec lâ€™INP est de mesurer lâ€™incapacitÃ© du navigateur Ã  rÃ©agir. AprÃ¨s avoir rÃ©cupÃ©rÃ© des mesures, il est bon de
se rappeler quâ€™il y a un biais de selection pour les donnÃ©es de Crux, en effet il nâ€™est calculÃ© que sur les appareils
Google (câ€™est le principe). Une fois quâ€™on a rÃ©coltÃ© des mÃ©triques de performance de nos utilisateurs, si on veut
travailler sur notre site web et avoir une bonne idÃ©e du ressenti de nos utilisateurs, lâ€™idÃ©al est de tester avec un
vÃ©ritable Samsung S8
Lâ€™INP est une mÃ©trique qui peut Ãªtre influencÃ©e par des interactions que ne sont pas prÃ©vues par les devs. Câ€™est
pourquoi il est important de se baser sur des donnÃ©es utilisateurs, car on est trÃ¨s souvent Ã©tonnÃ© de voir que quand les
temps de chargement sont un poil trop long Ã  leur goÃ»t ils se mettent Ã  cliquer partout. ğŸ¤·
![INP est bousculÃ© par la charge de js!](/images/posts/2024-10-29-we-love-speed-2024/inp_charge.jpeg)
ï¿¼

Parmi les bonnes pratiques quâ€™on peut appliquer dÃ¨s maintenant, et qui je dois le dire mâ€™a paru un peu contre-intuitif :
Faire passer Babel sur les node_modules.
En fait, du point de vue dâ€™un dÃ©veloppeur, on peut se dire que cela va augmenter les temps de build drastiquement, et on
aurait surement raison. Mais en fait il faut voir le bÃ©nÃ©fice quâ€™il y a derriÃ¨re. Si on personnalise les rÃ¨gles Babel
pour quâ€™elles correspondent aux navigateurs de nos utilisateurs on sâ€™Ã©vite des transformations inutiles qui plomberaient
le poids de nos fichiers Javascript.

Une Ã©volution du framework React permet de crÃ©er des Server Components, ce qui est trÃ¨s intÃ©ressant du point de vue de
la rÃ©duction du Javascript. Vous lâ€™aurez compris, câ€™est lâ€™ennemi numÃ©ro 1 de JP (et de vos navigateurs). Les React
Server Components câ€™est vraiment bien, lâ€™idÃ©e est de rendre les composants cÃ´tÃ© serveur et de faire en sorte que ces
derniers ne rendent que du HTML, qui ne sera pas hydratÃ© cÃ´tÃ© client. Lâ€™Ã©tape de rÃ©hydratation est une Ã©tape importante
et trop souvent sous-estimÃ©e. Il sâ€™agit dâ€™une nouveautÃ© de React qui est prometteuse, et qui est dÃ©jÃ  prÃ©sent dans
Next.js.

Un exemple dâ€™abus de Javascript qui a Ã©tÃ© montrÃ© pendant la prÃ©sentation se trouve Ãªtre du code de chez nous ğŸ˜…. Il
sâ€™agit dâ€™un flamegraph du rendu de notre Footer. Il est consÃ©quent parce que nous faisons ce quâ€™on appelle du CSS-in-JS.
Vous lâ€™avez devinez, câ€™est la partie in-JS le problÃ¨me. Cela signifie que pour appliquer du style sur notre site, câ€™est
le Javascript qui sâ€™en charge, or dans un composant comme le Footer, il y a beaucoup dâ€™Ã©lÃ©ments, et chaque Ã©lÃ©ment va
avoir besoin de son style. Si lâ€™idÃ©e de colocaliser le CSS dans le JS nâ€™est pas nocive en soit, le problÃ¨me que nous
avons câ€™est que nous utilisons Styled-Components, qui calcule le style au moment du rendu, le rendant donc plus long.
FYI: nous avons chez Bedrock entamÃ© une migration pour quitter Styled-Components au profit de Linaria  
![Flamegraph du Footer de Bedrock](/images/posts/2024-10-29-we-love-speed-2024/flamgraph.jpeg)
ï¿¼

Autre information qui nous concerne Ã  Bedrock, nous sommes au moment dâ€™Ã©crire ces lignes en train de mettre en
production la migration de React 17 vers React 18. Dâ€™aprÃ¨s les retours dâ€™expÃ©rience de JP, React 18 est bon pour lâ€™INP
car il permet de faire moins de render.

Enfin, Jean-Pierre nous laisse avec un ultime conseil pour que nos applications web soient pÃ©rennes : â€œMonitore (au
moins une fois dans ta vie) lâ€™origine des INP avec un vrai user.â€

## Performance with devtools

Avoir un Å“il sur ses performances, câ€™est essentiel pour pouvoir avancer dans la bonne direction et sâ€™assurer quâ€™on
fournit Ã  nos utilisateurs une expÃ©rience optimale. Fort heureusement pour nous les devs, on est bien lotis avec de trÃ¨s
bons outils. Il suffit dâ€™ouvrir les chrome devtools pour sâ€™en rendre compte.

When profiling use throttling !!!! (At best use remote debugging and screen casting)
Use actual devices ffs
You can add label/diagram/time range annotations in the flamegraph
CUSTOM TRACKS TO THE MOON

- with user timing api

ï¿¼
Insight is a really nice feature of devtools
Especially layout shift insights
ï¿¼
??? Speculation Rules ???
Ai explained error message in console !
â€¢ Page prerendering
â€¢ Local overrides + header overrides
â€¢ Speculation rules debugging
â€¢ Snippets
DÃ©jeuner
Abtasty câ€™Ã©tait pas bien il y a un moment - Antoine de Fastly

## How I made the web faster with INP

ï¿¼
"When I get back to work, I'll have to check how my website handles event tracking calls to analytics platforms."
Custom properties cause style recalculation in the presentation step
You can disable the inheritance with JS on the CSS properties
Jake archibald - in the loop

## Web perf testing

Lighthouse CI - run lighthouse inside the CI to integrate the web performance test in the dev phase instead of after
deployment
![Key takeaways from the talk](/images/posts/2024-10-29-we-love-speed-2024/Key%20Takeaways.jpeg)
ï¿¼

## How browsers really load pages

ï¿¼
Use preload with surgical precision
![Preload with surgical precision](/images/posts/2024-10-29-we-love-speed-2024/preload_surgical.jpeg)
ï¿¼
If you're loading 5MB of JavaScript without a CDN, you have bigger problems than just tight mode messing up!
Mais que fait la police ?!
ï¿¼
On peut optimiser les fonts de fallback
ï¿¼
On peut rÃ©aliser des subsets de font pour Ã©viter de tÃ©lÃ©charger tous les glyphes dans une font (en franÃ§ais on a besoin
que de 165 glyphes la ou les tables latin en exposent 528)
Ressource : Font subsetter / fontttools / glyphanger
![Say no to tofu](/images/posts/2024-10-29-we-love-speed-2024/tofu.jpeg)
ï¿¼
Pour minimiser le nombre de fichier, on peut utiliser des polices variables
Encore une fois, via un outil un peut subsetter les variations.
