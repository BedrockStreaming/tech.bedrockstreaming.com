<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://tech.bedrockstreaming.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://tech.bedrockstreaming.com/" rel="alternate" type="text/html" /><updated>2022-08-08T09:15:47+00:00</updated><id>https://tech.bedrockstreaming.com/feed.xml</id><title type="html">Bedrock Tech Blog</title><subtitle>Blog technique de Bedrock</subtitle><entry><title type="html">How to ingest 400GB of logs per hour?</title><link href="https://tech.bedrockstreaming.com/2022/08/08/private-cdn-logs.html" rel="alternate" type="text/html" title="How to ingest 400GB of logs per hour?" /><published>2022-08-08T00:00:00+00:00</published><updated>2022-08-08T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/2022/08/08/private-cdn-logs</id><content type="html" xml:base="https://tech.bedrockstreaming.com/2022/08/08/private-cdn-logs.html">&lt;p&gt;Bedrock Streaming is a company that sells a white labeled streaming and live platform. Our customers are media groups, TV channels, and streaming companies. Our goal is to deliver a state-of-the-art streaming platform to our customers.&lt;/p&gt;

&lt;p&gt;To achieve this goal, we have our own Content Delivery Network (CDN), made of several bare metal servers racked in our Data Centers. Those servers run Nginx and are designed to output hundreds of Gbps (several tens of Pb per month) to end-users. We use them to cache video content at our infrastructure‚Äôs edge.&lt;/p&gt;

&lt;p&gt;This increases efficiency of the platform 96 times out of 100, as video traffic doesn‚Äôt have to flow all the way through our infrastructure, and improves user experience as it serves video faster. Also, it diminishes the cost of our Video On Demand (VOD) infrastructure as we need less servers in VOD Stack.&lt;/p&gt;

&lt;p&gt;This in-turn increases end-users (clients of our customers) satisfaction with the service.&lt;/p&gt;

&lt;h2 id=&quot;who-needs-to-ingest-400gb-of-logs-per-hour-anyway&quot;&gt;Who needs to ingest 400GB of logs per hour anyway?&lt;/h2&gt;
&lt;p&gt;Every time someone watches a video, it generates traffic on our CDN, resulting in a lot of access logs. Without filtering, it averages to 400GB uncompressed logs per hour.&lt;/p&gt;

&lt;p&gt;This is why, at first, we chose to not log 2XX or 3XX HTTP codes. We had too many of them, and we considered them not as worth it as 4XX and 5XX. The 4XX and 5XX can be especially useful for debugging a particular situation or, from a broader perspective, improving the user experience.&lt;/p&gt;

&lt;p&gt;This was the kind of Nginx configuration we had deployed:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;map $status $loggable {
    ~^[23]  0;
    default 1;
}
access_log /path/to/access.log combined if=$loggable;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;giving-autonomy-for-all-teams-on-logs&quot;&gt;Giving autonomy for all teams on logs&lt;/h2&gt;

&lt;p&gt;At the end of 2021, the finance team approached us with a challenge: how to bill our customers based on their end-users CDN usage?
This was in fact a need we already anticipated, we tried the nginx module &lt;a href=&quot;https://www.nginx.com/resources/wiki/modules/traffic_accounting/&quot;&gt;Traffic_accounting&lt;/a&gt;, but it did not satisfy us fully. This module calculates and exposes metrics on-the-fly, which is CPU and memory intensive, especially above 50Gbps of traffic per server.&lt;/p&gt;

&lt;p&gt;We also had another objective that wasn‚Äôt addressed with the nginx module. We needed to give autonomy to QA, Video, Data, and Finance teams. We wanted to allow them to use CDN logs when they needed without having to ask for it, and ideally in a practical and unified way.&lt;/p&gt;

&lt;p&gt;The company philosophy states that we are user obsessed and that we do not finger point. We work as a team to offer the best user experience, this is why we make all our logs available to all teams. We didn‚Äôt come around to do it for the CDN as the volume of logs was too much of a constraint.&lt;/p&gt;

&lt;h2 id=&quot;technical-solution&quot;&gt;Technical Solution&lt;/h2&gt;

&lt;p&gt;At Bedrock, we like to keep things simple. We think our CDN main mission is to serve video as efficiently as possible. Our CDN‚Äôs servers can‚Äôt keep PetaBytes of logs on their disks. This is why we chose to output logs to Amazon S3.&lt;/p&gt;

&lt;p&gt;The real benefit to using S3 is that you can easily plug it into Glue and Athena which allows you to request TeraBytes of data easily.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-08-08-privateCdnLogs/image1.png&quot; alt=&quot;technical Solution&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;sending-logs-to-s3-vector&quot;&gt;Sending logs to S3: Vector&lt;/h3&gt;

&lt;p&gt;To send logs from our CDN servers to Amazon S3 bucket, we had many options, but chose to test two approaches: &lt;a href=&quot;https://www.fluentd.org/&quot;&gt;Fluentd&lt;/a&gt; and &lt;a href=&quot;https://vector.dev/&quot;&gt;Vector&lt;/a&gt;. Fluentd is the legacy one, and Vector the new rusty one.&lt;/p&gt;

&lt;p&gt;After a quick evaluation, we decided to go with &lt;a href=&quot;https://medium.com/ibm-cloud/log-collectors-performance-benchmarking-8c5218a08fea&quot;&gt;Vector as it seemed more memory efficient&lt;/a&gt; and output more Logs Per Second under heavy load than Fluentd.&lt;/p&gt;

&lt;center&gt;&lt;img alt=&quot;Log per second&quot; src=&quot;/images/posts/2022-08-08-privateCdnLogs/image4.png&quot; /&gt;&lt;/center&gt;
&lt;center&gt;Source: &lt;a href=&quot;https://medium.com/ibm-cloud/log-collectors-performance-benchmarking-8c5218a08fea&quot; target=&quot;blank&quot;&gt;Who is the winner ‚Äî Comparing Vector, Fluent Bit, Fluentd performance from Ajay Gupta&lt;/a&gt;&lt;/center&gt;
&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;We have Nginx and Vector installed on the CDN servers. Nginx now outputs all the access logs to a file. Vector reads the file, compresses logs to GZIP format and every 10Mb sends the logs to S3. Nginx may generate at peak 600GB of logs; we only send 10GB.&lt;/p&gt;

&lt;p&gt;Those logs are then locally cleaned by Logrotate.&lt;/p&gt;

&lt;h3 id=&quot;storing-logs-s3&quot;&gt;Storing logs: S3&lt;/h3&gt;
&lt;p&gt;We chose to store logs on an S3 bucket. We figured it was the most scalable and time efficient. S3 buckets can grow to PetaBytes easily. It is a few terraform lines away, this is convenient as we handle all our infrastructure with Terraform.&lt;/p&gt;

&lt;p&gt;We configured our bucket to use several lifecycle policies. One to automatically clean logs after 365 days, another to remove incomplete uploads, and another one to immediately remove files with a delete marker. Also, we configured the storage class in &lt;em&gt;intelligent tiering mode&lt;/em&gt; to store logs according to their access frequency.&lt;/p&gt;

&lt;p&gt;This will permit us to diminish the cost of our S3 bucket and not have an ever-increasing S3 bill.&lt;/p&gt;

&lt;h3 id=&quot;partitioning-logs-on-s3-lambda-stack&quot;&gt;Partitioning logs on S3: Lambda stack&lt;/h3&gt;

&lt;p&gt;Once logs are stored in S3 bucket, we need to classify and sort them in order to extract valuable intel. At Bedrock, we already use a modified version of a lambda stack, that does just that. Originally designed for Cloudfront, we have been using it also for Fastly and now for our Private CDN. You can find the original version at &lt;a href=&quot;https://github.com/aws-samples/amazon-cloudfront-access-logs-queries&quot;&gt;AWS Sample Github&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We have 2 different parts in this lambda stack.&lt;/p&gt;

&lt;center&gt;&lt;img alt=&quot;Move Acess Logs&quot; src=&quot;/images/posts/2022-08-08-privateCdnLogs/image3.png&quot; /&gt;&lt;/center&gt;
&lt;center&gt;source: &lt;a href=&quot;https://github.com/aws-samples/amazon-cloudfront-access-logs-queries/blob/mainline/images/moveAccessLogs.png&quot; target=&quot;blanck&quot;&gt;moveAccessLogs&lt;/a&gt;&lt;/center&gt;
&lt;p&gt;&lt;br /&gt;
The first part is called by S3 Event when a new file is pushed to a specific path. This lambda moves the file to a path assigned per server and per hour. This way, logs are stored for each server, each month, each day and each hour in a separate prefix.&lt;/p&gt;

&lt;center&gt;&lt;img alt=&quot;Transform Partition&quot; src=&quot;/images/posts/2022-08-08-privateCdnLogs/image2.png&quot; /&gt;&lt;/center&gt;
&lt;center&gt;source: &lt;a href=&quot;https://github.com/aws-samples/amazon-cloudfront-access-logs-queries/blob/mainline/images/transformPartition.png&quot; target=&quot;blank&quot;&gt;transformPartition&lt;/a&gt;&lt;/center&gt;
&lt;p&gt;&lt;br /&gt;
Then, another lambda transforms logs into &lt;a href=&quot;https://parquet.apache.org/&quot;&gt;Parquet format&lt;/a&gt;. Parquet is an open source format from the Apache Foundation. It is commonly used in big data. It takes up little space and is very effective.&lt;/p&gt;

&lt;p&gt;We chose to use AWS glue in order to create a database of our logs. The columns of the table are based on our log format. We can then request everything we want in Athena.&lt;/p&gt;

&lt;center&gt;&lt;img alt=&quot;Athena Query&quot; src=&quot;/images/posts/2022-08-08-privateCdnLogs/image5.png&quot; /&gt;&lt;/center&gt;

&lt;p&gt;We are now capable of extracting the bytes sent from a particular virtual host and sum it over a month for all CDN servers to bill our customers.
Those logs are now available for all the teams who may need them to improve their application or to debug an issue they are facing.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;We chose &lt;a href=&quot;https://vector.dev/&quot;&gt;Vector&lt;/a&gt; to transport our private CDN logs to an S3 Bucket. Then, we chose to reuse an AWS Stack using Lambda and Glue to extract information from these logs, asynchronously. This stack is used in production for several months on other projects.
All the teams that needed to extract value from our CDN logs are now autonomous to do so. We are now able to bill our customers based on their CDN usage.&lt;/p&gt;</content><author><name>Arthur Zinck</name></author><category term="onprem" /><category term="cdn" /><category term="logs" /><category term="aws" /><category term="cloud" /><category term="nginx" /><category term="vector" /><category term="lambda" /><category term="s3" /><category term="glue" /><category term="athena" /><summary type="html">At Bedrock, we have a CDN that outputs on average 400GB of uncompressed logs per hour. In this article, we present the architecture we have setup to collect these logs and extract value from them.</summary></entry><entry><title type="html">Retour sur la conf√©rence MiXiT 2022</title><link href="https://tech.bedrockstreaming.com/2022/07/28/retour-sur-mixit-2022.html" rel="alternate" type="text/html" title="Retour sur la conf√©rence MiXiT 2022" /><published>2022-07-28T00:00:00+00:00</published><updated>2022-07-28T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/2022/07/28/retour-sur-mixit-2022</id><content type="html" xml:base="https://tech.bedrockstreaming.com/2022/07/28/retour-sur-mixit-2022.html">&lt;p&gt;&lt;img src=&quot;/images/posts/mixit-crepes.jpg&quot; alt=&quot;&amp;quot;MiXiT, la conf√©rence avec des cr√™pes et du c≈ìur&amp;quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mixitconf.org/&quot;&gt;MiXiT&lt;/a&gt; est une conf√©rence ‚Äúavec des cr√™pes et du c≈ìur‚Äù qui se d√©roule √† Lyon. Les sujets sont assez vari√©s abordant autant l‚Äôagilit√©, que la programmation, le droit ou encore l‚Äôhistoire de l‚Äôinformatique.&lt;/p&gt;

&lt;p&gt;Voici un r√©sum√© des conf√©rences de l‚Äô√©dition 2022 qui nous ont le plus marqu√©es.&lt;/p&gt;

&lt;h2 id=&quot;how-to-build-the-alert-system-that-france-deserves&quot;&gt;How to build the alert system that France deserves?&lt;/h2&gt;

&lt;p&gt;Ga√´l Musquet nous a d‚Äôabord expliqu√© le r√¥le de Gustave Ferri√©, qu‚Äôil consid√®re comme le premier hacker, qui a install√© des m√¢ts de t√©l√©graphe sans fil en 1902, entre les √©metteurs en Martinique, pour remplacer le c√¢ble t√©l√©graphique, d√©truit lors de la catastrophe de la montagne Pel√©e du 8 mai 1902. Cet homme avait saisi l‚Äôint√©r√™t d‚Äôavoir un syst√®me de communication fiable.&lt;/p&gt;

&lt;p&gt;Ga√´l Musquet nous explique ce qu‚Äôon est en droit d‚Äôattendre en 2022 d‚Äôun pays moderne, concernant les alertes sur les risques majeurs, qui varient selon notre emplacement (du tsunami √† la rupture de barrage artificiel).&lt;/p&gt;

&lt;p&gt;Il nous incite √† lire le DICRIM de notre ville (&lt;a href=&quot;https://www.lyon.fr/sites/lyonfr/files/content/documents/2021-02/risque-majeurs-DICRIM-ALEX-25-01-2021.pdf&quot;&gt;celui de Lyon&lt;/a&gt;) ainsi qu‚Äô√† nous procurer un poste de radio √† piles, car dans l‚Äô√©ventualit√© d‚Äôun moment catastrophique sans Internet et sans satellites, comment ferons-nous pour nous tenir au courant de ce qu‚Äôil faut faire pour rester en vie ?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mixitconf.org/2022/how-to-build-the-alert-system-that-france-deserves-&quot;&gt;Page du talk sur le site de MiXiT et voir le replay&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;meet-null-the-unknown&quot;&gt;Meet NULL the UNKNOWN&lt;/h2&gt;

&lt;p&gt;Dans cette conf√©rence, La√´tiia Avrot entame un rappel de la norme SQL, que PostgresQL impl√©mente au plus pr√®s, sur la valeur de NULL en SQL. Et la valeur UNKNOWN est √©galement abord√©e. Notamment la complexit√© induite par le fait qu‚Äôun champ de type Boolean peut se retrouver avec comme valeurs possibles : True, False, UNKNOWN et NULL. Cela donne un syst√®me √† quadruple valeur. Pour un champ typ√©.&lt;/p&gt;

&lt;p&gt;NULL est plus facile √† d√©finir par ce qu‚Äôil n‚Äôest pas qu‚Äôen expliquant ce qu‚Äôil est.
Une option int√©ressante pour mettre en √©vidence la valeur NULL dans PostgresQL est d‚Äôen d√©finir nous-m√™me une valeur affich√©e.&lt;/p&gt;

&lt;p&gt;Ensuite, La√´titia nous propose un Quizz. Sur une base de donn√©es qu‚Äôon conna√Æt, chaque fois la m√™me question est pos√©e sur ‚ÄúCombien de lignes vont √™tre retourn√©es par la requ√™te SQL ?‚Äù&lt;/p&gt;

&lt;p&gt;C‚Äôest int√©ressant, car chaque question comporte un degr√© de complexit√© √©lev√© impliquant l‚Äôusage de la valeur NULL, tout en suivant la logique de la norme SQL. Cerise sur le g√¢teau, La√´titia propose en ‚ÄúR√©ponse D‚Äù, le nom d‚Äôune scientifique c√©l√®bre et nous en donne une courte biographie √† chaque question.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;Liens&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://mydbanotebook.org/&quot;&gt;Blog de l‚Äôoratrice, La√´titia Avrot&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://mixitconf.org/2022/meet-null-the-unknown&quot;&gt;Page du talk sur le site de MiXiT et voir le replay&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;parlez-de-vous-faites-des-feedbacks&quot;&gt;Parlez de vous, faites des feedbacks&lt;/h2&gt;

&lt;p&gt;Le feedback est un outil communicationnel qui permet de formuler un avis sur une situation pass√©e dans le but de g√©rer les situations futures.&lt;/p&gt;

&lt;p&gt;On peut trouver plusieurs formes de feedbacks :
le feedback est √† destination de la personne, pour l‚Äôaider √† s‚Äôam√©liorer. Elle peut d√©cider de le suivre ou non,
la demande que l‚Äôon fait √† quelqu‚Äôun est √† notre b√©n√©fice (on demande √† la personne de changer un comportement qui nous g√™ne) en laissant la possibilit√© √† la personne de d√©cider si elle veut ou non r√©pondre favorablement √† cette demande,
l‚Äôexigence qui est aussi √† notre b√©n√©fice, mais pour laquelle on ne laisse pas le choix (dans le cadre d‚Äôune relation hi√©rarchique)&lt;/p&gt;

&lt;p&gt;Julie Quilli√© propose un mod√®le de feedbacks bas√© sur la CNV (Communication Non Violente) et qui peut se r√©sumer de la mani√®re suivante.&lt;/p&gt;

&lt;h3 id=&quot;feedback-bas√©-sur-la-cnv-communication-non-violente&quot;&gt;Feedback bas√© sur la CNV (Communication Non Violente)&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;On v√©rifie la disponibilit√© de la personne en lui demandant si elle est d‚Äôaccord pour qu‚Äôon lui fasse des feedbacks et sous quelle forme.&lt;/li&gt;
  &lt;li&gt;On formule le feedback :
  D√©crire une Observation, les faits (= pas de jugement)
  Exprimer le Sentiment que cette situation a engendr√©
  Expliquer le Besoin qui est la source du sentiment ressenti
  et finir par faire une Demande (= r√©alisable, formul√©e positivement, pr√©cise)&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;Un exemple :&lt;/strong&gt;
  Nous avions rendez-vous √† 12h et il est 12h30 = observation, factuel.
  Je suis tr√®s f√¢ch√© car je m‚Äô√©tais organis√© pour √™tre √† l‚Äôheure = le sentiment
  C‚Äôest important pour moi de ne pas perdre de temps et de pouvoir rester libre dans mon organisation = le besoin
  La prochaine fois que tu sais que tu seras en retard, peux-tu stp m‚Äôappeler d√®s que possible pour me le signaler ? De cette mani√®re, je peux me r√©organiser facilement. = la demande&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;On v√©rifie ce qui a √©t√© re√ßu par la personne. On lui propose de nous reformuler ce qu‚Äôelle en a retenu. Cela permet de v√©rifier que le message que l‚Äôon voulait faire passer a bien √©t√© entendu.&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;2√®me-possibilit√©-pour-faire-un-feedback--le-feedback-en-4-temps&quot;&gt;2√®me possibilit√© pour faire un feedback : le feedback en 4 temps&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;On demande √† la personne ce qu‚Äôelle a aim√© dans ce qu‚Äôelle vient de faire&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;On lui demande ensuite ce qu‚Äôelle aurait aim√© faire diff√©remment&lt;/p&gt;

    &lt;p&gt;On lui demande si elle veut qu‚Äôon lui donne notre feedback&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;em&gt;‚ÄúMoi, j‚Äôai aim√© ‚Ä¶, parce que ‚Ä¶ ‚Äù&lt;/em&gt; : on parle de ce que √ßa nous a apport√© (clart√©, motivation, inspiration, soutien, etc.)&lt;/li&gt;
  &lt;li&gt;&lt;em&gt;‚ÄúEt j‚Äôaurais aim√© ‚Ä¶  de diff√©rent, parce que ‚Ä¶ ‚Äù&lt;/em&gt; on parle de ce que √ßa nous apporterait (clart√©, motivation, inspiration, soutien, etc.)&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Et en bonus : ‚ÄúPeux-tu me dire comment tu re√ßois ce que je te dis ?‚Äù&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mixitconf.org/2022/parlez-de-vous-faites-des-feedbacks-&quot;&gt;Page du talk sur le site de MiXiT et voir le replay&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;arr√™tez-lauto-sabotage-et-sortez-de-la-boucle-syst√©mique&quot;&gt;Arr√™tez l‚Äôauto-sabotage et sortez de la boucle (syst√©mique)&lt;/h2&gt;

&lt;p&gt;Dans cet atelier, Albane Veyron nous explique que nous avons tous des croyances sur nous-m√™mes et sur les autres. Les croyances sont des pens√©es qui sont des v√©rit√©s, pour nous. Elles ont plusieurs origines : l‚Äôenfance, notre cercle social et notre exp√©rience de vie.&lt;/p&gt;

&lt;p&gt;Les croyances peuvent √™tre aidantes ou limitantes.&lt;/p&gt;

&lt;p&gt;L‚Äôatelier commence par une premi√®re phase qui consiste √† reconna√Ætre une de ses croyances limitantes :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;les g√©n√©ralisations : personne, tout le monde, toujours, tout le temps, jamais, trop, je dois, il faut, pas assez&lt;/li&gt;
  &lt;li&gt;les barri√®res infinies aka les bonnes excuses pour ne pas passer √† l‚Äôaction : j‚Äôaimerais, mais ‚Ä¶ / je pourrais, mais ‚Ä¶&lt;/li&gt;
  &lt;li&gt;les sensations de d√©j√† vu : les blocages et les situations r√©currentes&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Une fois qu‚Äôon a rep√©r√© une de ses croyances limitantes, on l‚Äô√©crit sur une feuille et on va ensuite d√©composer cette croyance et r√©fl√©chir √† :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;son origine : d‚Äôo√π nous vient cette croyance ? depuis combien de temps fait-elle partie de nous ? nous vient-elle de notre √©ducation ?&lt;/li&gt;
  &lt;li&gt;les b√©n√©fices : quels b√©n√©fices nous apporte cette croyance ? qu‚Äôest-ce qu‚Äôelle nous permet ?&lt;/li&gt;
  &lt;li&gt;les inconv√©nients / les freins : en quoi cette croyance nous g√™ne et quels sont les impacts sur notre vie (pro ou perso) ?&lt;/li&gt;
  &lt;li&gt;les contradictions : a-t-on d√©j√† fait quelque chose ou √©t√© dans une situation qui vient contredire cette croyance ?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;On va ensuite venir agr√©menter notre croyance avec tous ces √©l√©ments puis, pour finir, transformer notre croyance limitante en une croyance aidante.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mixitconf.org/2022/-arretez-l-auto-sabotage-et-sortez-de-votre-boucle-systemique-&quot;&gt;Page du talk sur le site de MiXiT et voir le replay&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;comment-fonctionne-un-gestionnaire-de-mots-de-passe&quot;&gt;Comment fonctionne un gestionnaire de mots de passe&lt;/h2&gt;

&lt;p&gt;Les mots de passe sont partout. Ils nous permettent d‚Äôacc√©der √† nos photos, nos comptes bancaires, nos documents de sant√© et bien d‚Äôautres donn√©es sensibles que l‚Äôon ne souhaite pas voir aux mains d‚Äôindividus que l‚Äôon ne conna√Æt pas.
Tout le monde sait que l‚Äôon doit avoir des longs mots de passe mais comment tous les retenir ? C‚Äôest l√† que les gestionnaires de mot de passe entrent en jeu. Mais peut-on leur faire confiance ? Comment √ßa marche au juste ? C‚Äôest √† cette question qu‚Äôa souhait√© r√©pondre Eric Daspet pendant sa conf√©rence.&lt;/p&gt;

&lt;p&gt;Le r√¥le d‚Äôun gestionnaire de mots de passe est de permettre √† son utilisateur d‚Äôutiliser qu‚Äôun seul mot de passe pour ensuite laisser l‚Äôoutil g√©n√©rer et m√©moriser tous les autres mots de passe. On a plus qu‚Äô√† retenir un seul mot de passe qui peut donc √™tre long et complexe. L‚Äôexercice de m√©moire sera alors moins compliqu√© que si on en avait plusieurs √† retenir.&lt;/p&gt;

&lt;p&gt;√Ä travers son expos√©, on d√©couvre un peu plus tous les proc√©d√©s de cryptographie utilis√©s afin de g√©rer les mots de passe que l‚Äôon va cr√©er ou modifier en utilisant ces outils.
Gr√¢ce √† de nombreux sch√©mas, il explique clairement les diff√©rentes √©tapes de chiffrements utilis√©es que ce soit pour la cr√©ation du mot de passe ma√Ætre, la cr√©ation et le changement des mots de passe, l‚Äôaffichage des mots de passe et m√™me le fonctionnement du partage de mots de passe (lorsque celui-ci existe dans l‚Äôoutil).&lt;/p&gt;

&lt;p&gt;On d√©couvre pendant cette heure que les gestionnaires de mots de passe ne cherchent pas √† r√©inventer la roue en mati√®re de cryptographie mais s‚Äôappuient sur des concepts d√©j√† √©prouv√©s et robustes. On apprend aussi que tout est chiffr√© de bout en bout et que seul celui qui d√©tient le mot de passe ma√Ætre (l‚Äôutilisateur donc, m√™me l‚Äôoutil ne le conna√Æt pas et n‚Äôen a pas besoin) peut interagir avec les mots de passe cr√©√©s. Rassurant, non ? En tout cas, me voil√† maintenant pr√™t √† expliquer autour de moi pourquoi il est grand temps de passer √† un gestionnaire de mot de passe !&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mixitconf.org/2022/comment-fonctionne-un-gestionnaire-de-mots-de-passe-&quot;&gt;Page du talk sur le site de MiXiT et voir le replay&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;optimiser-votre-revue-de-code-avec-le-rebase-interactif&quot;&gt;Optimiser votre revue de code avec le rebase interactif&lt;/h2&gt;

&lt;p&gt;GIT est un outil bien connu des d√©veloppeurs de nos jours, mais d√®s qu‚Äôon s‚Äô√©carte des commandes traditionnelles (checkout, commit et push), on sait bien moins ce que l‚Äôon peut faire d‚Äôautre avec.&lt;/p&gt;

&lt;p&gt;Sonia Seddiki nous explique ici comment rendre la revue de code, souvent longue et fastidieuse, plus simple et agr√©able pour nos coll√®gues avec quelques astuces qu‚Äôelle a partag√©es avec nous lors d‚Äôun live coding.
Contrairement √† l‚Äôid√©e que j‚Äôen avais, le rebase interactif n‚Äôest pas l√† que pour nettoyer les noms de commit sans aucun sens que j‚Äôavais mis dans la pr√©cipitation mais que c‚Äôest un outil bien plus puissant.&lt;/p&gt;

&lt;p&gt;Elle nous a ainsi montr√© comment elle utilise cette commande afin d‚Äôorganiser et de donner une chronologie √† son travail rendant ainsi la revue de code plus facile. Elle a ainsi, devant nos yeux, chang√© des fichiers de commits, r√©organis√© l‚Äôordre des commits et tout √ßa sans alt√©rer le code produit.&lt;/p&gt;

&lt;p&gt;√âvidemment, c‚Äôest une habitude √† prendre, elle-m√™me le souligne que ce n‚Äôest pas facile d‚Äôexporter cette bonne pratique au sein des √©quipes avec qui elle travaille. Mais la d√©monstration m‚Äôa convaincu, je vais m‚Äôessayer √† cette pratique et qui sait, un jour j‚Äôarriverai peut-√™tre √† mon tour √† convaincre des gens de mon √©quipe √† en faire de m√™me.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mixitconf.org/2022/optimisez-vos-revues-de-code-avec-le-rebase-interactif-&quot;&gt;Page du talk sur le site de MiXiT et voir le replay&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;violence-herm√©neutique---comment-√©viter-le-malaise&quot;&gt;Violence Herm√©neutique - Comment √©viter le malaise&lt;/h2&gt;

&lt;p&gt;Le MiXiT est aussi un √©v√®nement nous permettant d‚Äôouvrir notre esprit √† des connaissances qui sortent de notre quotidien. Cette conf√©rence anim√©e par Romeu Moura et Sara Dufour en fait partie. Ce talk nous fait d√©couvrir le concept d‚Äôherm√©neutique, d√©fini en d√©but de pr√©sentation comme √©tant ‚ÄúLa connaissance d‚Äôun concept permettant l‚Äôinterpr√©tation‚Äù. Si vous n‚Äôavez rien compris √† cette d√©finition √† ce stade, c‚Äô√©tait √©galement mon cas.&lt;/p&gt;

&lt;p&gt;Malgr√© cette introduction confuse, petit √† petit, en allant de plus en plus dans le d√©tail, des sujets apparaissent et donnent sens √† ce concept. On y parle de syst√©misme, de charge mentale, de patriarcat et autres syst√®mes de notre soci√©t√© dont l‚Äôexercice de compr√©hension va plus loin que leur simple mot ou leur d√©finition. L‚Äôherm√©neutique consiste √† comprendre les fondements et rouages d‚Äôun syst√®me, qu‚Äôon y appartienne ou non.&lt;/p&gt;

&lt;p&gt;Mais notre soci√©t√©, et l‚Äôhumain, tend √† compliquer cet exercice de compr√©hension de concept. C‚Äôest l√† qu‚Äôon arrive √† la notion de violence herm√©neutique, √† savoir tous les m√©canismes conscients et inconscients, syst√©miques ou non, internes ou externes, qui vont venir entraver et contraindre l‚Äôherm√©neutique. De r√©els freins √† la compr√©hension d‚Äôun syst√®me. Ils peuvent prendre plusieurs formes, comme la notion de norme, le fait de nier l‚Äôexistence d‚Äôun syst√®me ou de r√©futer un sujet du simple fait qu‚Äôil soit consid√©r√© tabou. On y retrouve √©galement la d√©formation de mots, et le fameux ‚Äúwokisme‚Äù.&lt;/p&gt;

&lt;p&gt;Il s‚Äôagit d‚Äôune conf√©rence passionnante, d√©rangeante et √©clairante que je conseille √† tous. Le d√©but pi√©tine un peu, mais le voyage en vaut la peine.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mixitconf.org/2022/violence-hermeneutique-comment-eviter-le-malaise-&quot;&gt;Page du talk sur le site de MiXiT et voir le replay&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;designer-pour-le-service-public&quot;&gt;Designer pour le service public&lt;/h2&gt;

&lt;p&gt;Cela peut faire un peu peur dit comme √ßa, mais je suis all√© sceptique √† cette conf√©rence d‚ÄôAnne-Sophie Tranchet. J‚Äô√©tais rattach√© √† une image peu flatteuse des outils du service public, alors que ces derniers ont connu une vraie progression ces derni√®res ann√©es. Anne-Sophie fait partie du programme beta.gouv qui intervient aupr√®s des administrations pour les services num√©riques.&lt;/p&gt;

&lt;p&gt;C‚Äôest arm√© des bonnes pratiques de nos m√©tiers que Beta.gouv a la mission de transformer et d‚Äôaccompagner les services publics. On y apprendra le parcours d‚ÄôAnne-Sophie, ce que travailler pour le service public veut dire, ainsi que les projets et challenges qui en d√©coulent. Leur m√©thodologie centr√©e utilisateur leur permet de travailler en it√©ration, et de d√©livrer de la valeur, en incubation d‚Äôabord, puis jusqu‚Äô√† un d√©veloppement national en fonction des retours sur le service.&lt;/p&gt;

&lt;p&gt;On peut citer quelques r√©alisations Beta.gouv comme la plateforme dossierfacile.com, qui facilite la cr√©ation de dossier pour une location, ou 1000 Premiers Jours, qui d√©livre des informations et un accompagnement sur la grossesse et les 2 premi√®res ann√©es de l‚Äôenfant&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mixitconf.org/2022/designer-pour-le-service-public&quot;&gt;Page du talk sur le site de MiXiT et voir le replay&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;nos-autres-conf√©rences-coup-de-coeur&quot;&gt;Nos autres conf√©rences coup de coeur&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://mixitconf.org/2022/ma-vie-est-un-ticket-eloge-de-la-communication-paresseuse-et-enjeux-pour-l-agilite-du-futur&quot;&gt;Ma vie est un ticket&lt;/a&gt; de Romain Couturier, une conf√©rence racont√© avec dessins l√©g√®re et qui donne des id√©es pour lutter contre la mauvaise utilisation des outils de ticketing&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://mixitconf.org/2022/tout-ce-que-l-on-ne-vous-dit-pas-sur-l-intelligence-artificielle-ia-&quot;&gt;Tout ce que l‚Äôon ne vous pas dit sur l‚ÄôIA&lt;/a&gt; de Am√©lie Cordier, une conf√©rence pleine d‚Äôhumour sur ce qu‚Äôest et n‚Äôest pas une IA&lt;/li&gt;
&lt;/ul&gt;</content><author><name>[&quot;s_haim&quot;, &quot;e_perrin&quot;, &quot;j_mastounga&quot;, &quot;s_zoccarato&quot;]</name></author><category term="conference" /><category term="agile" /><summary type="html"></summary></entry><entry><title type="html">Comment appliquer automatiquement des modifications sur une codebase JS ü§ñ</title><link href="https://tech.bedrockstreaming.com/refactorer-avec-jscodeshift" rel="alternate" type="text/html" title="Comment appliquer automatiquement des modifications sur une codebase JS ü§ñ" /><published>2022-07-26T00:00:00+00:00</published><updated>2022-07-26T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/refactorer-avec-jscodeshift</id><content type="html" xml:base="https://tech.bedrockstreaming.com/refactorer-avec-jscodeshift">&lt;p&gt;Dans cet article, je vais vous pr√©senter &lt;a href=&quot;https://github.com/facebook/jscodeshift&quot;&gt;JSCodeshift&lt;/a&gt;, une libraire qui va vous permettre d‚Äôanalyser et appliquer automatiquement des modifications sur du code Javascript ou Typescript.&lt;/p&gt;

&lt;h1 id=&quot;cas-d√©cole-&quot;&gt;Cas d‚Äô√©cole üë®‚Äçüéì&lt;/h1&gt;

&lt;p&gt;Maintenir √† jour les d√©pendances de nos projets JS est l‚Äôune des r√®gles primordiales que nous nous effor√ßons de bien respecter pour &lt;a href=&quot;/2021/09/01/bonnes-pratiques-web&quot;&gt;ne pas avoir √† jeter nos applications tous les deux ans. üóë&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Cette t√¢che exige souvent d‚Äôun d√©veloppeur plus de travail que de simplement changer les versions des libraires dans le &lt;em&gt;package.json&lt;/em&gt;.
Si une d√©pendance est utilis√©e dans diff√©rentes parties du code et qu‚Äôun breaking-change est introduit, on peut vite se retrouver avec &lt;strong&gt;des centaines&lt;/strong&gt; de fichiers √† modifier manuellement.&lt;/p&gt;

&lt;center&gt;
&lt;a href=&quot;https://www.monkeyuser.com/2018/implementation/&quot;&gt;&lt;img src=&quot;/images/posts/refactorer-avec-jscodeshift/102-implementation.png&quot; alt=&quot;Caricature de projet avec ses dependencies&quot; /&gt;&lt;/a&gt;
&lt;br /&gt;
‚ÑπÔ∏è &lt;em&gt;Exemple d&apos;un project Javascript qui ne respecte pas cette r√®gle&lt;/em&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;C‚Äôest un probl√®me de ce genre que nous avons rencontr√© lors de la mise √† jour de &lt;a href=&quot;https://github.com/BedrockStreaming/i18n-tools&quot;&gt;notre librairie d‚Äôinternationalisation&lt;/a&gt; sur notre web app React en JS.&lt;/p&gt;

&lt;p&gt;Apr√®s mise √† jour, l‚Äôappel √† l‚ÄôAPI de la librairie change de forme¬†:&lt;/p&gt;
&lt;div class=&quot;language-typescript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;//Before&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;translationKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// All options are passed as parameters&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Data used for interpolation&lt;/span&gt;
    &lt;span class=&quot;kr&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Amount used for plural form&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;general&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;boolean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Use general plural form&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;renderers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;object&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// JSX renderers&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;string&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;//After&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;translationKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Object containing all options&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Data used for interpolation&lt;/span&gt;
      &lt;span class=&quot;kr&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Amount used for plural form&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;general&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;boolean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Use general plural form&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;renderers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;?:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;object&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// JSX renderers&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;string&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Plus simplement, quelques exemples de transformations¬†:&lt;/p&gt;
&lt;div class=&quot;language-tsx highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// Before&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;title1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;translationKeyExample&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;title2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;labelKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;someData&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;aNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;title3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;translationKeyExample&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// After&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;title1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;translationKeyExample&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Basic usecase with only one argument, nothing changed on this one&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;title2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;labelKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;someData&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;aNumber&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;title3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;translationKeyExample&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Dans le cas le plus basique sans les arguments optionnels &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;t(‚ÄòtranslationKey‚Äô)&lt;/code&gt; nous n‚Äôavons rien √† modifier, mais dans les autres cas, il y a du changement √† faire. üßπ&lt;/p&gt;

&lt;h2 id=&quot;les-solutions-que-nous-avons-√©cart√©es-&quot;&gt;Les solutions que nous avons √©cart√©es ‚ùå&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Avec un &lt;strong&gt;Find All&lt;/strong&gt;, trouver toutes les utilisations de la librairie et modifier les appels probl√©matiques √† la main.
    &lt;ul&gt;
      &lt;li&gt;Cette solution est la plus simple, mais peut √™tre tr√®s r√©p√©titive, ce qui augmente la probabilit√© de faire une erreur. On aura du mal √† uniquement filtrer les cas sp√©cifiques qui nous int√©ressent.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Utiliser des RegExp pour mieux cibler les cas sp√©cifiques
    &lt;ul&gt;
      &lt;li&gt;Cela nous a permis de faire rapidement une estimation approximative du nombre de cas qu‚Äôil nous faudrait modifier, mais nous avons eu du mal √† cibler correctement tous les appels et la modification se fait toujours √† la main.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Cr√©er un fichier de d√©finition TypeScript pour la librairie, et laisser le Language Server Protocol ou son IDE trouver les appels probl√©matiques
    &lt;ul&gt;
      &lt;li&gt;La solution la plus rapide et la plus fiable pour la partie d√©tection, mais qui demande toujours de faire les modifications √† la main.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Mais il nous restait encore un Joker pour cette t√¢che. üÉè&lt;/p&gt;

&lt;h1 id=&quot;jscodeshift-&quot;&gt;JSCodeshift ü™Ñ&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/facebook/jscodeshift&quot;&gt;Cette librairie&lt;/a&gt; permet d‚Äôexposer facilement &lt;a href=&quot;https://fr.wikipedia.org/wiki/Arbre_de_la_syntaxe_abstraite&quot;&gt;&lt;em&gt;l‚ÄôAbstract Syntax Tree&lt;/em&gt;&lt;/a&gt;, autrement dit la repr√©sentation du code apr√®s le parsing des fichiers.
Nous pouvons ainsi √©crire des scripts qui nous permettent de parcourir cet arbre, de le modifier facilement, d‚Äôappliquer les modifications et de les formater.
Ces scripts s‚Äôappellent des &lt;em&gt;codemods&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Pour en savoir un peu plus sur &lt;em&gt;l‚ÄôAbstract Syntax Tree&lt;/em&gt;, je vous conseille de jeter un coup d‚Äô≈ìil √† &lt;a href=&quot;https://astexplorer.net/&quot;&gt;ASTExplorer&lt;/a&gt; qui vous permet de visualiser l‚ÄôAST d‚Äôun fichier facilement pour en comprendre le fonctionnement.&lt;/p&gt;

&lt;p&gt;Quelques librairies ont propos√© des &lt;em&gt;codemods&lt;/em&gt; lors de leurs grosses mises √† jour, par exemple &lt;a href=&quot;https://github.com/reactjs/react-codemod&quot;&gt;React avec react-codemod&lt;/a&gt;.&lt;/p&gt;

&lt;center&gt;
&lt;a href=&quot;https://astexplorer.net/&quot;&gt;&lt;img src=&quot;/images/posts/refactorer-avec-jscodeshift/astexplorer.png&quot; alt=&quot;Capture d&apos;√©cran du site ASTExplorer&quot; /&gt;&lt;/a&gt;
&lt;br /&gt;
‚ÑπÔ∏è &lt;em&gt;Capture d&apos;√©cran du site ASTExplorer&lt;/em&gt;
&lt;/center&gt;
&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;en-application-&quot;&gt;En application üí™&lt;/h2&gt;

&lt;div class=&quot;language-typescript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kr&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;exports&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;FileInfo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;API&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;jscodeshift&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// If we don&apos;t find any &quot;Translate&quot; string inside our file, we can assume that it&apos;s safe to skip it&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;regex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;RegExp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;Translate[(]&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;regex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;find&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;CallExpression&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;callee&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;Identifier&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;filterOutSimpleUsages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;mutatePath&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;toSource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Dans la fonction principale du script, j‚Äôai utilis√© une expression r√©guli√®re pour filtrer les fichiers qui ne poss√®dent pas la cha√Æne de caract√®res &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Translate(&lt;/code&gt;.
Ceci permet de gagner un peu de temps sur l‚Äôex√©cution. ‚åõÔ∏è&lt;/p&gt;

&lt;p&gt;Ensuite, je cherche dans le fichier une ou plusieurs variables &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;t&lt;/code&gt;. Si aucune n‚Äôest pr√©sente, on peut passer au fichier suivant, sinon on continue le raffinage.&lt;/p&gt;

&lt;p&gt;On passe dans un filtre qui va nous permettre d‚Äôenlever les usages de la fonction &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;t&lt;/code&gt; avec un seul argument qui ne posent pas de probl√®me.&lt;/p&gt;

&lt;div class=&quot;language-typescript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;requiredPropertiesKeys&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;general&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;renderers&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Filter function to ensure that we enter the mutation function only if needed&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;filterOutSimpleUsages&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ASTPath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;CallExpression&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;arguments&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// If we only have the translation key, we don&apos;t need to refactor this usage&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// More than 2 arguments is an absolute sign of an old usage&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// If second argument is not an object, we need to manually fix this case&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;ObjectExpression&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// If none of the above properties is found in second argument, we can say that this is an old usage&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;requiredPropertiesKeys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;every&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;requiredPropertyKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ObjectExpression&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;properties&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;find&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// I needed to do some TS trickery to avoid getting warnings everywhere, sorry for that&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;property&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;property&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ObjectProperty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Identifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;requiredPropertyKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finalement, on peut passer dans la fonction de mutation, qui va nous permettre de modifier directement le code des fichiers.&lt;/p&gt;

&lt;div class=&quot;language-typescript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// Mutation function, we apply our modification to the AST&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;mutatePath&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;JSCodeshift&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ASTPath&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;CallExpression&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;objectProperties&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;requiredPropertiesKeys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;propertyKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;argument&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;arguments&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// If no argument or argument is a spread type, we don&apos;t take it in consideration&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;argument&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;argument&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;SpreadElement&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// If argument is undefined, we skip it&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;argument&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Identifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;argument&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Identifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// We create a new object property with an identifier (the object key) and put our argument inside&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;objectProperty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;identifier&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;propertyKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;argument&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)];&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ObjectProperty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// Finally, we keep our translation key in first position and our newly created object in second argument&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;arguments&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;arguments&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;objectExpression&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;objectProperties&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)];&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On r√©cup√®re les arguments d√©j√† existants, on cr√©e un nouvel objet et on y place nos arguments !&lt;/p&gt;

&lt;h2 id=&quot;r√©sultats-&quot;&gt;R√©sultats ‚ú®&lt;/h2&gt;

&lt;p&gt;‚è± Pour √† peu pr√®s &lt;strong&gt;2900 fichiers&lt;/strong&gt;, le script a mis moins de &lt;strong&gt;5,9 secondes&lt;/strong&gt; √† s‚Äôex√©cuter &lt;em&gt;(Macbook Pro 13‚Äù 2019)&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;JSCodeshift nous a permis de cibler tr√®s rapidement 99 % des cas probl√©matiques et de les corriger automatiquement.&lt;/p&gt;

&lt;p&gt;Le pourcentage restant concerne des cas o√π il √©tait g√©n√©ralement difficile de cibler la fonction &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;t&lt;/code&gt; (pass√©e en props √† un autre composant sous un autre nom). Ces quelques cas ont pu √™tre corrig√©s rapidement √† la main et d√©tect√©s gr√¢ce √† nos nombreux tests (heureusement qu‚Äôon a &lt;a href=&quot;/2021/09/01/bonnes-pratiques-web#tester-tester-tester&quot;&gt;une r√®gle de bonne pratique&lt;/a&gt; pour √ßa üòá).&lt;/p&gt;

&lt;h1 id=&quot;tldr--conclusion-&quot;&gt;tl;dr &amp;amp; conclusion üèÉ&lt;/h1&gt;

&lt;p&gt;Vous pouvez retrouver la source du codemod &lt;a href=&quot;https://gist.github.com/martinschneider01/40e0f340cf2ed549a875e8de00475b97&quot;&gt;ici m√™me&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Si vous √™tes mainteneur d‚Äôune librairie, il peut √™tre tr√®s int√©ressant de livrer des &lt;em&gt;codemods&lt;/em&gt; en m√™me temps que les breaking-changes pour faciliter l‚Äôadoption des mises √† jour par exemple !&lt;/p&gt;

&lt;p&gt;Avec une prise en main relativement facile pour un r√©sultat tr√®s rapide, nous avons √©t√© tr√®s satisfaits de JSCodeshift et nous n‚Äôh√©siterons pas √† r√©utiliser cette librairie dans le futur. üëä&lt;/p&gt;

&lt;p&gt;Merci √† tous pour la lecture de mon premier article et JSCodeshiftez bien. üòò&lt;/p&gt;</content><author><name>Martin SCHNEIDER</name></author><category term="javascript" /><category term="outil" /><category term="cytron" /><category term="frontend" /><category term="react" /><category term="refactor" /><category term="js" /><summary type="html">Dans cet article, je vais vous pr√©senter JSCodeshift, une libraire qui va vous permettre d‚Äôanalyser et appliquer automatiquement des modifications sur du code Javascript ou Typescript.</summary></entry><entry><title type="html">Bedrock Dev Facts #17</title><link href="https://tech.bedrockstreaming.com/2022/07/22/bedrock-dev-facts-17.html" rel="alternate" type="text/html" title="Bedrock Dev Facts #17" /><published>2022-07-22T00:00:00+00:00</published><updated>2022-07-22T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/2022/07/22/bedrock-dev-facts-17</id><content type="html" xml:base="https://tech.bedrockstreaming.com/2022/07/22/bedrock-dev-facts-17.html">&lt;p&gt;L‚Äô√©t√© arrive, les vacances, le repos.&lt;br /&gt;
Et vu les derniers devfacts des √©quipes Bedrock, il semblerait qu‚Äôil soit temps.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/tags/#devfacts&quot;&gt;Les autres articles de cette s√©rie sont disponibles ici.&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&quot;cest-presque-fini&quot;&gt;C‚Äôest presque fini&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;C‚Äôest fait √† 80%.&lt;br /&gt;
J‚Äôai fait tout le code, mais il ne marche pas.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;la-potion-magique&quot;&gt;La potion magique&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;Je n‚Äôai plus de cerveau, je vais aller au bar&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;cest-dommage-ils-allaient-le-faire-&quot;&gt;C‚Äôest dommage, ils allaient le faire !&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;Notre strat√©gie, c‚Äôest d‚Äô√™tre √† la bourre pour que d‚Äôautres fassent le travail&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;lenvers-du-d√©cor-du-t√©l√©travail&quot;&gt;L‚Äôenvers du d√©cor du t√©l√©travail&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;Quand il y a du vent chez moi la connexion est instable&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;ah-&quot;&gt;Ah !&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;J‚Äôai tir√© toute mon inspiration de manager des Shadocks&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;les-cons√©quences-du-management-√†-la-shadock&quot;&gt;Les cons√©quences du management √† la Shadock&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;Je ne vais tout de m√™me pas faire ma sieste pendant des heures de repos&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;auto-critique-du-manager-shadock-on-est-sauv√©-&quot;&gt;Auto-critique du manager Shadock. On est sauv√© !&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;Tout le monde s‚Äôen fout de ce que je fais&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;quand-tout-le-monde-le-fait-mais-que-personne-ne-comprend-pourquoi&quot;&gt;Quand tout le monde le fait, mais que personne ne comprend pourquoi&lt;/h1&gt;

&lt;p&gt;&lt;em&gt;En parlant du TimeSheet, de mani√®re na√Øve&lt;/em&gt;&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;‚ÄúMais il y a vraiment quelqu‚Äôun dans la boite qui fait √ßa correctement ?‚Äù&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;est-ce-que-je-peux-casser-√†-moiti√©-&quot;&gt;Est-ce que je peux casser √† moiti√© ?&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;Est-ce qu‚Äôon peut faire un semi BC-break ‚ÅâÔ∏è&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;cest-pas-faux&quot;&gt;C‚Äôest pas faux&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;C‚Äôest connu et assum√©, √ßa fonctionnera pas jusqu‚Äôau moment o√π √ßa fonctionnera&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;quand-tu-as-d√©laiss√©-la-review-toute-la-semaine&quot;&gt;Quand tu as d√©laiss√© la review toute la semaine&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;Allez bon vendREVIEW √† tous&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1&gt;ü§î&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;Les tests passent mais √ßa plante&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;le-d√©tecteur-√†-petit-dej&quot;&gt;Le d√©tecteur √† petit-dej&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;‚Äúje cherche X ‚Ä¶‚Äù&lt;/li&gt;
    &lt;li&gt;‚Äúva voir √† la cafete, il y a quelqu‚Äôun qui a ramen√© de la bouffe‚Äù&lt;/li&gt;
    &lt;li&gt;‚Äúc‚Äôest un honeypot √† X √ßa !‚Äù&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;cest-beau-le-mob-programming&quot;&gt;C‚Äôest beau le mob programming&lt;/h1&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/dev-facts-17/mob-programming.png&quot; alt=&quot;Image d&apos;un commit de H disant &amp;quot;little bug for E&amp;quot;, puis d&apos;un commit de E disant &amp;quot;fix H&apos;s shit&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;meurs-un-autre-jour&quot;&gt;Meurs un autre jour&lt;/h1&gt;

&lt;p&gt;&lt;em&gt;Quand tu veux vraiment √™tre s√ªr que ton code est ex√©cut√© mais que tu oublies de nettoyer l‚Äôhistorique&lt;/em&gt;
&lt;img src=&quot;/images/posts/dev-facts-17/die-to-test.png&quot; alt=&quot;Image du code PHP d&apos;un commit o√π il reste un `die(&apos;HEEEEERE&apos;)&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;cest-pas-compliqu√©-linformatique&quot;&gt;C‚Äôest pas compliqu√© l‚Äôinformatique&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Comment tu as fait √ßa ?&lt;/li&gt;
    &lt;li&gt;J‚Äôai appuy√© sur des touches de mon clavier&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/dev-facts-17/type-30-keyboard.png&quot; alt=&quot;Image d&apos;un ticket o√π le d√©veloppeur indique qu&apos;il a chang√© une valeur de 20 √† 30 en expliquant le &amp;quot;comment&amp;quot; par &amp;quot;en appuyant sur le clavier&amp;quot;&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;google-translate-nest-pas-toujours-ton-ami&quot;&gt;Google translate n‚Äôest pas toujours ton ami&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;‚ÄúTu peux traduire l‚ÄôUS en fran√ßais quand tu la lis ?‚Äù&lt;/li&gt;
    &lt;li&gt;‚ÄúPas de souci, Alors‚Ä¶ &lt;em&gt;il faut ajouter un message de grille pain d‚Äôerreur lors du ‚Ä¶&lt;/em&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;si-√ßa-passait-c√©tait-beau&quot;&gt;Si √ßa passait, c‚Äô√©tait beau&lt;/h1&gt;

&lt;p&gt;&lt;em&gt;Une personne qui parle √† son √©cran sur lequel il y a du code :&lt;/em&gt;&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;Dis moi que √ßa va marcher, s‚Äôil te plait üôè&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;sur-un-malentendu-il-a-√©t√©-engag√©&quot;&gt;Sur un malentendu, il a √©t√© engag√©&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;L‚Äôessentiel de mes connaissances, c‚Äôest du bluff&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;et-on-fini-avec-un-instant-po√©sie&quot;&gt;Et on fini avec un instant po√©sie&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;em&gt;Mes p‚Äôtits chats, demain c‚Äôest d√©mo infra,&lt;/em&gt;&lt;br /&gt;
&lt;em&gt;Pour l‚Äôinstant il n‚Äôy a pas d‚Äôinscrits,&lt;/em&gt;&lt;br /&gt;
&lt;em&gt;N‚Äôh√©sitez pas √† venir pr√©senter votre travail accompli !&lt;/em&gt;&lt;br /&gt;
&lt;em&gt;D‚Äôici √† ce prochain rendez-vous,&lt;/em&gt;&lt;br /&gt;
&lt;em&gt;Des bisous üòò&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>Bedrock</name></author><category term="devfacts" /><category term="humour" /><summary type="html">L‚Äô√©t√© arrive, les vacances, le repos. Et vu les derniers devfacts des √©quipes Bedrock, il semblerait qu‚Äôil soit temps.</summary></entry><entry><title type="html">Encrypt AWS AMIs: one way to do it wrong</title><link href="https://tech.bedrockstreaming.com/2022/07/08/encrypt-aws-amis.html" rel="alternate" type="text/html" title="Encrypt AWS AMIs: one way to do it wrong" /><published>2022-07-08T00:00:00+00:00</published><updated>2022-07-08T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/2022/07/08/encrypt-aws-amis</id><content type="html" xml:base="https://tech.bedrockstreaming.com/2022/07/08/encrypt-aws-amis.html">&lt;p&gt;At Bedrock, we build our own privately shared AMIs (&lt;a href=&quot;https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html&quot;&gt;Amazon Machine Images&lt;/a&gt;) for different parts of our stack: kubernetes platform, vod platform, etc. We build those AMIs to optimize kernel parameters,to embed some tools, and more. We have been using Packer for a couple of years, and everything has been working just fine.&lt;/p&gt;

&lt;p&gt;Concerned about following AWS best-practices, we recently added &lt;a href=&quot;https://aws.amazon.com/premiumsupport/knowledge-center/ebs-automatic-encryption/&quot;&gt;encryption by default to all new EBS volumes&lt;/a&gt; in all our accounts.&lt;/p&gt;

&lt;p&gt;We didn‚Äôt expect it, but this decision impacted our AMI creation process. We thus began to update our Packer workflow to integrate this new constraint. We were telling ourselves that more security was for the best and we didn‚Äôt take enough steps back to analyze drawbacks.&lt;/p&gt;

&lt;p&gt;You will find in this blog post multiple tips that may help you handle your AMIs encryption, but also why you shouldn‚Äôt handle it our way.&lt;/p&gt;

&lt;h2 id=&quot;build-an-encrypted-ami&quot;&gt;Build an encrypted AMI&lt;/h2&gt;

&lt;p&gt;To build our AMI, Packer launches an EC2 in a ‚Äúbuilder‚Äù account, then a snapshot is created and copied in needed regions. To use this AMI, ‚Äúuser‚Äù accounts are listed in the &lt;a href=&quot;https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/sharingamis-explicit.html&quot;&gt;AMI allowed users&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;With account EBS encryption enabled, snapshots are now encrypted. The default behavior is to use the account‚Äôs default KMS Key. Our first ‚Äúeasy‚Äù problem while trying to build new AMI with Packer was the following error message:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Error Copying AMI (ami-xxxxxx) to region (xx-xxx-x): InvalidRequest: Snapshot snap-xxxxxxx is encrypted. Creating an unencrypted copy from an encrypted snapshot is not supported.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To avoid that, we enabled AMI encryption with Packer, but it resulted in another error :&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Error modify AMI attributes: InvalidParameter: Snapshots encrypted with the AWS Managed CMK can&apos;t be shared.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As our AMI has to be shared to other accounts, it was impossible to encrypt our AMI with the account default KMS Key. So we created a dedicated KMS Key for Packer encryption.&lt;/p&gt;

&lt;p&gt;And it worked! We had our beautiful encrypted AMI, ready to be used in all our accounts.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-07-08-encrypt-aws-amis/build_encrypted_amis.png&quot; alt=&quot;How we build our encrypted AMIs&quot; /&gt;&lt;/p&gt;

&lt;center&gt;&lt;ins&gt;How we build our encrypted AMIs&lt;/ins&gt;&lt;/center&gt;

&lt;h2 id=&quot;run-an-encrypted-ami&quot;&gt;Run an encrypted AMI&lt;/h2&gt;

&lt;p&gt;This is where it gets complex.&lt;/p&gt;

&lt;p&gt;When we tried to launch an EC2 instance with our newly encrypted AMI, it failed with this error code :&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Client.InternalError: Client error on launch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/troubleshooting-launch.html&quot;&gt;It means that AWS can‚Äôt use this AMI because it is encrypted.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;First step was to authorize the KMS Key to be used for encryption in user (external) accounts.&lt;/p&gt;

&lt;p&gt;There are two methods to do that, for two different needs.&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;policy-method&quot;&gt;Policy method&lt;/h3&gt;

&lt;p&gt;To authorize an external customer managed role (ours), we had to authorize our role in KMS Key dedicated policy to use it, then authorize KMS Key in our role policy to be used. It is some kind of symmetric reference hard to correctly maintain with IaC (Terraform). And we had to do the same for KMS Key replicas in other regions, because they have a dedicated policy.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-07-08-encrypt-aws-amis/policy_method.png&quot; alt=&quot;Policy method&quot; /&gt;&lt;/p&gt;

&lt;center&gt;&lt;ins&gt;Policy method&lt;/ins&gt;&lt;/center&gt;

&lt;p&gt;One important thing to know here: some KMS Key permissions aren‚Äôt available for external account sharing. It means that when we try to add the permission &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kms:*&lt;/code&gt; to our role policy (for debug purposes only, we follow least privileges principles), it failed. You can find which permission is accessible in cross account use and which is not &lt;a href=&quot;https://docs.aws.amazon.com/kms/latest/developerguide/kms-api-permissions-reference.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;grant-method&quot;&gt;Grant method&lt;/h3&gt;

&lt;p&gt;To authorize an AWS managed role, like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AWSServiceRoleForAutoScaling&lt;/code&gt; (to launch our EC2), we also needed to allow it to use our key. It is impossible to add a new policy on an AWS Managed role. So instead of using a policy method like before, we had to create a grant on that role to use our key. We tried to create that grant from the source account (where the key is created), but it didn‚Äôt work. We had to create that grant from the destination account (where &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AWSServiceRoleForAutoScaling&lt;/code&gt; is), using a role in the destination account that is allowed to create a grant‚Ä¶ So we had to allow a role from the destination account to create a grant with Policy method, then use the previous role to allow an AWS Managed Role to use our KMS Key with Grant method. Pretty fun, right?&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-07-08-encrypt-aws-amis/grant_method.png&quot; alt=&quot;Grant method&quot; /&gt;&lt;/p&gt;

&lt;center&gt;&lt;ins&gt;Grant method&lt;/ins&gt;&lt;/center&gt;

&lt;hr /&gt;

&lt;p&gt;Once all needed roles were allowed, we tried to launch an EC2 with the allowed role attached as an instance role. It failed again, because we needed to also use the AMI KMS Key on root volume of our instance. By default, it was the account KMS Key that was used.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html&quot;&gt;We attached that key on our root volume&lt;/a&gt;, and it worked. We also could launch our EC2 with ASG. It was all good.&lt;/p&gt;

&lt;p&gt;But there was a big security vulnerability: instead of using one KMS key per account to encrypt our EBS volume, we were now using the same KMS key on all our accounts because of our encrypted AMI.&lt;/p&gt;

&lt;h2 id=&quot;kms-key-rotation&quot;&gt;KMS Key rotation&lt;/h2&gt;

&lt;p&gt;A short word about &lt;a href=&quot;https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html#kms-key-rotation&quot;&gt;Key rotation&lt;/a&gt;: it can easily be enabled to automatically rotate key materials each year. All new AMIs will be encrypted with new key material and nothing has to be changed to run encrypted AMIs.
But in case of a manual rotation: if a key is leaked for example, you will need to recreate a new KMS Key, its replicas, and all permissions and grants seen before.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Using privately shared encrypted AMI caused us multiple problems:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;higher complexity to maintain.&lt;/li&gt;
  &lt;li&gt;lower security in cross-account configuration.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Furthermore, we checked all our AMIs to see if they contain sensitive data. It isn‚Äôt the case : all sensitive data is uploaded at startup by &lt;a href=&quot;https://docs.aws.amazon.com/autoscaling/ec2/userguide/create-asg-launch-template.html&quot;&gt;Launch Template&lt;/a&gt;. We had no interest in continuing to use encrypted AMI, and we would have spared so much time if we had seen that sooner.&lt;/p&gt;

&lt;p&gt;This is why we decided to disable encryption for all new EBS volume on our builder account and stop building encrypted AMI.&lt;/p&gt;

&lt;p&gt;Doing all the previous configuration took us several weeks. We are now more aware that doing security just for the beauty of it can be really counterproductive.&lt;/p&gt;

&lt;p&gt;If your AMIs contain sensitive data, a better way to handle encrypted AMI may be to stop creating privately shared AMIs. Instead, copy and encrypt a private AMI in each of your ‚Äúuser‚Äù accounts with a dedicated KMS Key per account. As a result, there will be a larger amount of AMI to handle (one AMI per account per region), KMS Key permissions will still be complex, but security should improved.&lt;/p&gt;

&lt;h4 id=&quot;logo-used-in-thumbnail&quot;&gt;Logo used in thumbnail&lt;/h4&gt;
&lt;h5 id=&quot;death-by-imogen-oh-from-nounprojectcom&quot;&gt;Death by Imogen Oh from NounProject.com&lt;/h5&gt;
&lt;h5 id=&quot;key-by-baboon-designs-from-nounprojectcom&quot;&gt;Key by Baboon designs from NounProject.com&lt;/h5&gt;
&lt;h5 id=&quot;gears-by-aybige-from-nounprojectcom&quot;&gt;Gears by Aybige from NounProject.com&lt;/h5&gt;</content><author><name>Tanguy Falconnet</name></author><category term="cloud" /><category term="aws" /><summary type="html">At Bedrock, we build our own privately shared AMIs (Amazon Machine Images) for different parts of our stack: kubernetes platform, vod platform, etc. We build those AMIs to optimize kernel parameters,to embed some tools, and more. We have been using Packer for a couple of years, and everything has been working just fine.</summary></entry><entry><title type="html">Debugging and reviewing your Android dependencies with apktool</title><link href="https://tech.bedrockstreaming.com/2022/06/20/android-apktool-decompiling.html" rel="alternate" type="text/html" title="Debugging and reviewing your Android dependencies with apktool" /><published>2022-06-20T00:00:00+00:00</published><updated>2022-06-20T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/2022/06/20/android-apktool-decompiling</id><content type="html" xml:base="https://tech.bedrockstreaming.com/2022/06/20/android-apktool-decompiling.html">&lt;p&gt;If you maintain an Android application, you might be relying on performance monitoring SDKs like &lt;a href=&quot;https://firebase.google.com/docs/perf-mon&quot;&gt;Firebase Performance&lt;/a&gt; or &lt;a href=&quot;https://newrelic.com/products/mobile-monitoring&quot;&gt;New Relic&lt;/a&gt;, to name a couple. These plugins usually have a light setup process‚Äîjust apply a Gradle plugin, and they provide the ability to collect statistics about every network call and database query in your app automatically.&lt;/p&gt;

&lt;p&gt;The usual way to achieve this is to rely on a process called &lt;strong&gt;instrumentation&lt;/strong&gt;, which is supported &lt;em&gt;via&lt;/em&gt; the Android Gradle Plugin‚Äôs &lt;a href=&quot;https://developer.android.com/reference/tools/gradle-api/7.2/com/android/build/api/transform/Transform&quot;&gt;Transform API&lt;/a&gt;, or its successor, the &lt;a href=&quot;https://developer.android.com/studio/releases/gradle-plugin-api-updates#transform-removed&quot;&gt;Instrumentation API&lt;/a&gt;. This feature is very powerful, and potentially dangerous; in our case, a minor patch of one of these SDKs caused a production bug that left one of our core features crippled.&lt;/p&gt;

&lt;p&gt;The visible cause of our bug, from a developer‚Äôs point of view, was that the video player saw the network requests as always being extremely fast, no matter the network quality. Therefore, it assumed the device had access to a very high bandwidth, and tried loading video segments with a very high bit rate. This did &lt;strong&gt;not&lt;/strong&gt; go well for users with slower network speeds.&lt;/p&gt;

&lt;p&gt;To understand what was going on, what went wrong, how to fix it and how to take measures so that it never happens again, we had to do some investigation.&lt;/p&gt;

&lt;h1 id=&quot;diving-into-the-android-build-process&quot;&gt;Diving into the Android build process&lt;/h1&gt;

&lt;p&gt;Before we get to the topic of instrumentation, we first need to know a little about the Android app build process. Don‚Äôt worry, we won‚Äôt need to dive too deep into the details.&lt;/p&gt;

&lt;p&gt;To put it simply, during the build process, your source files (Kotlin and Java) are compiled to Dalvik bytecode, which is stored in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.dex&lt;/code&gt; files. These files are then packaged into an APK file, which is basically just a ZIP file with all your code and resources.&lt;/p&gt;

&lt;div class=&quot;mermaid&quot;&gt;
flowchart LR
    kt[.kt files] -- kotlinc --&amp;gt; dex[.dex files] --&amp;gt; packaging[[packaging]]
    java[.java files] -- javac --&amp;gt; dex
    res[resource files] -- aapt --&amp;gt; resc[compiled resource files] --&amp;gt; packaging --&amp;gt; APK
    subgraph APK
    direction TB
    dex1[.dex] -.- dex2[.dex] -.- dex3[.dex] -.- dex4[.dex]
    res1[res] -.- res2[res] -.- res3[res] -.- res4[res]
    signature -.- manifest
end
&lt;/div&gt;

&lt;h2 id=&quot;understanding-bytecode-instrumentation&quot;&gt;Understanding bytecode instrumentation&lt;/h2&gt;

&lt;p&gt;Now, let‚Äôs say you want to take an existing application with its untouched source code, and automatically inject calls to &lt;em&gt;your&lt;/em&gt; SDK every time a network call is made, to log whether it was successful or not. How would you achieve this?&lt;/p&gt;

&lt;p&gt;The easiest way is to plug yourself into the build, right after the code is compiled into bytecode, and &lt;strong&gt;modify the bytecode&lt;/strong&gt; to your will.&lt;/p&gt;

&lt;div class=&quot;mermaid&quot;&gt;
flowchart LR
    kt[.kt files] -- kotlinc --&amp;gt; dex[.dex files] --&amp;gt; transform[[transform]] --&amp;gt; packaging[[packaging]]
    java[.java files] -- javac --&amp;gt; dex
    res[resource files] -- aapt --&amp;gt; resc[compiled resource files] --&amp;gt; packaging --&amp;gt; APK
    classDef transformed fill:#ff0000
    class transform transformed

    subgraph APK
    direction TB
    dex1[.dex] -.- dex2[.dex] -.- dex3[.dex] -.- dex4[.dex]
    res1[res] -.- res2[res] -.- res3[res] -.- res4[res]
    signature -.- manifest
    class dex1,dex2,dex3,dex4 transformed
end
&lt;/div&gt;

&lt;p&gt;The Android Gradle Plugin (AGP) offers APIs to do this, so SDK vendors can just develop a Gradle plugin and ta-da! Once you apply it, your app is automatically instrumented.&lt;/p&gt;

&lt;p&gt;Note that there are other ways to achieve this without the AGP. Notably, Kotlin now uses an Intermediate Representation (IR), before it gets compiled down to a target-specific format. &lt;a href=&quot;https://blog.bnorm.dev/writing-your-second-compiler-plugin-part-1&quot;&gt;You can write a Kotlin IR compiler plugin&lt;/a&gt; to transform the IR code and add your own hooks in an Android-agnostic way, although this API is still experimental at the time of writing.&lt;/p&gt;

&lt;h2 id=&quot;reverse-engineering-a-built-apk&quot;&gt;Reverse-engineering a built APK&lt;/h2&gt;

&lt;p&gt;Now, this is great. But when you open an APK file, what do you get?&lt;/p&gt;

&lt;p&gt;Let‚Äôs unzip one and look inside.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;.
‚îú‚îÄ‚îÄ META-INF
‚îú‚îÄ‚îÄ assets
‚îú‚îÄ‚îÄ google
‚îú‚îÄ‚îÄ okhttp3
‚îú‚îÄ‚îÄ res
‚îú‚îÄ‚îÄ AndroidManifest.xml
‚îú‚îÄ‚îÄ classes.dex
‚îú‚îÄ‚îÄ classes2.dex
‚îú‚îÄ‚îÄ classes3.dex
‚îú‚îÄ‚îÄ classes4.dex
‚îú‚îÄ‚îÄ firebase-common.properties
‚îú‚îÄ‚îÄ firebase-crashlytics.properties
‚îú‚îÄ‚îÄ play-services-base.properties
‚îú‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ resources.arsc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A bunch of noise, and four interesting &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.dex&lt;/code&gt; files. That‚Äôs where the app‚Äôs code is stored, but unfortunately, these files are not human-readable.&lt;/p&gt;

&lt;p&gt;To turn them into low-level but understandable code, some tooling will be necessary. The easiest to use for this task is &lt;a href=&quot;https://ibotpeaches.github.io/Apktool/&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apktool&lt;/code&gt;&lt;/a&gt;, which is free and open-source.&lt;/p&gt;

&lt;p&gt;Let‚Äôs run &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apktool&lt;/code&gt; on our APK, and see what happens:&lt;/p&gt;

&lt;script id=&quot;asciicast-1RozUUMJwPlMjS0ea1R6GNwuj&quot; src=&quot;https://asciinema.org/a/1RozUUMJwPlMjS0ea1R6GNwuj.js&quot; async=&quot;&quot;&gt;&lt;/script&gt;

&lt;noscript&gt;
&lt;pre&gt;
~/Downloads
‚ùØ apktool d bedrock-sample-release.apk
I: Using Apktool 2.6.1 on bedrock-sample-release.apk
I: Loading resource table...
I: Decoding AndroidManifest.xml with resources...
I: Loading resource table from file: /Users/bcandellier/Library/apktool/framework/1.apk
I: Regular manifest package...
I: Decoding file-resources...
W: Cant find 9patch chunk in file: &quot;drawable-xxhdpi-v4/common_google_signin_btn_icon_light_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-mdpi-v4/common_google_signin_btn_icon_light_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-mdpi-v4/common_google_signin_btn_text_light_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-xhdpi-v4/common_google_signin_btn_text_dark_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-xhdpi-v4/common_google_signin_btn_icon_dark_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-xhdpi-v4/common_google_signin_btn_text_light_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-xxhdpi-v4/common_google_signin_btn_text_light_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-hdpi-v4/common_google_signin_btn_text_light_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-xhdpi-v4/common_google_signin_btn_icon_light_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-hdpi-v4/common_google_signin_btn_icon_light_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-mdpi-v4/common_google_signin_btn_icon_dark_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-xxhdpi-v4/common_google_signin_btn_text_dark_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-xxhdpi-v4/common_google_signin_btn_icon_dark_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-mdpi-v4/common_google_signin_btn_text_dark_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-hdpi-v4/common_google_signin_btn_icon_dark_normal_background.9.png&quot;. Renaming it to *.png.
W: Cant find 9patch chunk in file: &quot;drawable-hdpi-v4/common_google_signin_btn_text_dark_normal_background.9.png&quot;. Renaming it to *.png.
I: Decoding values */* XMLs...
I: Baksmaling classes.dex...
I: Baksmaling classes2.dex...
I: Baksmaling classes3.dex...
I: Baksmaling classes4.dex...
I: Copying assets and libs...
I: Copying unknown files...
I: Copying original files...
I: Copying META-INF/services directory
&lt;/pre&gt;
&lt;/noscript&gt;

&lt;p&gt;There we go! In our case, we can ignore the warnings. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apktool&lt;/code&gt; created a new directory with a bunch of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.smali&lt;/code&gt; files, organized by package: one file per class, containing their Dalvik bytecode.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;.
‚îú‚îÄ‚îÄ AndroidManifest.xml
‚îú‚îÄ‚îÄ res
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ values
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ strings.xml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout_home.xml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ smali
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ com
‚îÇ¬†¬†  ¬†¬† ‚îú‚îÄ‚îÄ bedrockstreaming
‚îÇ¬†¬†  ¬†¬† ‚îÇ   ‚îú‚îÄ‚îÄ app
‚îÇ¬†¬†  ¬†¬† ‚îÇ   ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ mobile
‚îÇ¬†¬†  ¬†¬† ‚îÇ   ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ R$anim.smali
‚îÇ¬†¬†  ¬†¬† ‚îÇ   ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ R$layout.smali
‚îÇ¬†¬†  ¬†¬† ‚îÇ   ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ R$string.smali
‚îÇ¬†¬†  ¬†¬† ‚îÇ   ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ R$style.smali
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ¬†¬†  ¬†¬† ‚îî‚îÄ‚îÄ google
‚îÇ¬†¬†  ¬†¬†     ‚îú‚îÄ‚îÄ android
‚îÇ¬†¬†  ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ exoplayer2
‚îÇ¬†¬†  ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ AbstractConcatenatedTimeline.smali
‚îÇ¬†¬†  ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ AudioBecomingNoisyManager.smali
‚îÇ¬†¬†  ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ AudioFocusManager$AudioFocusListener$$ExternalSyntheticLambda0.smali
‚îÇ¬†¬†  ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ AudioFocusManager$AudioFocusListener.smali
‚îÇ¬†¬†  ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ AudioFocusManager.smali
‚îÇ¬†¬†  ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ BasePlayer.smali
‚îÇ¬†¬†  ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ BaseRenderer.smali
‚îÇ¬†¬†  ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ BuildConfig.smali
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ           ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ smali_classes2
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ com
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ bedrockstreaming
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ app
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ mobile
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ MobileApplication.smali
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ ...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you see files with mangled names and contents, make sure that you run &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apktool&lt;/code&gt; on an APK with R8 obfuscation disabled, or you‚Äôll have a hard time figuring things out.&lt;/p&gt;

&lt;h2 id=&quot;understanding-dalvik-bytecode&quot;&gt;Understanding Dalvik bytecode&lt;/h2&gt;

&lt;p&gt;Now, if you open one of these files, it will contain code that looks like the snippet below. It will look unfamiliar; that‚Äôs normal.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;.method private final getContent()Lcom/bedrockstreaming/example/HomeViewModel$State$Content;

    .locals 2
    .line 119

    iget-object v0, p0, Lcom/bedrockstreaming/example/HomeViewModel;-&amp;gt;state:Landroidx/lifecycle/LiveData;

    invoke-virtual {v0}, Landroidx/lifecycle/LiveData;-&amp;gt;getValue()Ljava/lang/Object;

    move-result-object v0

    instance-of v1, v0, Lcom/bedrockstreaming/example/HomeViewModel$State$Content;

    if-eqz v1, :cond_0

    check-cast v0, Lcom/bedrockstreaming/example/HomeViewModel$State$Content;

    goto :goto_0

    :cond_0

    const/4 v0, 0x0

    :goto_0

    return-object v0
  
.end method
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you‚Äôve ever worked with assembly code before, you might notice similarities in the way the code is written. Each line begins with an instruction, which can take comma-separated parameters. To work out what these instructions and their parameters mean, you &lt;strong&gt;will&lt;/strong&gt; need to refer to the &lt;a href=&quot;https://source.android.com/devices/tech/dalvik/dalvik-bytecode&quot;&gt;Dalvik bytecode documentation&lt;/a&gt; provided by Google.&lt;/p&gt;

&lt;p&gt;Let‚Äôs take an example line from the snippet and decode it together. Looking at the table in the documentation, we can see deduce this:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# We&apos;ll decode this line:
invoke-virtual {v0}, Landroidx/lifecycle/LiveData;-&amp;gt;getValue()Ljava/lang/Object;

invoke-virtual                                                                   # We&apos;re calling a virtual method
               {v0},                                                             # We&apos;re calling the method on the object referenced in register v0
                     Landroidx/lifecycle/LiveData;                               # The method we&apos;re calling is defined by androidx.lifecycle.LiveData
                                                  -&amp;gt;getValue()                   # We&apos;re calling a method called getValue()
                                                              Ljava/lang/Object; # This method returns an Object
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With some determination, we can figure out what the snippet does. Here, we‚Äôre defining a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;getContent()&lt;/code&gt; method that tries to cast a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LiveData&lt;/code&gt;‚Äôs value to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;State.Content&lt;/code&gt; and returns it, or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt; otherwise.&lt;/p&gt;

&lt;h1 id=&quot;using-a-decompiled-apk-as-a-debugging-tool&quot;&gt;Using a decompiled APK as a debugging tool&lt;/h1&gt;

&lt;h2 id=&quot;inspecting-suspicious-code&quot;&gt;Inspecting suspicious code&lt;/h2&gt;

&lt;p&gt;Before doing anything else, we can already start looking at the generated code to identify patterns that could cause issues. Problem is‚Ä¶ there can be a &lt;em&gt;lot&lt;/em&gt; of code to look through.&lt;/p&gt;

&lt;p&gt;Before going this deep in the rabbit hole, we already figured our issue was, somehow, related to instrumentation: disabling it fixed this issue; downgrading to the previous release of the SDK also fixed it. This means that if we want to get a clear look at &lt;strong&gt;what&lt;/strong&gt; needs to change to go from a working APK from a broken one, we could just compare an APK instrumented by the previous SDK version with an APK instrumented by the current one!&lt;/p&gt;

&lt;p&gt;Of course, we want to do this on the human-readable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;smali&lt;/code&gt; files, not the raw &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dex&lt;/code&gt; files. We can generate a full diff with the help of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;diff&lt;/code&gt; tool:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;diff &lt;span class=&quot;nt&quot;&gt;-bur&lt;/span&gt; normal/ instrumented/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In our case, it also proved useful to compare an APK that has been instrumented with one that hasn‚Äôt, to understand what that instrumentation is meant to achieve. Most of it was to notify the SDK of every HTTP request, along with its result.&lt;/p&gt;

&lt;p&gt;As a simple example, the snippet below shows a class belonging to Picasso. We can see the HTTP calls it makes are being intercepted by the SDK.&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gd&quot;&gt;--- normal/smali/com/squareup/picasso/NetworkRequestHandler.smali	2022-01-05 11:09:22.000000000 +0100
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ instrumented/smali/com/squareup/picasso/NetworkRequestHandler.smali	2022-01-05 11:08:34.000000000 +0100
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;@@ -128,10 +128,26 @@&lt;/span&gt;

     .line 103
     :cond_4
&lt;span class=&quot;gi&quot;&gt;+    instance-of v2, v1, Lokhttp3/Request$Builder;
+
+    if-nez v2, :cond_5
+
&lt;/span&gt;     invoke-virtual {v1}, Lokhttp3/Request$Builder;-&amp;gt;build()Lokhttp3/Request;

     move-result-object v2

+    goto :goto_1
&lt;span class=&quot;gi&quot;&gt;+
+    :cond_5
+    move-object v2, v1
+
+    check-cast v2, Lokhttp3/Request$Builder;
+
+    invoke-static {v2}, Lcom/vendor/instrumentation/okhttp3/OkHttp3Instrumentation;-&amp;gt;build(Lokhttp3/Request$Builder;)Lokhttp3/Request;
+
+    move-result-object v2
+
+    :goto_1
&lt;/span&gt;     return-object v2
 .end method
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;finding-the-source-of-the-issue-by-iteration&quot;&gt;Finding the source of the issue by iteration&lt;/h2&gt;

&lt;p&gt;We haven‚Äôt talked about &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apktool&lt;/code&gt;‚Äôs greatest strength yet: its ability to &lt;strong&gt;recompile&lt;/strong&gt; an APK from the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;smali&lt;/code&gt; sources it has decompiled! This means we can effectively decompile an APK, make modifications to its low-level code, recompile and run it.&lt;/p&gt;

&lt;p&gt;This proved really useful during our investigation. Since we have one directory with our APK in a bad state, and one directory with our APK in a good state, we can process by elimination to point out exactly which &lt;strong&gt;single class&lt;/strong&gt;, when modified, causes our bug.&lt;/p&gt;

&lt;p&gt;In our case, a useful workflow was to start with a suspect‚Äîlet‚Äôs say we think instrumenting the OkHttp classes might have caused the bug.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Copy the OkHttp classes from the ‚Äúbad‚Äù APK, and only those, to our ‚Äúgood‚Äù APK.&lt;/li&gt;
  &lt;li&gt;Recompile and run the app.&lt;/li&gt;
  &lt;li&gt;Does the bug occur?
    &lt;ul&gt;
      &lt;li&gt;If it does, then that means it is caused by the instrumentation of at least one of the OkHttp classes. We can go through this process again, this time by selecting only a subset of OkHttp‚Äôs classes, and check if the bug still occurs, etc.&lt;/li&gt;
      &lt;li&gt;If it doesn‚Äôt, revert the OkHttp classes and try again with another suspect.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This process can be accelerated with a very simple script, to iterate faster. The recompilation step occurs incrementally, and so only takes a few seconds.&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/sh&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# rebuild-and-run.sh&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Rebuild, sign and install an APK from its decompiled source.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# (c) 2022 Bedrock Streaming&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Inputs:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# DECOMPILED_APK_PATH: path to your previously decompiled APK directory&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# KEYSTORE_PATH: path to your debug keystore&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# KEYSTORE_PASSWORD: your debug keystore password&lt;/span&gt;

apktool &lt;span class=&quot;nt&quot;&gt;--use-aapt2&lt;/span&gt; b &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DECOMPILED_APK_PATH&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apksigner sign &lt;span class=&quot;nt&quot;&gt;-ks&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$KEYSTORE_PATH&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--ks-pass&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;pass:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$KEYSTORE_PASSWORD&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DECOMPILED_APK_PATH&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/dist/*.apk&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; adb &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DECOMPILED_APK_PATH&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/dist/*.apk&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here‚Äôs what it looks like in action:&lt;/p&gt;

&lt;script id=&quot;asciicast-HCdekIJOEwSdARnP2bUnWWipo&quot; src=&quot;https://asciinema.org/a/HCdekIJOEwSdARnP2bUnWWipo.js&quot; async=&quot;&quot;&gt;&lt;/script&gt;

&lt;noscript&gt;
&lt;pre&gt;
~/bytecode-playground
‚ùØ ./rebuild-and-run.sh
I: Using Apktool 2.6.1
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether sources has changed...
I: Checking whether resources has changed...
I: Building apk file...
I: Copying unknown files/dir...
I: Built apk...
Performing Incremental Install
Serving...
Success
Install command complete in 445 ms
&lt;/pre&gt;
&lt;/noscript&gt;

&lt;p&gt;In our case, we narrowed down the issue to the instrumentation of a single class: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;okhttp3.internal.http.CallServerInterceptor&lt;/code&gt;: once it was reverted, the bug disappeared.&lt;/p&gt;

&lt;p&gt;In fact, we narrowed it down to a very small patch with which the app runs fine:&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; .../okhttp3/internal/http/CallServerInterceptor.smali         | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/apk/smali_classes2/okhttp3/internal/http/CallServerInterceptor.smali b/apk/smali_classes2/okhttp3/internal/http/CallServerInterceptor.smali
&lt;span class=&quot;gh&quot;&gt;index c916149f..c26eab15 100644
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- a/apk/smali_classes2/okhttp3/internal/http/CallServerInterceptor.smali
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ b/apk/smali_classes2/okhttp3/internal/http/CallServerInterceptor.smali
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;@@ -510,7 +510,7 @@&lt;/span&gt;
 
     instance-of v8, v14, Lokhttp3/Response$Builder;
 
&lt;span class=&quot;gd&quot;&gt;-    if-nez v8, :cond_b
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+    #if-nez v8, :cond_b
&lt;/span&gt; 
     invoke-virtual {v14, v15}, Lokhttp3/Response$Builder;-&amp;gt;body(Lokhttp3/ResponseBody;)Lokhttp3/Response$Builder;
 
&lt;span class=&quot;p&quot;&gt;@@ -574,7 +574,7 @@&lt;/span&gt;
 
     instance-of v15, v8, Lokhttp3/Response$Builder;
 
&lt;span class=&quot;gd&quot;&gt;-    if-nez v15, :cond_e
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+    #if-nez v15, :cond_e
&lt;/span&gt; 
     invoke-virtual {v8, v14}, Lokhttp3/Response$Builder;-&amp;gt;body(Lokhttp3/ResponseBody;)Lokhttp3/Response$Builder;
 
&lt;span class=&quot;gd&quot;&gt;-- 
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Basically, when the code went through this &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;if&lt;/code&gt; statement, our request got wrapped by &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;com.vendor.instrumentation.okhttp3.OkHttp3Instrumentation&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;invoke-static {v8, v14}, Lcom/vendor/instrumentation/okhttp3/OkHttp3Instrumentation;-&amp;gt;body(Lokhttp3/Response$Builder;Lokhttp3/ResponseBody;)Lokhttp3/Response$Builder;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And what does this method do, you ask? Let‚Äôs take a look at the decompiled source in Android Studio, so that it‚Äôs a bit easier to read:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Builder&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ResponseBody&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;BufferedSource&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;Buffer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Buffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;readAll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;impl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;ResponseBody&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;contentType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;IOException&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;var4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;IOException reading from source: &quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;var4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;IllegalStateException&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;var5&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;IllegalStateException reading from source: &quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;var5&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;impl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The body is being read into memory!&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;readAll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When correlating this discovery with the source code from ExoPlayer, we could verify that, indeed, our player was expecting that the time it takes reading the response body would be the time it took to download the entire video segment. Here‚Äôs what this flow looks like in a functional app:&lt;/p&gt;

&lt;div class=&quot;mermaid&quot;&gt;
sequenceDiagram
    participant exo as OkHttpDataSource
    participant nr as OkHttp3Instrumentation
    participant okhttp as OkHttpClient
    participant server as Server Endpoint

    exo-&amp;gt;&amp;gt;nr: body()
    nr-&amp;gt;&amp;gt;okhttp: body()
    activate server
    okhttp-&amp;gt;&amp;gt;server: 
    server-&amp;gt;&amp;gt;okhttp: 
    okhttp-&amp;gt;&amp;gt;nr: ResponseBody (length=0)
    activate exo
    nr-&amp;gt;&amp;gt;exo: ResponseBody (length=0)
    server-&amp;gt;&amp;gt;exo: length=512
    server-&amp;gt;&amp;gt;exo: length=1024
    server-&amp;gt;&amp;gt;exo: length=1536
    server-&amp;gt;&amp;gt;exo: length=2048
    server-&amp;gt;&amp;gt;exo: length=2560
    note right of exo: OkHttpDataSource controls the body reads &lt;br /&gt; and can measure the time it took &lt;br /&gt; to read the whole response
    deactivate server
    deactivate exo
&lt;/div&gt;

&lt;p&gt;But with this bug in the SDK, since the HTTP response has been buffered into memory by some SDK, the read was always almost-instantaneous, no matter the speed of the connection. Additionally, it messed with the overall performance since requests were no longer properly streamed by their rightful users.&lt;/p&gt;

&lt;div class=&quot;mermaid&quot;&gt;
sequenceDiagram
    participant exo as OkHttpDataSource
    participant nr as OkHttp3Instrumentation
    participant okhttp as OkHttpClient
    participant server as Server Endpoint

    exo-&amp;gt;&amp;gt;nr: body()
    nr-&amp;gt;&amp;gt;okhttp: body()
    activate server
    okhttp-&amp;gt;&amp;gt;server: 
    server-&amp;gt;&amp;gt;okhttp: 
    activate nr
    okhttp-&amp;gt;&amp;gt;nr: 
    server-&amp;gt;&amp;gt;nr: length=512
    server-&amp;gt;&amp;gt;nr: length=1024
    server-&amp;gt;&amp;gt;nr: length=1536
    server-&amp;gt;&amp;gt;nr: length=2048
    server-&amp;gt;&amp;gt;nr: length=2560
    deactivate nr
    activate exo
    note right of exo: OkHttpDataSource is only notified &lt;br /&gt; after everything is downloaded
    nr-&amp;gt;&amp;gt;exo: ResponseBody (length=2560)
    deactivate server
    deactivate exo
&lt;/div&gt;

&lt;h1 id=&quot;using-a-decompiled-apk-as-a-review-tool&quot;&gt;Using a decompiled APK as a review tool&lt;/h1&gt;

&lt;p&gt;It‚Äôs no secret to developers in any software ecosystem that library updates can be a source of problems - security vulnerabilities, bugs, incompatibilities, and so on. It‚Äôs hard to vet them properly, especially in compiled form, like libraries distributed in the Java ecosystem. Things get even harder when arbitrary Gradle plugins start rewriting our own code!&lt;/p&gt;

&lt;p&gt;The tooling needed to decompile an APK is free, fast, and easy to automate. It‚Äôs a really helpful tool to investigate obscure bugs in places your debugger won‚Äôt let you place a breakpoint, and it‚Äôs also really useful to be able to see a human-readable diff between two binaries.&lt;/p&gt;

&lt;p&gt;Generating a diff of the effects of a library upgrade can seem overkill and hard to do in practice, but at least in the case of bug-fix releases with hopefully few changes, it can be very helpful to have an actual report of what changed. It‚Äôs an accepted practice to review the code your team checks in; why not review the code of others, since it ends up in the exact same artifact?&lt;/p&gt;</content><author><name>Baptiste Candellier</name></author><category term="android" /><category term="apktool" /><category term="instrumentation" /><category term="debugging" /><category term="productivity" /><summary type="html">If you maintain an Android application, you might be relying on performance monitoring SDKs like Firebase Performance or New Relic, to name a couple. These plugins usually have a light setup process‚Äîjust apply a Gradle plugin, and they provide the ability to collect statistics about every network call and database query in your app automatically.</summary></entry><entry><title type="html">Bedrock √† la Kubecon 2022, 4√®me partie¬†: chaos, r√©silience, ressenti global et conclusion g√©n√©rale‚Ä¶</title><link href="https://tech.bedrockstreaming.com/2022/06/16/kubecon-2022-part-4.html" rel="alternate" type="text/html" title="Bedrock √† la Kubecon 2022, 4√®me partie¬†: chaos, r√©silience, ressenti global et conclusion g√©n√©rale‚Ä¶" /><published>2022-06-16T00:00:00+00:00</published><updated>2022-06-16T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/2022/06/16/kubecon-2022-part-4</id><content type="html" xml:base="https://tech.bedrockstreaming.com/2022/06/16/kubecon-2022-part-4.html">&lt;p&gt;Pour terminer cette s√©rie, un ou deux sujets divers que nous n‚Äôavons pas regroup√© dans les trois articles pr√©c√©dents
(&lt;a href=&quot;/2022/06/13/kubecon-2022-part-1.html&quot;&gt;les performances applicatives et la scalabilit√©&lt;/a&gt;, 
&lt;a href=&quot;/2022/06/14/kubecon-2022-part-2.html&quot;&gt;les performances bas niveau, le syst√®me et le r√©seau&lt;/a&gt;,
&lt;a href=&quot;/2022/06/15/kubecon-2022-part-3.html&quot;&gt;la dev XP, l‚Äôoutillage, la CI/CD et l‚Äôobservabilit√©&lt;/a&gt;), 
puis une conclusion globale avec ce que nous avons retenu de cette KubeCon Europe 2022.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/part4.jpg&quot; alt=&quot;&amp;quot;KubeCon 2022 part4&amp;quot;&quot; /&gt;&lt;/p&gt;
&lt;center&gt;&lt;i&gt;La conclusion, @ KubeCon 2022¬†!&lt;/i&gt;&lt;/center&gt;

&lt;h2 id=&quot;chaos-engineering--chaos-testing-pour-une-meilleur-r√©silience-aux-pannes&quot;&gt;Chaos Engineering / Chaos Testing pour une meilleur r√©silience aux pannes&lt;/h2&gt;

&lt;p&gt;C‚Äôest un des sujets sur lesquels nous avons commenc√© √† travailler activement cette ann√©e¬†: &lt;em&gt;casser des choses&lt;/em&gt; dans nos clusters, dans notre plateforme, entre nos microservices.&lt;br /&gt;
L‚Äôid√©e sous-jacente est, bien s√ªr, que tout va casser un jour ou l‚Äôautre, donc autant provoquer du chaos nous-m√™me, en environnement contr√¥l√©. Nous identifierons ainsi des points sensibles de notre plateforme et pourrons les corriger, √©vitant ainsi des incidents, parfois majeurs, au mauvais moment.&lt;/p&gt;

&lt;p&gt;Ce th√®me du &lt;em&gt;Chaos Engineering&lt;/em&gt; est r√©guli√®rement abord√© en conf√©rences et nous √©tions contents de voir que nous ne sommes pas les seuls √† nous interroger sur &lt;em&gt;‚Äúcomment‚Äù&lt;/em&gt; en mettre en place.&lt;br /&gt;
Nous sommes repartis avec quelques pistes d‚Äôoutils, comme &lt;a href=&quot;https://chaos-mesh.org/&quot;&gt;chaos mesh&lt;/a&gt; ou &lt;a href=&quot;https://litmuschaos.io/&quot;&gt;Litmus Chaos&lt;/a&gt;, que nous allons peut-√™tre prototyper pour les comparer √† &lt;a href=&quot;https://github.com/DataDog/chaos-controller&quot;&gt;chaos-controller&lt;/a&gt; que nous avons r√©cemment exp√©riment√©.&lt;/p&gt;

&lt;p&gt;Au cours de la conf√©rence, &lt;em&gt;‚ÄúCase Study: Bringing Chaos Engineering to the Cloud Native Developers‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=KSl-oKk6TPA&quot;&gt;vid√©o&lt;/a&gt;) par Uma Mukkara, Litmus et Ramiro Berelleza, Okteto, nous avons pu avoir un aper√ßu de l‚Äôoutil de chaos Litmus, sa force semblant r√©sider dans le partage des scripts de chaos au sein la communaut√©.&lt;br /&gt;
Puis, il a √©t√© d√©crit une approche CI des tests de chaos visant √† int√©grer certains tests de chaos dans le flux de d√©veloppement plut√¥t qu‚Äô√† la fin.&lt;/p&gt;

&lt;p&gt;Enfin, toujours sur des questions de r√©silience en cas d‚Äôinterruption de service, dans sa conf√©rence &lt;em&gt;‚ÄúBuilding for the (inevitable) Next Cloud Outage‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=02a8VB__UQ4&quot;&gt;vid√©o&lt;/a&gt;), Pavel Nikolov de &lt;a href=&quot;https://www.section.io/&quot;&gt;Section&lt;/a&gt; nous a questionn√©s sur la mani√®re d‚Äô√™tre plus robuste √† une catastrophe.&lt;br /&gt;
La question n‚Äôest pas de savoir si une catastrophe se produira, mais quand elle se produira. C‚Äôest pourquoi il est aussi pr√©f√©rable de disposer d‚Äôun plan de reprise apr√®s sinistre mais surtout de pr√©voir en amont un syst√®me d‚Äôauto-gu√©rison permettant d‚Äô√™tre plus r√©silient aux catastrophes.&lt;br /&gt;
Il nous a ensuite pr√©sent√© un &lt;em&gt;use case&lt;/em&gt; sp√©cifique au r√©seau, nous invitant √† pr√©f√©rer au traditionnel ‚ÄúDNS √† la rescousse‚Äù, la mise en place de BGP (Border Gateway Protocol).&lt;/p&gt;

&lt;h2 id=&quot;quelques-sujets-divers&quot;&gt;Quelques sujets divers&lt;/h2&gt;

&lt;p&gt;√Ä travers quelques talks, nous avons jet√© des coups d‚Äô≈ìil sur des sujets sur lesquels nous ne travaillons pas r√©ellement au quotidien ‚Äì appelez √ßa de la curiosit√© intellectuelle si vous le voulez ;-)&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Nous avons vu un ensemble de design patterns pour le d√©veloppement de controllers Kubernetes (&lt;a href=&quot;https://www.youtube.com/watch?v=I1-s7AxD1Ls&quot;&gt;vid√©o&lt;/a&gt;), approche qui devient petit √† petit un moyen r√©pandu de r√©pondre √† des probl√©matiques, en codant directement dans Kubernetes.&lt;/li&gt;
  &lt;li&gt;La conf√©rence &lt;em&gt;‚ÄúA treasure map of hacking (and defending) K8s‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=1HbwfpE4XKY&quot;&gt;vid√©o&lt;/a&gt;) √©tait tr√®s sympathique, elle montrait √† quel point il peut √™tre &lt;em&gt;‚Äúfacile‚Äù&lt;/em&gt; de prendre le contr√¥le d‚Äôune infrastructure. Une fa√ßon de montrer que patcher est obligatoire¬†!&lt;/li&gt;
  &lt;li&gt;Et dans un registre hors-technique, &lt;em&gt;‚ÄúComposability is to software as compounding interest is to finance‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=25aVkm89ZT8&quot;&gt;vid√©o&lt;/a&gt;) mettait en √©vidence √† quel point, en construisant des outils, puis des projets, puis un √©cosyst√®me, les uns profitent aux autres, on construit donc plus grand et plus gros. Il suffit de voir le landscape CNCF aujourd‚Äôhui par rapport √† 4 ans en arri√®re.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion-kubecon-europe-2022&quot;&gt;Conclusion, KubeCon Europe 2022&lt;/h2&gt;

&lt;p&gt;Nous avons commenc√© √† migrer vers Le Cloud, vers AWS et Kubernetes, il y a plus de quatre ans. Notre premi√®re KubeCon √©tait √† Copenhague, en 2018. Que dire, en conclusion de cette conf√©rence annuelle¬†? Comment conclure ces articles¬†?&lt;/p&gt;

&lt;p&gt;Aujourd‚Äôhui, les grandes id√©es que nous avons retenues de cette KubeCon Europe 2022, en r√©sumant, sont les suivantes¬†:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Les probl√©matiques d‚Äôauto-scaling sont bien cern√©es, les outils sont plut√¥t matures. Comme beaucoup d‚Äôautres entreprises, nous arrivons sur l‚Äô√©tape suivante, qui est de dimensionner en tenant mieux compte des couts et pas uniquement des performances et/ou de la disponibilit√©.&lt;/li&gt;
  &lt;li&gt;La gestion des co√ªts dans Kubernetes n‚Äôest toujours pas simple. √Ä la fois pour les suivre et les r√©partir, mais aussi pour d√©cider du bon compromis entre performances¬†/ disponibilit√©¬†/ souplesse¬†/ autonomie des √©quipes¬†/ couts.&lt;/li&gt;
  &lt;li&gt;Service Mesh¬†: nous n‚Äôavons toujours pas franchi le pas et Istio, qui √©tait un sujet tr√®s √† la mode il y a quatre ans, nous semble d√©sormais presque oubli√©. Aujourd‚Äôhui, Cilium semble √™tre la nouvelle approche qui s‚Äôimpose, et il se pourrait que nous jouions avec &lt;em&gt;‚Äúpour voir‚Äù&lt;/em&gt; prochainement‚Ä¶&lt;/li&gt;
  &lt;li&gt;L‚Äôobservabilit√©, plus vraiment un probl√®me.&lt;/li&gt;
  &lt;li&gt;Le chaos engineering¬†/ chaos testing¬†: toujours une id√©e s√©duisante, mais pas encore r√©ellement industrialis√©e¬†?&lt;/li&gt;
  &lt;li&gt;L‚Äôoutillage autour de la CI/CD, le d√©ploiement progressif, le rollback (possiblement automatis√©) progresse, et √ßa fait plaisir¬†!&lt;/li&gt;
  &lt;li&gt;L‚Äô√©cosyst√®me progresse, m√ªrit, et on parle de sujets de plus haut niveau que quelques ann√©es en arri√®re. Par exemple, nous avons entendu plusieurs fois parler de base de donn√©es magiquement scalable h√©berg√©e dans Kubernetes, alors que l‚Äô√©poque o√π nous √©vitions de stocker quelque √©tat que ce soit dans un cluster ne nous semble pas si lointaine¬†!&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Et, pour finir, quelques points dont nous n‚Äôavons pas du tout ou tr√®s peu entendu parler¬†:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Nous avons peut-√™tre loup√© des choses en cr√©ant nos programmes, mais nous n‚Äôavons vu aucun talk autour de &lt;em&gt;‚Äúcomment nous d√©veloppons des applications cloud-native‚Äù&lt;/em&gt;. Pourtant, la probl√©matique de l‚Äôenvironnement de d√©veloppement, avec des services manag√©s, des d√©ploiements vers Kubernetes et des plateformes distribu√©es, ne nous parait pas encore r√©gl√©e¬†!&lt;/li&gt;
  &lt;li&gt;L‚Äôapproche ‚ÄúFaaS‚Äù (Function as a Service) nous para√Æt encore moins r√©pandue que quelques ann√©es en arri√®re¬†?&lt;/li&gt;
  &lt;li&gt;Nous n‚Äôavons pas entendu parler une seule fois de &lt;em&gt;F√©d√©ration&lt;/em&gt;, alors que le terme revenait encore et encore il y a quatre ans. Nous avons bien fait de ne m√™me pas essayer, on dirait¬†;-)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/end-part4.jpg&quot; alt=&quot;&amp;quot;La fin d&apos;une aventure¬†!&amp;quot;&quot; /&gt;&lt;/p&gt;
&lt;center&gt;&lt;i&gt;Rejoignez-nos √©quipes et venez vivre les prochaines conf√©rences avec nous l‚Äôan prochain&lt;/i&gt;&lt;/center&gt;</content><author><name>Bedrock</name></author><category term="kubecon" /><category term="kubernetes" /><category term="cloud" /><category term="k8s" /><category term="conference" /><summary type="html">Pour terminer cette s√©rie, un ou deux sujets divers que nous n‚Äôavons pas regroup√© dans les trois articles pr√©c√©dents (les performances applicatives et la scalabilit√©, les performances bas niveau, le syst√®me et le r√©seau, la dev XP, l‚Äôoutillage, la CI/CD et l‚Äôobservabilit√©), puis une conclusion globale avec ce que nous avons retenu de cette KubeCon Europe 2022.</summary></entry><entry><title type="html">Bedrock √† la Kubecon 2022, 3√®me partie¬†: Dev XP, outillage, CI/CD, observabilit√©‚Ä¶</title><link href="https://tech.bedrockstreaming.com/2022/06/15/kubecon-2022-part-3.html" rel="alternate" type="text/html" title="Bedrock √† la Kubecon 2022, 3√®me partie¬†: Dev XP, outillage, CI/CD, observabilit√©‚Ä¶" /><published>2022-06-15T00:00:00+00:00</published><updated>2022-06-15T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/2022/06/15/kubecon-2022-part-3</id><content type="html" xml:base="https://tech.bedrockstreaming.com/2022/06/15/kubecon-2022-part-3.html">&lt;p&gt;Pour notre troisi√®me article de cette s√©rie sur ce que nous avons retenu de la KubeCon Europe 2022, apr√®s 
&lt;a href=&quot;/2022/06/13/kubecon-2022-part-1.html&quot;&gt;les performances applicatives et la scalabilit√©&lt;/a&gt; et 
&lt;a href=&quot;/2022/06/14/kubecon-2022-part-2.html&quot;&gt;les performances bas niveau, le syst√®me et le r√©seau&lt;/a&gt;, 
passons √† la Developper eXperience, √† l‚Äôoutillage, √† la CI/CD, aux rollback, √† l‚Äôobservabilit√© et aux incidents¬†!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/part3.jpg&quot; alt=&quot;&amp;quot;KubeCon 2022 part3&amp;quot;&quot; /&gt;&lt;/p&gt;
&lt;center&gt;&lt;i&gt;Une nouvelle journ√©e commence, @ KubeCon 2022¬†!&lt;/i&gt;&lt;/center&gt;

&lt;h2 id=&quot;la-prod-est-tomb√©e&quot;&gt;La prod est tomb√©e¬†!&lt;/h2&gt;

&lt;p&gt;Dans notre secteur d‚Äôactivit√©, nous avons tous subis des incidents de production et le retour d‚Äôexp√©rience, qu‚Äôil soit interne ou public, est important et formateur.&lt;br /&gt;
En effet, m√™me si les incidents de production sont malheureusement in√©luctables dans nos m√©tiers, il est important de les analyser afin de mieux les comprendre et demieux s‚Äôen pr√©munir.&lt;/p&gt;

&lt;p&gt;Preuve de l‚Äôimportance de ces sujets¬†: nous avons assist√© √† deux conf√©rences tr√®s int√©ressantes sur ce th√®me dans des salles pleines √† craquer¬†!&lt;br /&gt;
Toutes deux portaient sur des incidents de production majeurs suite √† une modification de code qui peut para√Ætre anodine¬†: la premi√®re √©tait donn√©e par Influxdata, la seconde par Skyscanner.&lt;br /&gt;
Les conf√©rences √©taient particuli√®rement joviales et bienveillantes¬†: les r√©actions du public √† certains slides montraient bien que ce genre de situations sentait le v√©cu pour certains¬†!&lt;/p&gt;

&lt;p&gt;Nous avons tous √† apprendre de ces cas concrets d‚Äôincident, aussi, nous vous conseillons de visionner les vid√©os de ces conf√©rences¬†: &lt;a href=&quot;https://www.youtube.com/watch?v=FiEm2zOuHsg&quot;&gt;skyscanner&lt;/a&gt; et &lt;a href=&quot;https://www.youtube.com/watch?v=xDGjmav8UBg&quot;&gt;influxdata&lt;/a&gt;.&lt;br /&gt;
Mais si nous devions les r√©sumer¬†: l‚Äôautomatisation de bout en bout demande une grande maturit√©, beaucoup &lt;em&gt;(beaucoup¬†!)&lt;/em&gt; de tests et des reviews de qualit√©¬†!&lt;/p&gt;

&lt;p&gt;Et comme il est dit dans une des slides¬†:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/part3-gitops-power-responsibility.png&quot; alt=&quot;&amp;quot;With great GitOps power‚Ä¶&amp;quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;debugger-en-production-avec-des-conteneurs-√©ph√©m√®res&quot;&gt;Debugger, en production, avec des conteneurs √©ph√©m√®res&lt;/h2&gt;

&lt;p&gt;Nous utilisons r√©guli√®rement la commande &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl exec&lt;/code&gt; pour &lt;em&gt;entrer dans conteneur / pod&lt;/em&gt; et y lancer des commandes de d√©bogage ‚Äì parce que certains probl√®mes ne sont pas reproductibles ailleurs qu‚Äôen production, ou parce qu‚Äôil faut comprendre ce qu‚Äôil se passe avant de savoir reproduire en environnement de d√©veloppement.&lt;/p&gt;

&lt;p&gt;Cela dit, cette approche n‚Äôest &lt;em&gt;pas g√©niale&lt;/em&gt;¬†: si nous modifions des choses dans un conteneur, ces modifications persistent.&lt;br /&gt;
Aussi, il faut pouvoir installer des outils de d√©bug dans un conteneur &lt;em&gt;(ce qu‚Äôon ne peut pas facilement faire chez Bedrock, o√π nos conteneurs ne s‚Äôex√©cutent pas en root et ont souvent un filesystem read-only)&lt;/em&gt;, ou les embarquer dans les images &lt;em&gt;(ce qui les grossit consid√©rablement, sans compter l‚Äôaugmentation du risque de failles de s√©curit√©)&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Pour rem√©dier √† cette probl√©matique, la fonctionnalit√© de conteneurs √©ph√©m√®res (&lt;a href=&quot;https://www.youtube.com/watch?v=obasTgzhVR0&quot;&gt;vid√©o&lt;/a&gt;) arrive en b√™ta dans Kubernetes 1.23 et √ßa semble absolument g√©nial¬†!&lt;br /&gt;
L‚Äôoutil &lt;strong&gt;parfait&lt;/strong&gt; pour lancer des conteneurs temporaires √† l‚Äôint√©rieur de pods existant et incroyablement puissant pour d√©bugger¬†!&lt;br /&gt;
Nous allons pouvoir r√©duire le nombre d‚Äôoutils de debug int√©gr√©s √† nos images et parvenir √† d√©bugger plus ais√©ment des probl√®mes qui ne surviennent qu‚Äôen production¬†!&lt;/p&gt;

&lt;h2 id=&quot;les-risques-de-lobservabilit√©--observabilit√©-pirat√©e&quot;&gt;Les risques de l‚Äôobservabilit√© / Observabilit√© pirat√©e&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;‚ÄúHow attackers use exposed Prometheus Server to Exploit Kubernetes Clusters‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=5cbbm_L6n7w&quot;&gt;vid√©o&lt;/a&gt;) par David de Torres et  Miguel Hernandez, ou &lt;em&gt;‚Äúcomment obtenir l‚Äôempreinte de vos clusters k8s √† travers vos donn√©es de monitoring‚Äù&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Sysdig est venu nous rem√©morer que le monitoring, c‚Äôest bien, mais que ne pas exposer ses donn√©es de monitoring, c‚Äôest mieux¬†!&lt;br /&gt;
En effet, attention aux informations qui sont expos√©es √† l‚Äôext√©rieur, elles pourraient √™tre recueillies par des attaquants externes pour acqu√©rir des connaissances sur votre plateforme (provider cloud, version de l‚ÄôOS utilis√©‚Ä¶) et s‚Äôen servir ensuite pour s‚Äôintroduire dans votre infrastructure (fuite de donn√©es, cryptominage ou ransomware).&lt;/p&gt;

&lt;p&gt;√Ä travers un cas d‚Äôutilisation fictif, ils nous ont d√©montr√© la facilit√© de r√©cup√©ration de ces informations et comment elles sont utilis√©es pour monter une attaque.&lt;br /&gt;
Enfin, ils nous ont rappel√© que pour se pr√©munir de ces attaques, il &lt;em&gt;suffit&lt;/em&gt; de suivre les recommandations de s√©curit√©¬†! CQFD.&lt;br /&gt;
Il est toujours bon d‚Äôavoir ces piqures de rappel et de toujours bien penser aux donn√©es que l‚Äôon expose vers l‚Äôext√©rieur.&lt;/p&gt;

&lt;h2 id=&quot;cicd-d√©ploiement-progressif&quot;&gt;CI/CD, d√©ploiement progressif&lt;/h2&gt;

&lt;p&gt;Chez Bedrock, nous sommes en pleine refonte de notre cha√Æne de CI/CD¬†: nous basculons tous nos projets du bon &lt;em&gt;vieux Jenkins ‚Äútemporaire‚Äù&lt;/em&gt;, que nous avions mont√© au d√©but de &lt;a href=&quot;https://leanpub.com/6cloud/&quot;&gt;notre migration vers Le Cloud&lt;/a&gt;, vers Github Actions.&lt;br /&gt;
Au passage, nous nous demandons forc√©ment comment nous pourrions am√©liorer nos d√©ploiements et les rendre plus s√©curis√©s, tant pour la sant√© de notre plateforme que pour la paix d‚Äôesprit de nos √©quipes et de nos utilisateurs.&lt;/p&gt;

&lt;p&gt;La conf√©rence &lt;em&gt;‚ÄúAutomated progressive delivery using gitops and service mesh‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=5Ko-CnP2qhA&quot;&gt;vid√©o&lt;/a&gt;) parlait de d√©ploiement progressif avec &lt;a href=&quot;https://argo-cd.readthedocs.io/en/stable/&quot;&gt;Argo CD&lt;/a&gt;, pour am√©liorer l‚Äôexcellence op√©rationnelle, r√©duire le MTTR, accro√Ætre l‚Äôautomatisation et la fiabilit√© des processus de d√©ploiement. Bref, des id√©es qui nous parlent¬†!&lt;/p&gt;

&lt;p&gt;Reste des fonctionnalit√©s, qui nous semblent primordiales avant de se lancer sur un autre outil, qui ne sont pas encore g√©r√©es, h√©las¬†: mirroring de traffic, routing bas√© sur des en-t√™tes (typiquement¬†: pour faire du d√©ploiement progressif √† la maille &lt;em&gt;‚Äúutilisateur‚Äù&lt;/em&gt; et pas √† la maille &lt;em&gt;‚Äúrequ√™te HTTP‚Äù&lt;/em&gt;), d√©tection d‚Äôanomalie et rollback automatis√©‚Ä¶&lt;br /&gt;
Un projet √† suivre, donc, qui pourrait m√ªrir dans les prochains mois.&lt;/p&gt;

&lt;p&gt;Au niveau des aspects moins sympathiques¬†: cette approche de d√©ploiement progressif passe par un service mesh (&lt;a href=&quot;https://www.envoyproxy.io/&quot;&gt;envoy&lt;/a&gt;, ici).&lt;br /&gt;
Or nous n‚Äôen avons pas en place et depuis quatre ans n‚Äôavons toujours pas trouv√© les bons arguments pour en introduire dans nos clusters, notamment √† cause de la complexit√© ajout√©e‚Ä¶&lt;/p&gt;

&lt;p&gt;Une autre conf√©rence (&lt;a href=&quot;https://www.youtube.com/watch?v=Mh0Wqu3v8h0&quot;&gt;vid√©o&lt;/a&gt;) mentionnait l‚Äôoutil &lt;a href=&quot;https://flagger.app/&quot;&gt;Flagger&lt;/a&gt; pour des d√©ploiements Canary.&lt;/p&gt;

&lt;h2 id=&quot;quelques-autres-id√©es-√†-retenir&quot;&gt;Quelques autres id√©es √† retenir&lt;/h2&gt;

&lt;p&gt;Nous avons aussi vu quelques autres conf√©rences dont nous avons tir√© quelques id√©es, en plus bref¬†:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Kubernetes 1.23 apporte (en alpha) une nouvelle commande &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl events&lt;/code&gt;, qui retourne ses r√©sultats dans l‚Äôordre chronologique. Ce que l‚Äôactuel &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl get events&lt;/code&gt; ne fait pas et √ßa peut √™tre bien emb√™tant. Vue comme de la culture g√©n√©rale, la conf√©rence &lt;em&gt;‚ÄúThe soul of a new command: adding ‚Äòevents‚Äô to kubectl‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=YI1ZuN-OHNw&quot;&gt;vid√©o&lt;/a&gt;) racontait comment cette fonctionnalit√© a √©t√© impl√©ment√©e et √©tait fort int√©ressante.&lt;/li&gt;
  &lt;li&gt;Un speaker parlait de la mise en place de &lt;a href=&quot;https://crossplane.io/&quot;&gt;Crossplane&lt;/a&gt; dans son entreprise (&lt;a href=&quot;https://www.youtube.com/watch?v=XyR9DGnOpXo&quot;&gt;vid√©o&lt;/a&gt;). Sujet potentiellement int√©ressant, mais qui ne correspond pas √† notre approche actuelle. Nous avons toutefois retenu quelques points autour de comment il fournit des outils √† ses coll√®gues d√©veloppeurs¬†: documentation, composition de services, management d‚Äôattentes, utilisation de l‚Äô√©cosyst√®me‚Ä¶ Des probl√©matiques auxquelles nous nous sommes confront√©s de nombreuses fois, pour encourager nos √©quipes √† adopter des √©volutions ou de nouveaux outils¬†!&lt;/li&gt;
  &lt;li&gt;Si vous commencez √† mettre en place votre stack de logs, la conf√©rence &lt;em&gt;‚ÄúShow me your labels and I‚Äôll tell you who you are‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=TWf1ho0XMyM&quot;&gt;vid√©o&lt;/a&gt;) est faite pour vous. L‚Äôid√©e d‚Äôutiliser les labels assign√©s aux pods pour aller jusqu‚Äô√† filtrer l‚Äôacc√®s aux logs via RBAC, terrible¬†! Aussi, la cr√©ation de flux de logs avec &lt;a href=&quot;https://github.com/banzaicloud/logging-operator&quot;&gt;Logging Operator&lt;/a&gt; a l‚Äôair fort sympathique. Si ce talk √©tait venu trois ans plus t√¥t, c‚Äôest quelque chose que nous essayerons¬†!&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Ces conf√©rences nous ont permis d‚Äôapprofondir les questions que nous nous posons actuellement alors que notre changeons de CI/CD (d√©ploiement progressif, rollback automatis√© ou non‚Ä¶).&lt;/p&gt;

&lt;p&gt;Plus globalement, nous sommes contents de voir que l‚Äôoutillage autour de Kubernetes continue √† progresser et que la Developer eXperience est un sujet pris au s√©rieux dans notre communaut√©.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/end-part3.jpg&quot; alt=&quot;&amp;quot;Apr√®s une journ√©e de conf√©rences, une promenade √† Valencia¬†!&amp;quot;&quot; /&gt;&lt;/p&gt;
&lt;center&gt;&lt;i&gt;Rejoignez-nos √©quipes et venez vivre les prochaines conf√©rences avec nous l‚Äôan prochain&lt;/i&gt;&lt;/center&gt;</content><author><name>Bedrock</name></author><category term="kubecon" /><category term="kubernetes" /><category term="cloud" /><category term="k8s" /><category term="conference" /><summary type="html">Pour notre troisi√®me article de cette s√©rie sur ce que nous avons retenu de la KubeCon Europe 2022, apr√®s les performances applicatives et la scalabilit√© et les performances bas niveau, le syst√®me et le r√©seau, passons √† la Developper eXperience, √† l‚Äôoutillage, √† la CI/CD, aux rollback, √† l‚Äôobservabilit√© et aux incidents¬†!</summary></entry><entry><title type="html">Bedrock √† la Kubecon 2022, 2nde partie : performances, syst√®me et r√©seau</title><link href="https://tech.bedrockstreaming.com/2022/06/14/kubecon-2022-part-2.html" rel="alternate" type="text/html" title="Bedrock √† la Kubecon 2022, 2nde partie : performances, syst√®me et r√©seau" /><published>2022-06-14T00:00:00+00:00</published><updated>2022-06-14T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/2022/06/14/kubecon-2022-part-2</id><content type="html" xml:base="https://tech.bedrockstreaming.com/2022/06/14/kubecon-2022-part-2.html">&lt;p&gt;Pour ce second article de synth√®se de la KubeCon Europe 2022, continuons sur le th√®me des performances, peut-√™tre plus bas niveau,
et plongeons aussi dans des outils pouvant √™tre d√©ploy√©s au c≈ìur de nos clusters !&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/part2.jpg&quot; alt=&quot;&amp;quot;KubeCon 2022 part2&amp;quot;&quot; /&gt;&lt;/p&gt;
&lt;center&gt;&lt;i&gt;Ca va commencer, @ KubeCon 2022¬†!&lt;/i&gt;&lt;/center&gt;

&lt;h2 id=&quot;lautoscaling-autrement&quot;&gt;L‚Äôautoscaling, autrement&lt;/h2&gt;

&lt;p&gt;Une des conf√©rences : &lt;em&gt;‚ÄúAutoscaling Kubernetes Deployments: A (Mostly) Practical Guide‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=n8t_hbchQcc&quot;&gt;vid√©o&lt;/a&gt;) pr√©sent√© par NewRelic pr√©sentait le principe &lt;em&gt;d‚Äôautoscaling&lt;/em&gt; dans Kubernetes, avec les trois principales ressources associ√©es √† ce concept : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ClusterAutoscaler&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;HorizontalPodAutoscaler&lt;/code&gt; et &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;VerticalPodAutoscler&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Cette conf√©rence pr√©sentait :&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;le fonctionnement du scale up/down des pods avec les p√©riodes de stabilisation¬†;&lt;/li&gt;
  &lt;li&gt;le calcul par rapport aux indicateurs utilis√©s¬†;&lt;/li&gt;
  &lt;li&gt;les types de m√©triques utilisables par les HPA et VPA.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Pas de grande d√©couverte technique pour nous, mais cette conf√©rence nous a surtout permis de confirmer que, chez BedRock, 
nous sommes de plus en plus matures sur la scalabilit√© de nos clusters Kubernetes.&lt;/p&gt;

&lt;p&gt;La conf√©rence donn√©e par AWS (&lt;a href=&quot;https://www.youtube.com/watch?v=UBb8wbfSc34&quot;&gt;vid√©o&lt;/a&gt;) portait sur deux aspects¬†:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Premi√®rement, l‚Äôutilisation d‚Äôinstances &lt;em&gt;Spot&lt;/em&gt; (une option √† ne pas n√©gliger si vous souhaitez fortement r√©duire vos co√ªts de &lt;em&gt;compute&lt;/em&gt;) et les bonnes pratiques √† mettre en place en utilisant ce type d‚Äôinstances EC2.&lt;/li&gt;
  &lt;li&gt;Le second traitait de la scalabilit√© des n≈ìuds avec ClusterAutoscaler mais pr√©sentait un nouvel outil de provisionnement de n≈ìuds Kubernetes propos√© par AWS¬†: &lt;a href=&quot;https://karpenter.sh/&quot;&gt;Karpenter&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Une des diff√©rences notables par rapport √† cluster-autoscaler est que Karpenter ne fonctionne pas avec des AutoScalingGroup AWS 
mais provisionne directement des instances EC2.&lt;br /&gt;
Outre cette fonctionnalit√©, Karpenter est actuellement √† l‚Äô√©tude chez BedRock, notamment car il permet l‚Äôutilisation de la 
dimension &lt;em&gt;r√©gion&lt;/em&gt;, ce qui n‚Äôest pas possible avec cluster-autoscaler et nous pose des probl√®mes avec nos statefullsets dans des ASG multiAZ.&lt;/p&gt;

&lt;h2 id=&quot;r√©seau-bande-passante-et-gpu&quot;&gt;R√©seau, Bande passante et GPU&lt;/h2&gt;

&lt;p&gt;Autre point abord√© lors de la KubeCon¬†: comment int√©grer la bande passante comme une ressource limitante, de la m√™me fa√ßon que le CPU et la RAM actuellement.&lt;br /&gt;
Nous avons pu suivre deux pr√©sentations √† ce sujet¬†: &lt;em&gt;‚ÄúNetwork-aware Scheduling in Kubernetes‚Äù&lt;/em&gt; de Jos√© Santos, Ghent University (&lt;a href=&quot;https://www.youtube.com/watch?v=E4cP275_OCs&quot;&gt;video&lt;/a&gt; et &lt;em&gt;‚ÄúBetter Bandwidth Management with eBPF‚Äù&lt;/em&gt; de Daniel Borkmann et Christopher M. Luciano, Isovalent (&lt;a href=&quot;https://www.youtube.com/watch?v=QTSS6ktK8hY&quot;&gt;video&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;La premi√®re session proposait un nouveau plugin (&lt;a href=&quot;https://github.com/kubernetes-sigs/scheduler-plugins/tree/master/kep/260-network-aware-scheduling&quot;&gt;repo github&lt;/a&gt;) pour permettre l‚Äôorchestration du d√©ploiement de nouveaux pods en fonction de leur charge et co√ªt r√©seau, afin de r√©duire la latence des d√©ploiements.&lt;br /&gt;
Une nouvelle fonctionnalit√© de ce plugin est par ailleurs en d√©veloppement et permettra d‚Äô√©viter de d√©ployer sur un n≈ìud ou la bande passante est d√©j√† satur√©e.&lt;/p&gt;

&lt;p&gt;La seconde pr√©sentation exposait comment eBPF permet de mettre en place de nouveaux pods en prenant en compte la bande passante. Le replay de la conf√©rence est disponible &lt;a href=&quot;https://www.youtube.com/watch?v=QTSS6ktK8hY&quot;&gt;ici&lt;/a&gt;, nous vous conseillons son visionnage.&lt;br /&gt;
Cette approche pourrait √™tre tr√®s int√©ressante pour Bedrock si nous d√©cidions de migrer &lt;a href=&quot;/2021/12/15/scaling-bedrock-video-delivery-to-50-million-users&quot;&gt;notre plateforme VOD&lt;/a&gt; sur un cluster Kubernetes¬†: en effet, elle nous permettrait de mieux g√©rer les burst r√©seaux et le throttling de la bande passante qui se produisent sur nos instances.&lt;/p&gt;

&lt;p&gt;C√¥t√© GPU, Google, dans son expos√© &lt;em&gt;‚ÄúImproving GPU Utilization using Kubernetes‚Äù&lt;/em&gt; de Maulin Patel et Pradeep Venkatachalam (&lt;a href=&quot;https://www.youtube.com/watch?v=X876kr-LkPA&quot;&gt;video&lt;/a&gt;), nous a pr√©sent√© deux fa√ßons de partager des ressources GPU dans un cluster kubernetes¬†:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;soit en partageant le temps d‚Äôutilisation (timesharing, temporal multiplexing) entre conteneurs sur un m√™me n≈ìud,&lt;/li&gt;
  &lt;li&gt;soit en multi-instance GPU (MIG, spatial multiplexing) permettant de partager les ressources en parall√®le entre conteneur en allouant une partie des c≈ìurs GPU et de sa m√©moire pour chaque conteneur.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Cette conf√©rence sur l‚Äôutilisation des GPU dans un cluster k8s nous incite √† r√©fl√©chir aux optimisations que nous pourrions faire sur nos plateformes vid√©o et data‚Ä¶&lt;/p&gt;

&lt;h2 id=&quot;service-mesh-cilium&quot;&gt;Service Mesh¬†: Cilium&lt;/h2&gt;

&lt;p&gt;Au cours de diverses conf√©rences, nous avons plusieurs fois entendu le nom de &lt;em&gt;‚ÄúCilium‚Äù&lt;/em&gt; associ√© au concept de &lt;em&gt;Service Mesh&lt;/em&gt;.&lt;br /&gt;
La conf√©rence &lt;em&gt;‚ÄúA guided tour of Cilium Service Mesh‚Äù&lt;/em&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=e10kDBEsZw4&quot;&gt;vid√©o&lt;/a&gt;) nous a permis d‚Äôen apprendre plus sur ce nouveau service qui ne se base plus sur des sidecars, mais sur eBPF.&lt;/p&gt;

&lt;p&gt;Un outil peut-√™tre encore un peu jeune, mais clairement prometteur ‚Äì et tr√®s certainement quelque chose que nous allons √©tudier lors d‚Äôun POC dans le courant de l‚Äôann√©e¬†;-)&lt;/p&gt;

&lt;h2 id=&quot;r√©capitulatif&quot;&gt;R√©capitulatif&lt;/h2&gt;

&lt;p&gt;Il n‚Äôexiste toujours pas d‚Äôoutils magique pour passer √† l‚Äô√©chelle et supporter les pics de charges.&lt;br /&gt;
Toutefois, les solutions pr√©sent√©es au cours de cette KubeCon EU 2022 viennent r√©pondre √† des besoins qui sont apparus au fil des ann√©es et dont peu d‚Äôutilisateurs avaient mesur√© l‚Äôimpact au d√©but de leur p√©riple avec Kubernetes.&lt;/p&gt;

&lt;p&gt;Aussi, eBPF continue √† faire parler de lui et son utilisation semble se r√©pandre.&lt;br /&gt;
L‚Äôid√©e d‚Äôun service mesh plus l√©ger que Istio, par exemple, a l‚Äôair fort int√©ressante¬†!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/end-part2.jpg&quot; alt=&quot;&amp;quot;Instant d√©tente pour d√©briefer de la seconde journ√©e de la KubeCon 2022&amp;quot;&quot; /&gt;&lt;/p&gt;
&lt;center&gt;&lt;i&gt;Rejoignez-nos √©quipes et venez vivre les prochaines conf√©rences avec nous l‚Äôan prochain&lt;/i&gt;&lt;/center&gt;</content><author><name>Bedrock</name></author><category term="kubecon" /><category term="kubernetes" /><category term="cloud" /><category term="k8s" /><category term="conference" /><summary type="html">Pour ce second article de synth√®se de la KubeCon Europe 2022, continuons sur le th√®me des performances, peut-√™tre plus bas niveau, et plongeons aussi dans des outils pouvant √™tre d√©ploy√©s au c≈ìur de nos clusters !</summary></entry><entry><title type="html">Bedrock √† la kubecon 2022, 1ere partie : performances applicatives et scalabilit√©</title><link href="https://tech.bedrockstreaming.com/2022/06/13/kubecon-2022-part-1.html" rel="alternate" type="text/html" title="Bedrock √† la kubecon 2022, 1ere partie : performances applicatives et scalabilit√©" /><published>2022-06-13T00:00:00+00:00</published><updated>2022-06-13T00:00:00+00:00</updated><id>https://tech.bedrockstreaming.com/2022/06/13/kubecon-2022-part-1</id><content type="html" xml:base="https://tech.bedrockstreaming.com/2022/06/13/kubecon-2022-part-1.html">&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/part1.jpg&quot; alt=&quot;&amp;quot;KubeCon 2022 part1&amp;quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;bedrock-√†-la-kubecon-2022&quot;&gt;BEDROCK √† la KubeCon 2022&lt;/h2&gt;

&lt;p&gt;Apr√®s 2018 √† Copenhague et 2019 √† Barcelone, cette ann√©e encore, nous √©tions trois, &lt;a href=&quot;https://twitter.com/_CoralinePetit&quot;&gt;Coraline&lt;/a&gt;, &lt;a href=&quot;https://twitter.com/julien_menan&quot;&gt;Julien&lt;/a&gt; et &lt;a href=&quot;https://twitter.com/pascal_martin&quot;&gt;Pascal&lt;/a&gt;, pr√©sents √† la KubeCon CloudNativeCon Europe 2022, √† Valencia !&lt;/p&gt;

&lt;p&gt;Plus de quatre ans apr√®s le d√©but de notre migration vers Le Cloud (AWS + Kubernetes) racont√©e dans &lt;a href=&quot;https://leanpub.com/6cloud/&quot;&gt;Le Plan Copenhague&lt;/a&gt;, nous visions √† d√©couvrir de nouvelles id√©es, √† confirmer certains de nos choix et √† apprendre des retours d‚Äôexp√©rience de nos pairs. Apr√®s tout, avec une communaut√© aussi large (plus de 7000 participants et participantes cette ann√©e), il serait dommage de rester seuls avec nos id√©es !&lt;/p&gt;

&lt;h2 id=&quot;sommaire&quot;&gt;Sommaire&lt;/h2&gt;

&lt;p&gt;√Ä trois, nous avons assist√© √† une grosse quarantaine de conf√©rences. Nous avons choisi d‚Äôorganiser nos notes par th√®mes, en quatre articles :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Un premier, celui-ci, centr√© sur les performances applicatives, sur la scalabilit√© des applications et la gestion des co√ªts.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/2022/06/14/kubecon-2022-part-2.html&quot;&gt;Le second, consacr√© aux performances syst√®me, aux services mesh, aux fonctionnalit√©s au niveau du cluster.&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/2022/06/15/kubecon-2022-part-3.html&quot;&gt;Le troisi√®me, pour regrouper ce qui est Dev XP, outillage, CI/CD, rollback, observabilit√©‚Ä¶&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Et &lt;a href=&quot;/2022/06/16/kubecon-2022-part-4.html&quot;&gt;un dernier, pour quelques sujets divers, dont le chaos engineering et la r√©silience, et pour conclure sur ce que nous avons retenu de cette √©dition de la KubeCon publication jeudi&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Avec une plateforme de VOD et de replay d√©ploy√©e en marque blanche pour des broadcasters europ√©en majeurs, des millions d‚Äôutilisateurs actifs, des milliers de CPU consomm√©s, des centaines d‚Äôinstances allum√©es et des dizaines de microservices, les performances sont au c≈ìur de nos pr√©occupations.&lt;/p&gt;

&lt;p&gt;Cet article reprend nos retours sur les nombreuses conf√©rences consacr√©es √† la scalabilit√© lors de cette KubeCon 2022. Cette fonctionnalit√© essentielle de Kubernetes est l‚Äôune des raisons de notre migration sur cette plateforme. En effet, notre activit√© n√©cessite que nous adaptions la taille de nos clusters en fonction du nombre d‚Äôutilisateurs connect√©s.
Nous avons donc assist√© √† la plupart des conf√©rences consacr√©es √† la performance et √† l‚Äôadaptation de celle-ci en fonction de nos besoins.&lt;/p&gt;

&lt;h3 id=&quot;le-scaling-vertical&quot;&gt;Le scaling vertical&lt;/h3&gt;
&lt;p&gt;La conf√©rence ‚ÄúHow Lombard Odier Deployed VPA to Increase Resource Usage Efficiency‚Äù (&lt;a href=&quot;https://www.youtube.com/watch?v=eAAio3KFm6w&quot;&gt;vid√©o&lt;/a&gt;) nous pr√©sentait comment fonctionnent les &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;requests&lt;/code&gt; et &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;limits&lt;/code&gt;.
Un sujet qui demande du temps pour √™tre efficace afin de ne pas √™tre en &lt;em&gt;oversizing&lt;/em&gt; ou au contraire en &lt;em&gt;undersizing&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Mais surtout, le conf√©rencier nous a pr√©sent√© son impl√©mentation d‚Äôun composant Kubernetes assez rarement utilis√© : Le VerticalPodAutoscaler. Le VPA √† fait r√©cemment l‚Äôobjet de discussions au sein de nos √©quipes et cette pr√©sentation a confirm√© notre ressenti : cette ressource est int√©ressante pour des cas d‚Äôusages sp√©cifiques, notamment sur des ‚Äúworkloads‚Äù assez consommateurs en RAM et/ou en CPU et ne pouvant pas √™tre d√©coup√©s en multiples pods via un HorizontalPodAutoscaler.&lt;/p&gt;

&lt;p&gt;le VPA souffre toujours d‚Äôune limitation : l‚Äôajout de RAM ou CPU √† chaud n‚Äôest pas possible et n√©cessite la re-cr√©ation du pod.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/vpa.jpg&quot; alt=&quot;&amp;quot;KubeCon 2022 day1&amp;quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;am√©liorer-la-scalabilit√©&quot;&gt;Am√©liorer la scalabilit√©&lt;/h3&gt;
&lt;p&gt;Une autre conf√©rence, donn√©e cette fois-ci par Intel, pr√©sentait un projet r√©cent : &lt;a href=&quot;https://github.com/intel/platform-aware-scheduling/tree/master/telemetry-aware-scheduling&quot;&gt;Telemetry Aware Scheduler&lt;/a&gt; (&lt;a href=&quot;https://www.youtube.com/watch?v=csg7ZQXQ5u8&quot;&gt;vid√©o&lt;/a&gt;). Cet outil permet d‚Äôam√©liorer les choix du scheduler de Kubernetes en s‚Äôappuyant sur des m√©triques ‚Äúcustoms‚Äù. Le projet est r√©cent et en ALPHA, mais √† surveiller dans l‚Äôavenir.&lt;/p&gt;

&lt;p&gt;Lors d‚Äôune autre conf√©rence intitul√©e ‚ÄúHow Adobe is optimizing resource usage in K8s‚Äù (&lt;a href=&quot;https://www.youtube.com/watch?v=iVD5YI1-U_M&quot;&gt;vid√©o&lt;/a&gt;), Carlos Sanchez a pr√©sent√© un outil interne permettant d‚Äô√©mettre des recommandations bas√©es sur un historique de m√©triques, un peu comme fait VPA, mais au niveau d‚Äôun namespace ou du cluster entier. Il est √©galement revenu sur comment ils parviennent √† √©teindre automatiquement des applications non utilis√©es par les clients pour r√©aliser des √©conomies cons√©quentes.&lt;/p&gt;

&lt;h4 id=&quot;mais-comment-configurer-les-requests-limits-et-tout-√ßa-sans-y-passer-des-mois-&quot;&gt;Mais comment configurer les requests, limits et tout √ßa‚Ä¶ sans y passer des mois ?&lt;/h4&gt;

&lt;p&gt;Notre plateforme est compos√©e de dizaines de services qui interagissent les uns avec les autres et sont soumis √† un trafic qui varie au quotidien, avec des pics parfois impressionnants. Le param√©trage des requests et limits de chaque conteneur, ainsi que d‚Äôautres ressources, comme le nombre de processus php-fpm par conteneur, est un travail de fourmi, o√π nous devons it√©rer quotidiennement pendant une ou deux semaines, en travaillant application par application. Et tout ce travail est √† refaire lorsque les applications ou leurs usages √©voluent‚Ä¶ un vrai casse-t√™te !.
Nous ne sommes pas les seuls √† rencontrer ces probl√©matiques et c‚Äô√©tait le sujet de la conf√©rence ‚ÄúGetting the optimal service efficiency that autoscaler won‚Äôt give you‚Äù (&lt;a href=&quot;https://www.youtube.com/watch?v=Z-G6yMavQrU&quot;&gt;vid√©o&lt;/a&gt;), o√π une approche bas√©e sur de l‚ÄôIA (ou, plut√¥t, sur du brute-force) √©tait pr√©sent√©e.&lt;/p&gt;

&lt;p&gt;Voici les grandes lignes de la m√©thodologie pr√©sent√©e :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;d√©finition d‚Äôun sc√©nario de load-test (ce qui reste difficile, il faut qu‚Äôil soit repr√©sentatif de la r√©alit√©)&lt;/li&gt;
  &lt;li&gt;D√©finition d‚Äôobjectifs (les temps de r√©ponses attendus, le pourcentage d‚Äôerreurs‚Ä¶ en fait, des SLOs que chacun devrait d√©j√† avoir pour ses services),&lt;/li&gt;
  &lt;li&gt;Lancer en boucle ces scenarios en retouchant &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;request&lt;/code&gt; et &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;limits&lt;/code&gt; (et configuration JVM) entre chaque it√©ration.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Sur un cas r√©el, apr√®s la 34·µâ it√©ration (r√©alis√©es en 19 heures), environ 49% d‚Äô√©conomies ont √©t√© r√©alis√©es. Mais surtout, cela a repr√©sent√© un jour de travail gr√¢ce √† cet outillage, au lieu de deux mois √† la main.&lt;/p&gt;

&lt;p&gt;Le logiciel utilis√© ne semble pas disponible en open-source, mais l‚Äôapproche ‚Äúautomatiser les it√©rations‚Äù en retouchant les param√®tres est tr√®s int√©ressante et nous saurions la reproduire. Elle nous permettrait de gagner beaucoup de temps, en supprimant beaucoup de t√¢ches fastidieuses aujourd‚Äôhui. Reste √† continuer √† d√©finir des SLOs, puis cr√©er de nouveaux sc√©narios de load-testing repr√©sentatifs ! ;-)&lt;/p&gt;

&lt;h4 id=&quot;et-les-co√ªts-dh√©bergement-alors-&quot;&gt;Et les co√ªts d‚Äôh√©bergement, alors ?&lt;/h4&gt;

&lt;p&gt;Nous avons aussi entendu parler plusieurs fois de co√ªts d‚Äôh√©bergement tout au long de cette KubeCon : comme l‚Äôillustrent les travaux de la FinOps Foundation, nous sommes de plus en plus nombreux √† r√©aliser que si nous ne pensons pas √† l‚Äôimpact financier de nos infrastructures √©lastiques, o√π n‚Äôimporte quel membre des √©quipes peut d√©ployer des applications, la facture augmente vite et fort.&lt;/p&gt;

&lt;p&gt;Le talk ‚ÄúWhy Kubernetes can‚Äôt get around FinOps - Cost Management best practices‚Äù (&lt;a href=&quot;https://www.youtube.com/watch?v=zqJ9CqaQpYw&quot;&gt;vid√©o&lt;/a&gt;) √©tait une bonne introduction aux principes de gestion de co√ªts sur Kubernetes. Rien de nouveau pour nous, sur la th√©orie‚Ä¶ m√™me s‚Äôil nous reste encore beaucoup de progr√®s √† r√©aliser pour mieux ma√Ætriser nos frais d‚Äôh√©bergement !&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Sur ces sujets de scalabilit√©, les conf√©rences auxquelles nous avons assist√© confirment que bon nombre des choix que nous avons fait sont les bons, et que les probl√©matiques qui nous font encore souffrir sont partag√©es par d‚Äôautres membres de la communaut√©.&lt;/p&gt;

&lt;p&gt;Nous allons prochainement tenter de mettre en place VPA sur un de nos composants majeur, VictoriaMetrics, qui consomme beaucoup de ressources quelques heures par jour et pour lequel un scaling horizontal n‚Äôest pas adapt√©.&lt;/p&gt;

&lt;p&gt;Nous n‚Äôen avons pas (ou peu) entendu parler pendant cette KubeCon, mais nous √©tudions en ce moment la solution Karpenter pour remplacer cluster-autoscaler, tr√®s utilis√© dans la communaut√©, mais qui ne sait pas r√©ellement tirer profit de sp√©cificit√©s li√©es √† AWS.&lt;/p&gt;

&lt;p&gt;Enfin, sur les co√ªts‚Ä¶ OK, il n‚Äôy a pas que chez nous que c‚Äôest compliqu√©. Et c‚Äôest clairement un sujet, dans Kubernetes comme au niveau d‚ÄôAWS, sur lequel nous avons encore du boulot devant nous pour un an ou deux. &lt;a href=&quot;https://www.bedrockstreaming.com/career&quot;&gt;Nous avons m√™me un poste FinOps ouvert ;-)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/2022-06-13-kubecon-2022/end-part1.jpg&quot; alt=&quot;&amp;quot;KubeCon 2022 day1&amp;quot;&quot; /&gt;&lt;/p&gt;</content><author><name>Bedrock</name></author><category term="kubecon" /><category term="kubernetes" /><category term="cloud" /><category term="k8s" /><category term="conference" /><summary type="html"></summary></entry></feed>